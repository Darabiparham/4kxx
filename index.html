<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>DACO Pro</title>
<meta name="theme-color" content="#ff6e41">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiREFDTyBTdG9yeW1ha2VyIFBybyIsInNob3J0X25hbWUiOiJEQUNPIFBybyIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmM2UzIiwidGhlbWVfY29sb3IiOiIjZmY2ZTQxIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vcGZzdC5jZjIucG9lY2RuLm5ldC9iYXNlL2ltYWdlLzkzNjRhY2Y1YmUyMWIwZWVlNjE0NzAzMDYxOGJmMjY4M2JjYjZjOWQ1ZjhjMGIzMzNkZjI2NzBmZjU5YTg5Mj9aQVBfS0VZPTZkZWRlOGQ3YjNlZGJlMDU4ZDhhMGNjZDE3MWE5MWYxJnRva2VuPWExZDM0OWE4LWY5YWEtNGE0OS1iN2UwLTcxMzk3YTE5Mzg5Mw%3D%3D","sizes":"512x512","type":"image/png"},{"src":"https://pfst.cf2.poecdn.net/base/image/9364acf5be21b0eee6147030618bf2683bcb6c9d5f8c0b333df2670ff59a892f?ZAP_KEY=6dede8d7b3edbe058d8a0ccd171a91f1&token=a1d349a8-f9aa-4a49-b7e0-71397a193893","sizes":"192x192","type":"image/png"}]}">
<link rel="icon" type="image/png" href="https://pfst.cf2.poecdn.net/base/image/9364acf5be21b0eee6147030618bf2683bcb6c9d5f8c0b333df2670ff59a892f?w=32&h=32">
<link rel="apple-touch-icon" href="https://pfst.cf2.poecdn.net/base/image/9364acf5be21b0eee6147030618bf2683bcb6c9d5f8c0b333df2670ff59a892f?w=180&h=180">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400;1,700&family=Lalezar:wght@400&family=Markazi+Text:wght@400;500;600;700&family=Noto+Naskh+Arabic:wght@400;500;600;700&family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<style>
:root{--green-main:#1b3b14;--green-dark:#152e11;--cream-light:#fff3e3;--orange-main:#ff6e41;--orange-dark:#c55633;--text-color-light:#1b3b14;--bg-color-light:#fff3e3;--panel-bg-light:rgba(255,243,227,0.7);--border-color-light:rgba(21,46,17,0.2);--shadow-color:rgba(0,0,0,0.1);--icon-color-light:#1b3b14;--placeholder-color-light:rgba(255,110,65,1);--glass-blur:12px;--safe-area-top:env(safe-area-inset-top,0px);--safe-area-bottom:env(safe-area-inset-bottom,0px);--safe-area-left:env(safe-area-inset-left,0px);--safe-area-right:env(safe-area-inset-right,0px);--header-base-height:55px;--footer-base-height:80px;--header-height:var(--header-base-height);--footer-height:var(--footer-base-height);--transition-fast:0.2s cubic-bezier(0.4,0,0.2,1);--transition-smooth:0.5s cubic-bezier(0.4,0,0.2,1);--transition-slow:0.6s cubic-bezier(0.4,0,0.2,1)}
.night-mode{--green-main:#fff3e3;--text-color-light:#fff3e3;--bg-color-light:#152e11;--panel-bg-light:rgba(21,46,17,0.7);--border-color-light:rgba(255,243,227,0.2);--shadow-color:rgba(0,0,0,0.3);--icon-color-light:#fff3e3;--placeholder-color-light:rgba(255,255,255,0.8)}
.night-mode #appTitle,.night-mode .subtitle{color:var(--cream-light)}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{height:100%;font-size:16px;-webkit-text-size-adjust:100%;text-size-adjust:100%}
body{height:100vh;height:100dvh;margin:0;padding:0;overflow:hidden;font-family:'Vazirmatn',system-ui,-apple-system,sans-serif;background:var(--bg-color-light);color:var(--text-color-light);transition:background var(--transition-smooth),color var(--transition-smooth);-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;display:flex;flex-direction:column;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
@media screen and (orientation:landscape){.orientation-lock-overlay{display:flex!important}.main-app-container{display:none!important}}
.orientation-lock-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--orange-main);display:none;align-items:center;justify-content:center;z-index:10001;color:white;text-align:center;font-family:'Vazirmatn',sans-serif}
.orientation-lock-message{padding:30px;max-width:90%}
.orientation-lock-message svg{width:80px;height:80px;margin-bottom:20px;animation:rotatePhone 2s infinite ease-in-out}
.orientation-lock-message h2{font-size:1.5rem;margin:20px 0 10px 0;font-weight:700}
.orientation-lock-message p{font-size:1.1rem;margin:0;opacity:0.9;line-height:1.4}
@keyframes rotatePhone{0%{transform:rotate(90deg)}50%{transform:rotate(0deg)}100%{transform:rotate(90deg)}}
.main-app-container{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;min-height:0}
.login-modal {
    position: fixed;
    inset: 0;
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}
.login-modal.active {
    opacity: 1;
    visibility: visible;
}
.login-modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    cursor: pointer;
}
.login-modal-content {
    position: relative;
    background: var(--cream-light);
    padding: 40px 32px;
    border-radius: 24px;
    width: 100%;
    max-width: 450px;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid rgba(0,0,0,0.1);
    box-shadow: 0 24px 80px rgba(0,0,0,0.4), 0 8px 24px rgba(0,0,0,0.2);
    transform: scale(0.9) translateY(-30px);
    opacity: 0;
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.25s ease;
    z-index: 1;
}
.night-mode .login-modal-content {
    background: var(--green-dark);
    border-color: rgba(255,255,255,0.1);
}
.login-modal.active .login-modal-content {
    transform: scale(1) translateY(0);
    opacity: 1;
}
.login-modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: transparent;
    border: none;
    color: var(--text-color-light);
    opacity: 0.6;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}
.login-modal-close svg { stroke-width: 2.5; }
.login-modal-close:hover {
    background: rgba(128,128,128,0.1);
    opacity: 1;
    transform: rotate(90deg);
}
body[data-lang="fa"] .login-modal-close, body[data-lang="ar"] .login-modal-close {
    right: auto;
    left: 15px;
}
.login-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    background: rgba(128,128,128,0.08);
    padding: 6px;
    border-radius: 14px;
}
.login-tab {
    flex: 1;
    padding: 12px;
    border: none;
    background: transparent;
    color: var(--text-color-light);
    opacity: 0.7;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 10px;
    cursor: pointer;
    transition: all var(--transition-smooth);
}
.login-tab.active {
    background: var(--orange-main);
    color: white;
    opacity: 1;
    box-shadow: 0 5px 20px -5px rgba(255,110,65,0.5);
}
.login-form-container { display: none; text-align: center; }
.login-form-container.active { display: block; animation: fadeIn 0.5s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.login-form-container h3 {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--text-color-light);
    margin-bottom: 8px;
}
.login-form-container p {
    font-size: 1rem;
    opacity: 0.7;
    margin-bottom: 35px;
}
.input-group { position: relative; margin-bottom: 25px; }
.input-group input {
    width: 100%;
    padding: 16px;
    border: 1px solid var(--border-color-light);
    border-radius: 12px;
    background: rgba(128,128,128,0.1);
    color: var(--text-color-light);
    font-size: 1rem;
    outline: none;
    transition: all var(--transition-fast);
}
.input-group input:focus {
    border-color: var(--orange-main);
    box-shadow: 0 0 0 4px rgba(255,110,65,0.15);
}
.input-group label {
    position: absolute;
    top: 16px;
    right: 16px;
    color: var(--text-color-light);
    opacity: 0.5;
    pointer-events: none;
    transition: all var(--transition-fast);
}
body[data-lang="en"] .input-group label { right: auto; left: 16px; }
.input-group input:focus + label, .input-group input:not(:placeholder-shown) + label {
    top: -11px;
    right: 12px;
    font-size: 0.8rem;
    background: var(--panel-bg-light);
    padding: 0 8px;
    opacity: 1;
    color: var(--orange-main);
}
body[data-lang="en"] .input-group input:focus + label, body[data-lang="en"] .input-group input:not(:placeholder-shown) + label {
    right: auto;
    left: 12px;
}
.forgot-password {
    display: block;
    text-align: right;
    font-size: 0.85rem;
    color: var(--orange-main);
    text-decoration: none;
    margin-top: -15px;
    margin-bottom: 25px;
    opacity: 0.9;
    transition: opacity var(--transition-fast);
}
body[data-lang="en"] .forgot-password { text-align: left; }
.forgot-password:hover { opacity: 1; text-decoration: underline; }
.submit-btn {
    width: 100%;
    padding: 18px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--orange-main), var(--orange-dark));
    color: white;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-fast);
    box-shadow: 0 8px 25px -8px rgba(255,110,65,0.6);
}
.submit-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 30px -8px rgba(255,110,65,0.8);
}
.login-divider {
    display: flex;
    align-items: center;
    margin: 20px 0;
    color: var(--text-color-light);
    opacity: 0.6;
}
.login-divider::before,
.login-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border-color-light);
}
.login-divider span {
    padding: 0 15px;
    font-size: 0.85rem;
    font-weight: 600;
}
.google-login-btn {
    width: 100%;
    padding: 14px 20px;
    border: 1.5px solid var(--border-color-light);
    border-radius: 12px;
    background: rgba(255,255,255,0.95);
    color: var(--text-color-light);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.google-login-btn:hover {
    background: white;
    border-color: #4285F4;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(66,133,244,0.2);
}
.google-login-btn svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}
.night-mode .google-login-btn {
    background: rgba(255,255,255,0.12);
    border-color: rgba(255,255,255,0.2);
}
.night-mode .google-login-btn:hover {
    background: rgba(255,255,255,0.18);
    border-color: #4285F4;
}
.night-mode #colorPickerBtn.active {
    color: #1b3b14;
}


/* --- END: Professional & Multilingual Login/Sign Up Modal --- */

.pwa-install-prompt{position:fixed;top:calc(var(--header-height) + var(--safe-area-top) +10px);left:20px;right:20px;background:var(--panel-bg-light);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));border:1px solid var(--border-color-light);border-radius:20px;padding:20px;z-index:9999;display:none;box-shadow:0 15px 40px rgba(0,0,0,0.2);animation:slideDown 0.5s ease-out forwards;transform:translateY(-20px);opacity:0}

.pwa-install-prompt.active{display:block;opacity:1;transform:translateY(0)}
.pwa-install-content{display:flex;align-items:center;gap:16px}
.pwa-install-icon{width:55px;height:55px;background:linear-gradient(135deg,var(--orange-main) 0%,var(--orange-dark) 100%);border-radius:16px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 8px 20px rgba(255,110,65,0.3);position:relative;overflow:hidden}
.pwa-install-icon::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,rgba(255,255,255,0.2),transparent);animation:iconShine 3s ease-in-out infinite}
.pwa-install-icon svg{width:30px;height:30px;stroke:white;fill:none;stroke-width:2.5;position:relative;z-index:2}
.pwa-install-text{flex:1}
.pwa-install-title{font-size:1.1rem;font-weight:700;color:var(--text-color-light);margin-bottom:6px;line-height:1.2}
.pwa-install-desc{font-size:0.9rem;color:var(--text-color-light);opacity:0.8;line-height:1.4}
.pwa-install-close{background:rgba(128,128,128,0.1);border:1px solid var(--border-color-light);color:var(--text-color-light);width:40px;height:40px;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.4rem;transition:all var(--transition-fast);flex-shrink:0;font-weight:300}
.pwa-install-close:hover{background:rgba(255,110,65,0.2);border-color:var(--orange-main);transform:scale(1.05)}
@keyframes slideDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
@keyframes iconShine{0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}50%{transform:translateX(100%) translateY(100%) rotate(45deg)}100%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}}

.daco-loading-screen{position:fixed;inset:0;width:100vw;height:100dvh;background:var(--bg-color-light);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:99999;transition:opacity 0.8s ease,visibility 0.8s ease,transform 0.8s ease}
.daco-loading-screen.hidden{opacity:0;visibility:hidden;transform:scale(0.95);pointer-events:none}
.daco-logo-container{position:relative;width:120px;height:120px;margin-bottom:30px;animation:dacoLogoFloat 3s ease-in-out infinite}
.daco-logo{width:100%;height:100%;border-radius:20px;background:rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;box-shadow:0 15px 50px rgba(0,0,0,0.3);position:relative;overflow:hidden;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.daco-logo img{width:85%;height:85%;object-fit:contain;border-radius:15px}
.daco-logo::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,rgba(255,255,255,0.3),transparent);animation:logoShine 3s ease-in-out infinite}
.loading-text{font-family:'Vazirmatn',sans-serif;font-size:1.3rem;font-weight:700;color:var(--text-color-light);opacity:0.8;margin-top:20px;text-shadow:0 2px 10px rgba(0,0,0,0.3);animation:textPulse 2s ease-in-out infinite}
.loading-subtitle{font-family:'Vazirmatn',sans-serif;font-size:0.9rem;color:var(--text-color-light);opacity:0.8;margin-top:8px;text-shadow:0 1px 5px rgba(0,0,0,0.3)}
@keyframes dacoLogoFloat{0%,100%{transform:translateY(0px) scale(1)}50%{transform:translateY(-20px) scale(1.05)}}
@keyframes logoShine{0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}50%{transform:translateX(100%) translateY(100%) rotate(45deg)}100%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}}
@keyframes textPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.8;transform:scale(1.02)}}
.header{position:fixed;top:0;left:10px;width:calc(100% - 20px);margin-top:10px;height:calc(var(--header-height) + var(--safe-area-top));display:flex;align-items:center;justify-content:center;background:var(--panel-bg-light);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));border:1px solid var(--border-color-light);border-radius:40px;z-index:2000;transition:all var(--transition-smooth);padding:calc(8px + var(--safe-area-top)) 16px 8px 16px}

.header-top{display:flex;justify-content:space-between;align-items:center;gap:8px;width:100%;height:100%}
body[data-lang="fa"] .header-top,
body[data-lang="ar"] .header-top {
    flex-direction: row-reverse;
}
.header-controls{display:flex;align-items:center;gap:8px}
.header-controls-left,.header-controls-right{display:flex;align-items:center;gap:8px}
.app-title-section{text-align:center;flex-grow:1}
#appTitle{font-size:1.1rem;font-weight:800;margin:0;color:var(--green-main);line-height:1.2}
.subtitle{margin:0;color:var(--green-main);font-size:0.6rem;opacity:0.8;line-height:1}
.header-btn,.delete-image-btn{background:rgba(255,255,255,0.0);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border: none; solid var(--border-color-light);cursor:pointer;padding:8px;border-radius:12px;transition:all var(--transition-smooth);color:var(--text-color-light);display:flex;align-items:center;justify-content:center;position:relative;width:40px;height:40px;outline:none}
.delete-image-btn{background:rgba(255,68,68,0.15);border:1px solid rgba(255,68,68,0.3);color:#ff6e41;display:none}
.header-btn:hover,.header-btn:focus,.delete-image-btn:hover,.delete-image-btn:focus{background:rgba(255,110,65,0.2);border-color:var(--orange-main);transform:scale(1.05)}
.delete-image-btn:hover,.delete-image-btn:focus{background:rgba(255,68,68,0.25);border-color:#ff4444}
.header-btn svg,.delete-image-btn svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2}
.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;background:transparent;min-height:0;padding-top:0;padding-bottom:0;}

.canvas-container{flex:1;position:relative;overflow:hidden;min-height:0;touch-action:none;display:flex;align-items:center;justify-content:center;background:var(--bg-color-light);
padding-top: calc(var(--header-height) + var(--safe-area-top) + 10px);
padding-bottom: calc(var(--footer-height) + var(--safe-area-bottom) + 10px);
padding-left: 10px;
padding-right: 10px;
}

.canvas-wrapper{position:relative;border-radius:18px;overflow:hidden;touch-action:manipulation;cursor:grab;transition:none;transform-origin:center center;will-change:transform;backface-visibility:hidden;transform:translateZ(0);display:flex;align-items:center;justify-content:center;
max-width: 100%;
max-height: 100%;
box-shadow:0 15px 40px var(--shadow-color);border:0px solid var(--border-color-light);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px)}

.canvas-wrapper:active{cursor:grabbing}
.canvas-wrapper.smooth-transition{transition:transform var(--transition-slow)}
.guide-lines{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:15;overflow:hidden;border-radius:18px}
.guide-line{position:absolute;background:var(--orange-main);opacity:0;transition:opacity var(--transition-fast)}
.guide-line.vertical{width:2px;height:100%;left:50%;transform:translateX(-50%);top:0}
.guide-line.horizontal{height:2px;width:100%;top:50%;transform:translateY(-50%);left:0}
.guide-line.active{opacity:0.8}
#photo-placeholder{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:100px;color:var(--placeholder-color-light);background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);cursor:pointer;z-index:10;transition:all var(--transition-smooth);border-radius:18px;font-weight:300;text-shadow:0 2px 10px rgba(255,110,65,0.3);user-select:none;-webkit-user-select:none}
#photo-placeholder:active{transform:scale(0.95);background:rgba(255,110,65,0.2)}
.night-mode #photo-placeholder{color:#1b3b14;background:rgba(0,0,0,0.1);text-shadow:0 2px 10px rgba(255,255,255,0.2)}
.text-frame{position:absolute;border:3px dashed var(--orange-main);border-radius:15px;pointer-events:none;z-index:5;opacity:0;transition:all 0.4s ease-out;box-shadow:0 0 20px rgba(255,110,65,0.4);animation:selectedTextPulse 2s ease-in-out}
.text-frame.active{opacity:1;border-color:var(--green-main)}
@keyframes selectedTextPulse{0%{opacity:0;transform:scale(0.95);border-color:var(--orange-main);box-shadow:0 0 0 rgba(255,110,65,0)}50%{opacity:1;transform:scale(1.02);border-color:var(--green-main);box-shadow:0 0 25px rgba(27,59,20,0.6)}100%{opacity:0.8;transform:scale(1);border-color:var(--green-main);box-shadow:0 0 15px rgba(27,59,20,0.3)}}
canvas{display:block;width:100%;height:100%;touch-action:manipulation;object-fit:contain;border-radius:18px;background:transparent}
.footer-controls{background:var(--panel-bg-light);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));transition:all var(--transition-smooth);position:fixed;bottom:0;left:10px;width:calc(100% - 20px);margin-bottom:10px;z-index:1900;box-shadow:0 -6px 30px var(--shadow-color);display:flex;align-items:flex-start;border:1px solid var(--border-color-light);border-radius:40px;min-height:calc(var(--footer-height) + var(--safe-area-bottom));padding:8px 16px calc(8px + var(--safe-area-bottom)) 16px}

.control-icons{display:flex;justify-content:space-around;align-items:center;gap:16px;width:100%}
.control-icon{display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:10px 14px;border-radius:16px;transition:all var(--transition-smooth);background:rgba(255,255,255,0.0);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border: none; solid var(--border-color-light);color:var(--text-color-light);min-width:65px;position:relative;outline:none}
.control-icon:hover,.control-icon.active,.control-icon:focus{background:var(--orange-main);color:white;transform:translateY(-3px);box-shadow:0 8px 30px rgba(255,110,65,0.01);border-color:var(--orange-dark)}
.control-icon svg{width:22px;height:22px;margin-bottom:4px;stroke-width:2}
.control-icon span{font-size:0.7rem;font-weight:600}
.quick-action-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.01);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);display:none;align-items:center;justify-content:center;z-index:3000;opacity:0;transition:all var(--transition-smooth);padding:20px}
.quick-action-modal.active{display:flex;opacity:1}
.quick-action-content{background:var(--panel-bg-light);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));border-radius:20px;padding:30px;max-width:320px;width:100%;text-align:center;border:1px solid var(--border-color-light);transform:scale(0.9);transition:transform var(--transition-smooth);box-shadow:0 25px 50px rgba(0,0,0,0.2)}
.quick-action-modal.active .quick-action-content{transform:scale(1)}
.quick-action-title{font-size:1.2rem;font-weight:700;color:var(--text-color-light);margin-bottom:20px}
.quick-action-buttons{display:flex;flex-direction:column;gap:12px}
.quick-action-btn{display:flex;align-items:center;gap:12px;padding:16px 20px;background:rgba(255,255,255,0.01);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);border-radius:14px;cursor:pointer;transition:all var(--transition-smooth);color:var(--text-color-light);text-decoration:none;outline:none}
.quick-action-btn:hover,.quick-action-btn:focus-visible{background:var(--orange-main);color:white;transform:translateY(-2px);box-shadow:0 8px 25px rgba(255,110,65,0.4)}
.quick-action-btn svg{width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:2}
.quick-action-btn-text{flex:1;text-align:left}
.quick-action-btn-title{font-weight:600;font-size:1rem;margin-bottom:2px}
.quick-action-btn-desc{font-size:0.8rem;opacity:0.7}
.accordion-panel{position:fixed;bottom:calc(var(--footer-height) + var(--safe-area-bottom) + 20px);left:10px;right:10px;background:var(--panel-bg-light);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));box-shadow:0 -8px 40px var(--shadow-color);transform:translateY(100%);transition:transform var(--transition-smooth),opacity var(--transition-smooth),visibility var(--transition-smooth);z-index:1800;max-height:calc(50vh - var(--footer-height) - 20px);overflow-y:auto;border-radius:20px;border:1px solid var(--border-color-light);opacity:0;visibility:hidden;will-change:transform,opacity}
.accordion-panel.active{transform:translateY(0);opacity:1;visibility:visible}
.panel-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border-color-light);font-weight:700;font-size:1rem;position:sticky;top:0;background:var(--panel-bg-light);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));z-index:10;border-radius:20px 20px 0 0}
.layer-panel .panel-header{flex-shrink:0;border-radius:0;gap:8px;}
.collapse-btn{width:50px;height:30px;border-radius:10px;background:rgba(255,255,255,0.1);border:1px solid var(--border-color-light);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition-smooth);color:var(--text-color-light);flex-shrink:0;}
.collapse-btn:hover{background:rgba(255,110,65,0.2);border-color:var(--orange-main);transform:scale(1.05);}
.collapse-btn svg{width:30px;height:30px;transition:transform 0.3s ease;}
.layer-panel.collapsed .collapse-btn svg{transform:rotate(180deg);}
.close-panel{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);font-size:1.5rem;cursor:pointer;color:var(--text-color-light);padding:6px 10px;border-radius:10px;transition:all var(--transition-smooth);width:36px;height:36px;display:flex;align-items:center;justify-content:center;outline:none}
.close-panel:hover,.close-panel:focus{background:rgba(255,110,65,0.2);border-color:var(--orange-main)}
.panel-content{padding:18px 20px;display:flex;flex-direction:column;gap:7px}

/* Enhanced Color Tools Container */
.color-tools-container {
    display: flex;
    flex-direction: row;
    gap: 12px;
    margin-bottom: 1px;
}
.color-tool-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 16px;
    border: 1px solid var(--border-color-light);
    transition: all var(--transition-smooth);
    cursor: pointer;
}
.color-tool-card:hover {
    background: rgba(255, 110, 65, 0.1);
    border-color: var(--orange-main);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 110, 65, 0.2);
}
.color-tool-card .color-picker-info {
    text-align: left;
    flex: 1;
}
body[data-lang="fa"] .color-tool-card .color-picker-info,
body[data-lang="ar"] .color-tool-card .color-picker-info {
    text-align: right;
}
.color-tool-btn {
    width: 55px;
    height: 55px;
    border-radius: 16px;
    cursor: pointer;
    background: rgba(255,255,255,0.1);
    border: 1px solid var(--border-color-light);
    color: var(--text-color-light);
    transition: all var(--transition-smooth);
    display: flex;
    align-items: center;
    justify-content: center;
    outline: none;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
}
.color-tool-card:hover .color-tool-btn,
.color-tool-card:focus-within .color-tool-btn,
.color-tool-btn:hover {
    background: var(--orange-main);
    color: white;
    transform: scale(1.05);
    border-color: var(--orange-dark);
}
.color-tool-btn svg {
    width: 32px;
    height: 32px;
    transition: all var(--transition-smooth);
    position: relative;
    z-index: 2;
}
#colorPickerBtn.active {
    background: var(--green-main);
    border-color: var(--green-dark);
    color: white;
    animation: colorPickerPulse 2s ease-in-out infinite;
}

/* Professional Color Wheel Modal */
.color-wheel-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    animation: modalFadeIn 0.4s ease-out forwards;
}
.color-wheel-container {
    background: var(--panel-bg-light);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    border-radius: 20px;
    padding: 20px;
    max-width: 380px;
    width: 95%;
    text-align: center;
    border: 1px solid var(--border-color-light);
    box-shadow: 0 25px 50px rgba(0,0,0,0.4);
    transform: scale(0.9);
    animation: modalZoomIn 0.4s ease-out 0.1s forwards;
    max-height: 90vh;
    overflow-y: auto;
}
.color-wheel-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-color-light);
    margin-bottom: 14px;
    font-family: 'Vazirmatn', sans-serif;
}
.color-wheel-canvas-container {
    position: relative;
    display: inline-block;
    margin-bottom: 14px;
    border-radius: 50%;
    overflow: visible;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}
.color-wheel-canvas {
    display: block;
    cursor: crosshair;
    border-radius: 50%;
    border: 2px solid var(--border-color-light);
    transition: all var(--transition-fast);
    filter: contrast(1.1) saturate(1.05);
}
.color-wheel-indicator {
    position: absolute;
    width: 18px;
    height: 18px;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    pointer-events: none;
    transform: translate(-50%, -50%);
    z-index: 10;
    opacity: 0;
    transition: opacity 0.2s ease;
}
.color-wheel-indicator.active {
    opacity: 1;
}
.color-controls-section {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 14px;
    padding: 14px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    border: 1px solid var(--border-color-light);
}
.color-preview-compact {
    width: 55px;
    height: 32px;
    border-radius: 10px;
    border: 2px solid var(--border-color-light);
    margin: 0 auto 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.color-input-group {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}
.color-input-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-color-light);
    min-width: 30px;
    text-align: left;
}
.color-input-field {
    flex: 1;
    background: rgba(255,255,255,0.1);
    border: 1px solid var(--border-color-light);
    border-radius: 8px;
    padding: 5px 8px;
    color: var(--text-color-light);
    font-size: 0.8rem;
    font-family: 'Vazirmatn', monospace;
    outline: none;
    transition: all var(--transition-fast);
}
.color-input-field:focus {
    border-color: var(--orange-main);
    background: rgba(255,255,255,0.15);
}
.color-slider-group {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
}
.color-slider-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-color-light);
    min-width: 24px;
    text-align: left;
}
.color-slider {
    flex: 1;
    -webkit-appearance: none;
    background: rgba(255,255,255,0.15);
    height: 5px;
    border-radius: 3px;
    outline: none;
    border: none;
}
.color-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--orange-main);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
}
.color-slider-value {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--orange-main);
    min-width: 28px;
    text-align: center;
    background: rgba(255,110,65,0.1);
    padding: 2px 4px;
    border-radius: 4px;
}
.color-wheel-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 14px;
}
.color-wheel-btn {
    padding: 10px 18px;
    border-radius: 12px;
    cursor: pointer;
    font-family: 'Vazirmatn', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    transition: all var(--transition-smooth);
    border: none;
    outline: none;
    position: relative;
    overflow: hidden;
    flex: 1;
}
.color-wheel-btn.cancel {
    background: rgba(128,128,128,0.2);
    color: var(--text-color-light);
    border: 1px solid rgba(128,128,128,0.4);
}
.color-wheel-btn.select {
    background: linear-gradient(135deg, var(--orange-main) 0%, var(--orange-dark) 100%);
    color: white;
    box-shadow: 0 5px 18px rgba(255,110,65,0.4);
}
.color-wheel-btn:hover {
    transform: translateY(-2px);
}
.color-wheel-btn.cancel:hover {
    background: rgba(128,128,128,0.3);
}
.color-wheel-btn.select:hover {
    box-shadow: 0 7px 22px rgba(255,110,65,0.6);
}

@keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes modalZoomIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.color-picker-info{flex:1;display:flex;flex-direction:column;gap:6px}
.color-picker-title{font-size:0.6rem;font-weight:600;color:var(--text-color-light);line-height:1.2}
.color-picker-desc{font-size:0.6rem;color:var(--text-color-light);opacity:0.7;line-height:1.3}
.color-picker-preview{display:none}
#colorPickerBtn{border:3px solid #000000}
#colorWheelBtn{border:3px solid #000000}
@keyframes colorPickerPulse{0%,100%{box-shadow:0 0 0 3px var(--green-main),0 8px 25px rgba(27,59,20,0.5)}50%{box-shadow:0 0 0 6px var(--green-main),0 12px 35px rgba(27,59,20,0.7)}}
.color-picker-cursor{position:absolute;width:32px;height:32px;pointer-events:none;z-index:20;opacity:0;transition:opacity var(--transition-fast);will-change:transform;filter:drop-shadow(0 4px 12px rgba(0,0,0,0.4))}
.color-picker-cursor.active{opacity:1}
.color-picker-cursor svg{width:100%;height:100%;fill:white;stroke:#333;stroke-width:1}
.canvas-wrapper.color-picking{cursor:none}
.color-picker-magnifier{position:absolute;width:120px;height:120px;border-radius:50%;border:4px solid white;box-shadow:0 8px 24px rgba(0,0,0,0.5),0 0 0 1px rgba(0,0,0,0.2);pointer-events:none;z-index:25;opacity:0;transition:opacity 0.2s ease;overflow:hidden;background:#fff;backdrop-filter:blur(0)}
.color-picker-magnifier.active{opacity:1}
.color-picker-magnifier canvas{width:100%;height:100%;image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges}
.color-picker-magnifier::after{content:'';position:absolute;top:50%;left:50%;width:20px;height:20px;transform:translate(-50%,-50%);border:2px solid rgba(0,0,0,0.6);border-radius:4px;box-shadow:0 0 0 1px rgba(255,255,255,0.8);pointer-events:none}
.color-picker-color-info{position:absolute;bottom:-45px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:white;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:600;white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,0.3);pointer-events:none}
.font-panels-container{display:flex;flex-direction:column;gap:12px;max-height:200px;overflow-y:auto;padding-right:5px;padding-top:5px;scrollbar-width:thin;scrollbar-color:var(--orange-main) transparent;contain:layout style paint}
.font-panels-container::-webkit-scrollbar{width:6px}
.font-panels-container::-webkit-scrollbar-track{background:rgba(0,0,0,0.1);border-radius:3px}
.font-panels-container::-webkit-scrollbar-thumb{background-color:var(--orange-main);border-radius:3px}
.font-panel{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.08);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:14px;border:1px solid var(--border-color-light);transition:all 0.1s ease-out;cursor:pointer;will-change:transform,background-color}
.font-panel:hover{background:rgba(255,110,65,0.15);border-color:var(--orange-main);transform:translateY(-1px)}
.font-panel.selected{border-color:var(--green-main);background:rgba(27,59,20,0.15);box-shadow:0 0 20px rgba(27,59,20,0.2);border-style:dashed;transform:translateY(-2px)}
.font-panel .font-text-input{flex:1;background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);color:var(--text-color-light);font-size:16px;padding:14px;resize:none;overflow-y:auto;min-height:35px;max-height:60px;line-height:1.4;font-family:inherit;word-wrap:break-word;transition:all 0.1s ease-out;border-radius:10px;text-align:center;display:flex;align-items:center;justify-content:center;outline:none}
.font-panel .font-text-input::placeholder{color:rgba(255,255,255,0.7);text-align:center;font-size:14px}
.font-panel .font-text-input:focus{border-color:var(--orange-main);background:rgba(255,255,255,0.1);text-align:left}
.font-panel .remove-font{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);color:#ff6e41;border:1px solid rgba(0,0,0,0.15);width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:20px;line-height:1;display:flex;align-items:center;justify-content:center;font-weight:bold;transition:all var(--transition-smooth);outline:none}
.font-panel .remove-font:hover,.font-panel .remove-font:focus{background:rgba(255,68,68,0.25);border-color:#ff4444;transform:scale(1.1)}
.add-font-panel-btn{background:rgba(255,110,65,0.2);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);color:var(--orange-main);border:1px solid var(--orange-main);padding:14px 20px;border-radius:14px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;gap:10px;transition:all var(--transition-smooth);font-weight:600;outline:none}
.add-font-panel-btn:hover,.add-font-panel-btn:focus{background:var(--orange-main);color:white;transform:translateY(-2px)}
.add-font-panel-btn:disabled{background:rgba(128,128,128,0.15);color:rgba(128,128,128,0.6);border-color:rgba(128,128,128,0.3);cursor:not-allowed;transform:none}
.color-grid{display:flex;overflow-x:auto;gap:12px;margin:4px 0;padding:12px;scrollbar-width:thin;scrollbar-color:var(--orange-main) transparent;background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:12px;border:1px solid var(--border-color-light)}
.color-grid::-webkit-scrollbar{height:6px}
.color-grid::-webkit-scrollbar-track{background:rgba(0,0,0,0.1);border-radius:3px}
.color-grid::-webkit-scrollbar-thumb{background-color:var(--orange-main);border-radius:3px}
.color-grid-swatch{width:42px;height:42px;border-radius:50%;border:2px solid rgba(255,255,255,0.2);cursor:pointer;transition:all 0.3s cubic-bezier(0.25,0.46,0.45,0.94);flex-shrink:0;position:relative;background-clip:padding-box;outline:none;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px)}
.color-grid-swatch:hover,.color-grid-swatch:focus{transform:scale(1.15);box-shadow:0 10px 30px rgba(0,0,0,0.3);border-color:rgba(255,255,255,0.5)}
.color-grid-swatch.active{transform:scale(1.2);box-shadow:0 0 0 4px var(--orange-main),0 10px 30px rgba(255,110,65,0.5);border-color:white}
.color-grid-swatch[data-color="#ffffff"]{border-color:#ddd}
.color-grid-swatch[data-color="#ffffff"]:hover,.color-grid-swatch[data-color="#ffffff"]:focus{border-color:#bbb}
.color-grid-swatch[data-color="#ffffff"].active{border-color:var(--orange-main)}
input[type="file"]{display:none}
textarea,input[type="number"],select,button{padding:12px 16px;border-radius:14px;border:1px solid var(--border-color-light);font-size:16px;transition:all var(--transition-smooth);outline:none;font-family:inherit;background:rgba(255,255,255,0.08);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);color:var(--text-color-light)}
textarea{resize:none;min-height:80px}
textarea:focus,input:focus,select:focus{border-color:var(--orange-main);box-shadow:0 0 0 4px rgba(255,110,65,0.15);background:rgba(255,255,255,0.12)}
.font-add-group{display:flex;align-items:center;gap:12px}
.add-font-btn{background:rgba(255,110,65,0.2);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);color:var(--orange-main);border:1px solid var(--orange-main);width:50px;height:50px;border-radius:14px;cursor:pointer;font-size:1.5rem;line-height:1;display:flex;align-items:center;justify-content:center;padding:0;transition:all var(--transition-smooth);outline:none}
.add-font-btn:hover,.add-font-btn:focus{background:var(--orange-main);color:white;transform:scale(1.05)}
#fontSelector {
    flex: 1;
}

.slider-group{display:flex;align-items:center;gap:14px;padding:10px 14px;background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:12px;border:1px solid var(--border-color-light)}
.slider-group label{min-width:80px;text-align:left;font-size:0.9rem;color:var(--text-color-light);font-weight:600;flex-shrink:0}
.slider-group input[type="range"]{flex-grow:1;-webkit-appearance:none;background:rgba(255,255,255,0.15);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);height:10px;border-radius:5px;border:1px solid var(--border-color-light);outline:none;margin:0 8px}
.slider-group input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;background:var(--orange-main);border-radius:50%;cursor:pointer;box-shadow:0 3px 10px rgba(0,0,0,0.2);transition:all var(--transition-smooth);border:2px solid white}
.slider-group input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.1);background:var(--orange-dark)}
.slider-value{font-weight:600;min-width:50px;text-align:center;font-size:0.85rem;color:var(--orange-main);background:rgba(255,110,65,0.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:4px 8px;border-radius:8px;border:1px solid rgba(255,110,65,0.3);flex-shrink:0;display:flex;align-items:center;justify-content:center}

/* Hamburger Menu */
.hamburger-menu-btn{background:rgba(255,255,255,0.0);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border: none; solid var(--border-color-light);cursor:pointer;padding:8px;border-radius:12px;transition:all var(--transition-smooth);color:var(--text-color-light);display:flex;align-items:center;justify-content:center;position:relative;width:40px;height:40px;outline:none}
.hamburger-menu-btn:hover,.hamburger-menu-btn:focus{background:rgba(255,110,65,0.2);border-color:var(--orange-main);transform:scale(1.05)}
.hamburger-menu-btn svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2}
.hamburger-panel{position:fixed;top:calc(var(--header-height) + var(--safe-area-top) + 10px);left:-300px;width:280px;max-width:85vw;height:calc(100vh - var(--header-height) - var(--safe-area-top) - 10px);background:var(--panel-bg-light);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));border-right:1px solid var(--border-color-light);z-index:2500;transition:left var(--transition-smooth);overflow-y:auto;box-shadow:4px 0 20px var(--shadow-color);padding:20px}
.hamburger-panel.active{left:0}
.hamburger-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:2400;opacity:0;visibility:hidden;transition:opacity var(--transition-smooth),visibility var(--transition-smooth)}
.hamburger-overlay.active{opacity:1;visibility:visible}
.hamburger-section{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid var(--border-color-light)}
.hamburger-section:last-child{border-bottom:none}
.hamburger-section-title{font-size:0.75rem;font-weight:700;color:var(--text-color-light);opacity:0.6;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px}
.hamburger-item{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);border-radius:12px;cursor:pointer;transition:all var(--transition-smooth);margin-bottom:8px}
.hamburger-item:hover{background:rgba(255,110,65,0.15);border-color:var(--orange-main);transform:translateX(4px)}
.hamburger-item svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2;flex-shrink:0}
.hamburger-item span{font-size:0.9rem;font-weight:600;flex:1}
.hamburger-toggle{display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(255,255,255,0.08);border:1px solid var(--border-color-light);border-radius:12px;margin-bottom:8px}
.hamburger-toggle-label{font-size:0.9rem;font-weight:600;display:flex;align-items:center;gap:8px}
.hamburger-toggle-label svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
.toggle-switch{position:relative;width:44px;height:24px;background:rgba(128,128,128,0.3);border-radius:12px;cursor:pointer;transition:all var(--transition-smooth);flex-shrink:0}
.toggle-switch::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:white;border-radius:50%;transition:all var(--transition-smooth);box-shadow:0 2px 4px rgba(0,0,0,0.2)}
.toggle-switch.active{background:var(--orange-main)}
.toggle-switch.active::after{left:22px}

.layer-panel{
position:fixed;

top: calc(var(--header-height) + var(--safe-area-top) + 10px);
right:-320px;
width:320px;
height: calc(100vh - var(--header-height) - var(--footer-height) - var(--safe-area-top) - var(--safe-area-bottom) - 20px);
height: calc(100dvh - var(--header-height) - var(--footer-height) - var(--safe-area-top) - var(--safe-area-bottom) - 20px);
background:var(--panel-bg-light);

backdrop-filter:blur(var(--glass-blur)); 
 -webkit-backdrop-filter:blur(var(--glass-blur)); 
box-shadow:-8px 0 40px var(--shadow-color);
transition: right var(--transition-smooth), width var(--transition-smooth);
z-index:2000;
border-left:1px solid var(--border-color-light);
display:flex;
flex-direction:column;
overflow:hidden;
}


.layer-panel.active{right:0;}
.layer-panel.collapsed{width:70px;}
.layer-panel.collapsed .panel-header span:not(.collapse-btn){display:none;}
.layer-panel.collapsed .layer-name,
.layer-panel.collapsed .layer-actions,
.layer-panel.collapsed .layer-info{display:none;}
.layer-panel.collapsed .layer-drag-handle{display: none;}
.layer-panel.collapsed .layer-item{
    justify-content:center;
    cursor:pointer;
    min-height: auto; /* ارتفاع خودکار بر اساس محتوا */
    padding: 5px 8px; /* فقط کمی فاصله عمودی بین آیکون‌ها */
    /* حذف کامل ظاهر کادر */
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
}

.layer-panel.collapsed .layer-preview {
    width: 40px;
    height: 40px;
    cursor: pointer;

    background: var(--panel-bg-light); 
    border-radius: 10px;
    box-shadow: 0 0 0 1.5px var(--border-color-light), 0 4px 10px var(--shadow-color);
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}
.layer-panel.collapsed .layer-item:hover .layer-preview {
    transform: scale(1.1);
    box-shadow: 0 0 0 2px var(--orange-main), 0 6px 16px rgba(255,110,65,0.4);
}



.layer-panel.collapsed .close-panel{display:none;}
.layer-panel.collapsed .panel-header{justify-content:center;padding:16px 10px;}

.layer-panel.logo-only {
    width: 50px;
    height: 50px;
    right: 0px;
    top: calc(var(--header-height) + var(--safe-area-top) + 10px + 10px); 
    border-radius: 12px 0 0 12px; 
    box-shadow: -4px 4px 15px var(--shadow-color);
    overflow: hidden; 
}


.layer-panel.logo-only .panel-header{display:none;}
.layer-panel.logo-only .panel-content{display:none;}
.layer-panel.logo-only::before{
    content:'';
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%); /* مرکز در جعبه 50x50 */
    width:35px;
    height:35px;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' stroke='%23ff6e41' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M13.01 2.92007L18.91 5.54007C20.61 6.29007 20.61 7.53007 18.91 8.28007L13.01 10.9001C12.34 11.2001 11.24 11.2001 10.57 10.9001L4.67 8.28007C2.97 7.53007 2.97 6.29007 4.67 5.54007L10.57 2.92007C11.24 2.62007 12.34 2.62007 13.01 2.92007Z'/%3E%3Cpath d='M3 11C3 11.84 3.63 12.81 4.4 13.15L11.19 16.17C11.71 16.4 12.3 16.4 12.81 16.17L19.6 13.15C20.37 12.81 21 11.84 21 11'/%3E%3Cpath d='M3 16C3 16.93 3.55 17.77 4.4 18.15L11.19 21.17C11.71 21.4 12.3 21.4 12.81 21.17L19.6 18.15C20.45 17.77 21 16.93 21 16'/%3E%3C/svg%3E");
    background-size:contain;
    background-repeat:no-repeat;
    background-position:center;
    cursor:pointer;
    opacity:0.9;
    transition:all 0.3s ease;
    pointer-events:all;
}
.layer-panel.logo-only:hover::before{
    opacity:1;
    transform:translate(-50%, -50%) scale(1.15);
}
.layer-panel.logo-only{pointer-events:all;}

/* RTL Support for logo-only mode */
body[data-lang="fa"] .layer-panel.logo-only,
body[data-lang="ar"] .layer-panel.logo-only{
    left: 0px; 
    right:auto;
    border-radius: 0 12px 12px 0;
}

/* RTL Support - Layer Panel on Left for Persian/Arabic (opposite to hamburger on right) */
body[data-lang="fa"] .layer-panel,
body[data-lang="ar"] .layer-panel{right:auto;left:-320px;border-left:none;border-right:1px solid var(--border-color-light);box-shadow:8px 0 40px var(--shadow-color);transition: left var(--transition-smooth), width var(--transition-smooth);}
;transition:left 0.4s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s ease;}
body[data-lang="fa"] .layer-panel.active,
body[data-lang="ar"] .layer-panel.active{left:0;right:auto;}
body[data-lang="fa"] .layer-panel .collapse-btn svg,
body[data-lang="ar"] .layer-panel .collapse-btn svg{transform:scaleX(-1);}
.layer-panel .panel-header .close-panel {
    display: none;
}
.layer-list{display:flex;flex-direction:column-reverse;gap:4px;padding:0;}
.layer-item{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);border-radius:12px;transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1);cursor:grab;touch-action:none;position:relative}
.layer-item:active{cursor:grabbing}
.layer-item.selected{
    background:rgba(255,110,65,0.15);
    border-color:var(--orange-main);
    box-shadow:0 0 20px rgba(255,110,65,0.3),0 4px 12px rgba(255,110,65,0.2)
}
.layer-panel.collapsed .layer-item.selected .layer-preview {
    transform: scale(1.1);
    box-shadow: 0 0 0 2px var(--orange-main), 0 6px 16px rgba(255,110,65,0.4);
}

.layer-item.dragging{opacity:0.6;transform:scale(1.02);box-shadow:0 8px 24px rgba(0,0,0,0.3);z-index:1000;background:rgba(255,110,65,0.2);border-color:var(--orange-main);transition:none}

.layer-item.drag-over{
    transform:translateY(-4px);
    background:rgba(255,110,65,0.1);
    border-color:var(--orange-main);
    border-style:dashed
}

.layer-panel.collapsed .layer-item.drag-over .layer-preview {
    border: 1px dashed var(--orange-main);
    background: rgba(255,110,65,0.1);
    transform: scale(1.05);
}

.layer-drag-handle{cursor:grab;padding:4px;color:var(--text-color-light);opacity:0.6;display:flex;align-items:center;justify-content:center;}
.layer-drag-handle:active{cursor:grabbing}
.layer-drag-handle svg{width:18px;height:18px;fill:currentColor;}
.layer-preview{width:40px;height:40px;border-radius:8px;background:var(--bg-color-light);border:1px solid var(--border-color-light);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;color:var(--orange-main);flex-shrink:0;overflow:hidden;position:relative}
.layer-preview svg{width:24px;height:24px;stroke:currentColor;fill:none}
.layer-preview svg circle{fill:currentColor;stroke:currentColor}
.layer-info{
    flex:1;
    min-width:0;
    text-align: left;
}
body[data-lang="fa"] .layer-info,
body[data-lang="ar"] .layer-info {
    text-align: right;
}

.layer-name{font-size:0.85rem;font-weight:600;color:var(--text-color-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.layer-z-index{font-size:0.7rem;opacity:0.7;color:var(--text-color-light)}
.layer-actions{display:flex;gap:6px;align-items:center}
.layer-action-btn{width:50px;height:30px;border-radius:20px;background:rgba(255,255,255,0.08);border:1.5px solid rgba(255,255,255,0.15);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1);color:var(--text-color-light);flex-shrink:0;position:relative;overflow:hidden}
.layer-action-btn::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at center,rgba(255,255,255,0.15),transparent);opacity:0;transition:opacity 0.25s ease}
.layer-action-btn:hover::before{opacity:1}
.layer-action-btn:hover{background:rgba(255,110,65,0.25);border-color:rgba(255,110,65,0.6);transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,110,65,0.3)}
.layer-action-btn:active{transform:translateY(0) scale(0.96);box-shadow:0 2px 6px rgba(255,110,65,0.2)}
.layer-action-btn svg{width:22px;height:22px;stroke:currentColor;fill:none;transition:all 0.2s ease}
.layer-drag-handle svg{width:18px;height:18px;fill:currentColor;stroke:none}
.layer-action-btn.visibility-btn.hidden{opacity:0.5;background:rgba(100,100,100,0.15)}
.layer-action-btn.visibility-btn.hidden svg{opacity:0.6;stroke:#888}
.layer-action-btn.visibility-btn:not(.hidden){background:rgba(76,175,80,0.15);border-color:rgba(76,175,80,0.4)}
.layer-action-btn.visibility-btn:not(.hidden) svg{stroke:#4CAF50}
.layer-action-btn.lock-btn.locked{background:rgba(255,152,0,0.2);border-color:rgba(255,152,0,0.5);box-shadow:0 0 0 3px rgba(255,152,0,0.1)}
.layer-action-btn.lock-btn.locked svg{fill:none;stroke:#FF9800}
.layer-action-btn.lock-btn:not(.locked){background:rgba(33,150,243,0.12);border-color:rgba(33,150,243,0.3)}
.layer-action-btn.lock-btn:not(.locked) svg{stroke:#2196F3}
.layer-action-btn.delete-btn{background:rgba(244,67,54,0.12);border-color:rgba(244,67,54,0.3)}
.layer-action-btn.delete-btn svg{stroke:#F44336}
.layer-action-btn.delete-btn:hover{background:rgba(244,67,54,0.25);border-color:rgba(244,67,54,0.6);box-shadow:0 4px 12px rgba(244,67,54,0.35)}
.layer-action-btn.delete-btn:hover svg{stroke:#f44336;transform:scale(1.1)}


.layer-panel-overlay{display:none;}

.layer-list {
    position: relative; /* برای موقعیت‌دهی خط راهنما */
}
.layer-drop-indicator {
    position: absolute;
    width: calc(100% - 24px); /* تطابق با پدینگ آیتم‌ها */
    left: 12px;
    height: 4px;
    background: var(--orange-main);
    border-radius: 2px;
    z-index: 1001;
    display: none; /* مخفی در حالت عادی */
    pointer-events: none;
    box-shadow: 0 0 10px var(--orange-main);
    transition: top 0.1s ease-out;
}
.layer-panel.collapsed .layer-drop-indicator {
    width: 40px;
    left: 50%;
    transform: translateX(-50%);
    height: 3px;
}
.layer-item.drag-over {
    /* حذف افکت قبلی */
    transform: none;
    background: rgba(255,255,255,0.08);
    border-color: var(--border-color-light);
    border-style: solid;
}

@media (max-width: 768px) {
.layer-panel{width:280px;right:-280px;}
.layer-panel.collapsed{width:60px;}
.layer-panel.logo-only{width:50px; height: 50px;}
body[data-lang="fa"] .layer-panel,
body[data-lang="ar"] .layer-panel{left:-280px;right:auto;}
body[data-lang="fa"] .layer-panel.collapsed,
body[data-lang="ar"] .layer-panel.collapsed{left:-60px;}
body[data-lang="fa"] .layer-panel.logo-only,
body[data-lang="ar"] .layer-panel.logo-only{left:0px;}
}

@media (max-width: 480px) {
.layer-panel{width:100%;max-width:min(320px,90vw);right:calc(-1 * min(320px,90vw));border-left:none;border-top-left-radius:20px;border-bottom-left-radius:20px;}
.layer-panel.active:not(.collapsed):not(.logo-only){width:100%;max-width:min(320px,90vw);right:0;}
.layer-panel.collapsed{width:60px;right:-60px;}
.layer-panel.active.collapsed{right:0;}
.layer-panel.logo-only{width:50px;right:0px;}
body[data-lang="fa"] .layer-panel,
body[data-lang="ar"] .layer-panel{left:calc(-1 * min(320px,90vw));max-width:min(320px,90vw);right:auto;border-right:none;border-left:none;border-top-right-radius:20px;border-bottom-right-radius:20px;border-top-left-radius:0;border-bottom-left-radius:0;}
body[data-lang="fa"] .layer-panel.active:not(.collapsed):not(.logo-only),
body[data-lang="ar"] .layer-panel.active:not(.collapsed):not(.logo-only){width:100%;max-width:min(320px,90vw);left:0;}
body[data-lang="fa"] .layer-panel.collapsed,
body[data-lang="ar"] .layer-panel.collapsed{left:-60px;right:auto;}
body[data-lang="fa"] .layer-panel.active.collapsed,
body[data-lang="ar"] .layer-panel.active.collapsed{left:0;right:auto;}
body[data-lang="fa"] .layer-panel.logo-only,
body[data-lang="ar"] .layer-panel.logo-only{left:0px;}
}

.crop-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.1);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);display:none;z-index:6000;align-items:center;justify-content:center;padding:0;}
.crop-modal.active{display:flex}
.crop-container {
    background: var(--panel-bg-light);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    border-radius: 0px;
    padding: calc(20px + var(--safe-area-top)) 20px calc(20px + var(--safe-area-bottom)) 20px;
    max-width: 100%;
    width: 100%;
    height: 100vh;
    height: 100dvh;
    max-height: 100vh;
    max-height: 100dvh;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
    border: none;
    color: var(--text-color-light);
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
}

.crop-header{text-align:center;margin-bottom:18px;color:var(--text-color-light);flex-shrink:0}
.crop-header h3{margin:0 0 6px 0;font-size:1.15rem;font-weight:700;line-height:1.3}
.crop-viewport{position:relative;flex:1;border-radius:16px;border:2px solid var(--border-color-light);margin-bottom:12px;background:rgba(240,240,240,0.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);overflow:hidden;touch-action:none;cursor:grab;user-select:none;-webkit-user-select:none;contain:layout style paint;min-height:320px;}
.crop-viewport.dragging{cursor:grabbing}
.crop-image{position:absolute;transition:none;user-select:none;-webkit-user-select:none;pointer-events:none;max-width:none;max-height:none;will-change:transform;backface-visibility:hidden;image-rendering:high-quality;display:block}
.crop-loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--text-color-light);font-size:0.9rem;display:flex;flex-direction:column;align-items:center;gap:12px}
.crop-loading-spinner{width:32px;height:32px;border:3px solid rgba(255,110,65,0.3);border-top:3px solid var(--orange-main);border-radius:50%;animation:spin 1s linear infinite}
.crop-overlay{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:10}
.crop-frame{position:absolute;border:1px solid var(--orange-main);box-shadow:0 0 0 9999px rgba(0,0,0,0.5);pointer-events:none;display:block;border-radius:16px}
.crop-controls{display:flex;flex-direction:column;gap:8px;flex-shrink:0}
.crop-tools-container{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;padding:6px 0}
.crop-tool-group{display:flex;gap:6px;flex-shrink:0;align-items:center;background:rgba(255,255,255,0.08);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);padding:6px 10px;border-radius:10px;border:1px solid var(--border-color-light)}
.zoom-controls{display:flex;gap:8px;align-items:center;flex-shrink:0;flex:1;min-width:0}
.zoom-slider-container{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
.zoom-slider{flex:1;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,0.15);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);height:8px;border-radius:4px;border:1px solid var(--border-color-light);outline:none;cursor:pointer;min-width:80px}
.zoom-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;background:var(--orange-main);border-radius:50%;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.2);transition:all var(--transition-fast);border:2px solid white}
.zoom-slider::-webkit-slider-thumb:hover{transform:scale(1.15);background:var(--orange-dark);box-shadow:0 3px 12px rgba(255,110,65,0.4)}
.zoom-slider::-webkit-slider-thumb:active{transform:scale(1.05)}
.zoom-slider::-moz-range-thumb{width:20px;height:20px;background:var(--orange-main);border-radius:50%;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.2);transition:all var(--transition-fast);border:2px solid white}
.zoom-slider::-moz-range-thumb:hover{transform:scale(1.15);background:var(--orange-dark);box-shadow:0 3px 12px rgba(255,110,65,0.4)}
.zoom-slider::-moz-range-thumb:active{transform:scale(1.05)}
.zoom-info{font-size:0.7rem;color:var(--text-color-light);min-width:42px;text-align:center;font-weight:600;background:rgba(255,110,65,0.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:3px 6px;border-radius:5px;border:1px solid rgba(255,110,65,0.3);flex-shrink:0}
.crop-instructions{font-size:0.65rem;color:var(--text-color-light);opacity:0.8;text-align:center;margin-bottom:6px;line-height:1.3}
.crop-actions{display:flex;gap:8px;margin-top:6px}
.crop-btn{flex:1;padding:10px;border:1px solid var(--border-color-light);border-radius:12px;cursor:pointer;font-size:0.85rem;font-weight:600;transition:all var(--transition-smooth);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);outline:none}
.crop-btn.cancel{background:rgba(128,128,128,0.15);color:var(--text-color-light);border-color:var(--border-color-light)}
.crop-btn.confirm{background:rgba(255,110,65,0.2);color:var(--orange-main);border-color:var(--orange-main)}
.crop-btn:hover,.crop-btn:focus-visible{transform:translateY(-2px)}
.crop-btn.cancel:hover,.crop-btn.cancel:focus{background:rgba(128,128,128,0.25);color:var(--orange-main)}
.crop-btn.confirm:hover,.crop-btn.confirm:focus-visible{background:var(--orange-main);color:white}
.download-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.1);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);display:none;z-index:6000;align-items:center;justify-content:center;padding:20px}
.download-modal.active{display:flex}
.download-modal-content{background:var(--panel-bg-light);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));border-radius:20px;padding:24px;max-width:450px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.4);border:1px solid var(--border-color-light);color:var(--text-color-light)}
.download-modal-header{text-align:center;margin-bottom:22px;color:var(--text-color-light)}
.download-modal-header h3{margin:0 0 8px 0;font-size:1.2rem;font-weight:700}
.download-modal-header p{margin:0;font-size:0.85rem;opacity:0.8}
.download-grid{display:flex;flex-direction:column;gap:14px;margin-bottom:20px}
.download-row{display:flex;gap:10px}
.download-card{display:flex;align-items:center;gap:14px;padding:16px;background:rgba(255,255,255,0.08);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border:1px solid var(--border-color-light);border-radius:14px;cursor:pointer;transition:all var(--transition-smooth);outline:none}
.download-card-half {
    flex: 1;
    flex-direction: column;
    justify-content: center;
    gap: 12px;
    padding-top: 18px;
    padding-bottom: 18px;
    min-height: 110px;
}
.crop-aspect-btn {
    display: flex;
    flex: 1;
    align-items: center;
    justify-content: center;
    gap: 18px;
    padding: 6px 10px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid var(--border-color-light);
    border-radius: 8px;
    color: var(--text-color-light);
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    padding: 6px 12px;
    transition: all var(--transition-smooth);
    user-select: none;
    -webkit-user-select: none;
    outline: none;
}
}
.crop-aspect-btn:hover, .crop-aspect-btn:focus-visible {
    background: var(--orange-main);
    color: white;
    transform: scale(1.05);
    border-color: var(--orange-dark);
}
.crop-aspect-btn.active {
    background: var(--orange-dark);
    color: white;
    border-color: var(--orange-main);
    box-shadow: 0 0 10px rgba(255, 110, 65, 0.5);
}
.crop-aspect-btn svg {
    width: 18px;
    height: 18px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
}

.download-card-half .download-content {
    text-align: center;
}
.download-card-half .download-content h3 {
    margin-bottom: 4px;
}
.download-card-vip{background:linear-gradient(135deg,rgba(255,215,0,0.15) 0%,rgba(255,110,65,0.15) 100%);border:2px solid rgba(255,215,0,0.6);position:relative;overflow:hidden}
.download-card-vip::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent,rgba(255,215,0,0.1),transparent);animation:vipShine 3s ease-in-out infinite}
@keyframes vipShine{0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}50%{transform:translateX(100%) translateY(100%) rotate(45deg)}100%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}}
.download-card:hover,.download-card:focus-visible{background:rgba(255,110,65,0.2);border-color:var(--orange-main);transform:translateY(-2px);box-shadow:0 10px 30px rgba(255,110,65,0.3)}
.download-card-vip:hover,.download-card-vip:focus-visible{background:linear-gradient(135deg,rgba(255,215,0,0.25) 0%,rgba(255,110,65,0.25) 100%);border-color:#ffd700;transform:translateY(-3px);box-shadow:0 15px 40px rgba(255,215,0,0.4)}
.download-card:hover .download-content h3,.download-card:hover .download-content p,.download-card:focus .download-content h3,.download-card:focus .download-content p{color:var(--text-color-light)}
.download-card:hover .download-icon svg,.download-card:focus .download-icon svg{stroke:var(--orange-main)}
.download-card.ios-save{background:rgba(76,175,80,0.15);border-color:rgba(76,175,80,0.3)}
.download-card.ios-save:hover{background:rgba(76,175,80,0.25);border-color:#4CAF50}
.download-card.ios-save .download-icon{background:rgba(76,175,80,0.2);border-color:rgba(76,175,80,0.4)}
.download-card.ios-save .download-icon svg{stroke:#4CAF50}
.download-card.ios-download{background:rgba(33,150,243,0.15);border-color:rgba(33,150,243,0.3)}
.download-card.ios-download:hover{background:rgba(33,150,243,0.25);border-color:#2196F3}
.download-card.ios-download .download-icon{background:rgba(33,150,243,0.2);border-color:rgba(33,150,243,0.4)}
.download-card.ios-download .download-icon svg{stroke:#2196F3}
.ios-gallery-permission{background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.3);border-radius:12px;padding:12px;margin-bottom:16px;text-align:center}
.ios-gallery-permission-icon{font-size:2rem;margin-bottom:8px;color:#4CAF50}
.ios-gallery-permission-text{font-size:0.85rem;color:var(--text-color-light);line-height:1.4}
.download-icon{flex-shrink:0;width:42px;height:42px;background:rgba(255,110,65,0.15);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:12px;border:1px solid rgba(255,110,65,0.3);display:flex;align-items:center;justify-content:center;transition:all var(--transition-smooth);position:relative;z-index:2}
.download-icon-vip{background:linear-gradient(135deg,rgba(255,215,0,0.2) 0%,rgba(255,110,65,0.2) 100%);border:1px solid rgba(255,255,255,0.8)}
.download-icon svg{width:22px;height:22px;stroke:var(--orange-main);transition:all var(--transition-smooth);position:relative;z-index:2}
.download-icon-vip svg{stroke:rgba(255,255,255,0.8)}
.download-content{flex:1;position:relative;z-index:2}
.download-content h3{font-size:0.85rem;font-weight:700;margin:0 0 3px 0;color:var(--text-color-light);transition:color var(--transition-smooth)}
.download-content p{font-size:0.7rem;margin:0;color:var(--text-color-light);opacity:0.8;transition:color var(--transition-smooth)}
.app-info{margin-top:18px;padding:18px;background:rgba(255,255,255,0.06);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:14px;border:1px solid var(--border-color-light);text-align:center}
.app-info h4{margin:0 0 12px 0;font-size:1rem;font-weight:600;color:var(--text-color-light)}
.app-version{font-size:0.75rem;color:var(--text-color-light);opacity:0.7;margin-bottom:10px}
.developer-credits{font-size:0.85rem;color:var(--text-color-light);margin-bottom:8px;line-height:1.4;font-weight:500}
.follow-text{font-size:0.8rem;color:var(--text-color-light);margin-bottom:12px;font-weight:500}
.contact-links{display:flex;justify-content:center;gap:12px;margin-top:12px}
.contact-link{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(255,110,65,0.15);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:10px;text-decoration:none;color:var(--text-color-light);font-size:0.75rem;transition:all var(--transition-smooth);border:1px solid rgba(255,110,65,0.3);outline:none}
.contact-link:hover,.contact-link:focus{background:rgba(255,110,65,0.25);border-color:var(--orange-main);transform:translateY(-1px)}
.contact-link svg{width:16px;height:16px}
.close-download-modal{width:100%;padding:14px;background:rgba(128,128,128,0.15);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);color:var(--text-color-light);border:1px solid var(--border-color-light);border-radius:12px;cursor:pointer;font-size:0.9rem;font-weight:600;transition:all var(--transition-smooth);margin-top:14px;outline:none}
.close-download-modal:hover,.close-download-modal:focus{transform:translateY(-2px);background:rgba(128,128,128,0.25)}
.success-icon{animation:successPulse 0.6s ease-out}
@keyframes successPulse{0%{transform:scale(0.8);opacity:0}50%{transform:scale(1.1);opacity:1}100%{transform:scale(1);opacity:1}}
.custom-alert-modal{animation:modalFadeIn 0.3s ease-out}
@keyframes modalFadeIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
body[data-lang="fa"],body[data-lang="ar"]{direction:rtl}
body[data-lang="fa"] .slider-group label,body[data-lang="ar"] .slider-group label{text-align:right}
body[data-lang="fa"] .slider-value,body[data-lang="ar"] .slider-value{text-align:center}
@media (max-width:768px){:root{--header-base-height:55px;--footer-base-height:85px}#appTitle{font-size:1rem}.subtitle{font-size:0.55rem}.control-icon span{font-size:0.65rem}.control-icons{gap:12px}.crop-.crop-modal{padding:8px}.crop-container{padding:12px;border-radius:12px;max-width:96%;max-height:92vh;max-height:92dvh}
.crop-header h3{font-size:1.05rem}.crop-viewport{min-height:280px;}
.contact-links{flex-direction:column;align-items:center}.contact-link{width:100%;justify-content:center}.accordion-panel{max-height:calc(45vh - var(--footer-height) - 20px)}.canvas-container{padding:6px}}
@media (max-width:480px){:root{--footer-base-height:80px;--header-base-height:55px}.header{padding:calc(8px + var(--safe-area-top)) 12px 6px 12px}.footer-controls{padding:8px 12px calc(8px + var(--safe-area-bottom)) 12px}#appTitle{font-size:0.9rem}.control-icons{gap:8px}.control-icon{min-width:55px;padding:8px 10px}.crop-modal{padding:8px}.crop-container{padding:12px;border-radius:12px;max-width:96%;max-height:92vh;max-height:92dvh}.crop-header{margin-bottom:14px}.crop-header h3{font-size:0.95rem}.crop-.crop-viewport{min-height:250px;}
.crop-instructions{font-size:0.6rem}.zoom-slider{min-width:60px;height:6px}.zoom-slider::-webkit-slider-thumb{width:18px;height:18px}.zoom-slider::-moz-range-thumb{width:18px;height:18px}.zoom-info{font-size:0.65rem;min-width:38px;padding:2px 5px}.layer-panel.active:not(.collapsed):not(.logo-only){max-width:min(320px,90vw)}.layer-panel.collapsed{width:60px}}
@media (display-mode: standalone) {
    html, body {
        width: 100vw;
        height: 100vh;
        height: 100dvh;
        position: fixed;
        overflow: hidden;
    }
    .main-app-container {
        width: 100vw;
        height: 100vh;
        height: 100dvh;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }
    .header {
        margin-top: 0;
        left: 0;
        width: 100%;
        border-radius: 0;
        border-left: none;
        border-right: none;
        padding-left: calc(16px + var(--safe-area-left));
        padding-right: calc(16px + var(--safe-area-right));
    }
    .footer-controls {
        margin-bottom: 0;
        left: 0;
        width: 100%;
        border-radius: 0;
        border-left: none;
        border-right: none;
        padding-left: calc(16px + var(--safe-area-left));
        padding-right: calc(16px + var(--safe-area-right));
    }
    .accordion-panel {
        bottom: calc(var(--footer-height) + var(--safe-area-bottom));
        left: 0;
        right: 0;
        width: 100%;
        margin-bottom: 0;
        border-radius: 20px 20px 0 0;
        max-height: calc(40vh - var(--footer-height));
        padding-left: calc(10px + var(--safe-area-left));
        padding-right: calc(10px + var(--safe-area-right));
    }
    .canvas-container {
        padding-left: var(--safe-area-left, 10px);
        padding-right: var(--safe-area-right, 10px);
    }
}




.will-change-transform{will-change:transform}
.gpu-accelerated{transform:translateZ(0);backface-visibility:hidden}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
@media (prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important}}
@media print{.header,.footer-controls,.accordion-panel,.quick-action-modal,.crop-modal,.download-modal{display:none!important}.main-content{padding:0}}
.undo-redo-bar{position:fixed;top:calc(var(--header-height) + var(--safe-area-top) + 10px);left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;gap:8px;background:var(--panel-bg-light);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));border:1px solid var(--border-color-light);border-radius:16px;padding:8px 20px;z-index:1999;box-shadow:0 4px 15px var(--shadow-color);transition:all var(--transition-smooth)}
.undo-redo-btn{background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);cursor:pointer;padding:8px 16px;border-radius:12px;transition:all var(--transition-smooth);color:var(--text-color-light);display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.85rem;font-weight:600;min-width:85px;outline:none}
.undo-redo-btn:hover,.undo-redo-btn:focus{background:rgba(255,110,65,0.2);border-color:var(--orange-main);transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,110,65,0.3)}
.undo-redo-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none!important;background:rgba(128,128,128,0.1)!important;border-color:rgba(128,128,128,0.2)!important}
.undo-redo-btn svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
.text-align-group{display:flex;gap:8px;margin-bottom:12px;padding:12px;background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:12px;border:1px solid var(--border-color-light)}
.text-align-btn{flex:1;background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);cursor:pointer;padding:10px;border-radius:10px;transition:all var(--transition-smooth);color:var(--text-color-light);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;outline:none}
.text-align-btn:hover,.text-align-btn:focus{background:rgba(255,110,65,0.15);border-color:var(--orange-main);transform:translateY(-1px)}
.text-align-btn.active{background:var(--orange-main);color:white;border-color:var(--orange-dark);box-shadow:0 4px 12px rgba(255,110,65,0.4)}
.text-align-btn svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2}
.text-align-btn span{font-size:0.7rem;font-weight:600}
.text-direction-group{display:flex;gap:8px;margin-bottom:12px}
.text-direction-btn{flex:1;background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);cursor:pointer;padding:12px;border-radius:10px;transition:all var(--transition-smooth);color:var(--text-color-light);display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.85rem;font-weight:600;outline:none}
.text-direction-btn:hover,.text-direction-btn:focus{background:rgba(255,110,65,0.15);border-color:var(--orange-main);transform:translateY(-1px)}
.text-direction-btn.active{background:var(--orange-main);color:white;border-color:var(--orange-dark);box-shadow:0 4px 12px rgba(255,110,65,0.4)}


.layer-panel.active:not(.collapsed):not(.logo-only) {
    width: 100%; /* Occupy full viewport width */
    height: 100%; /* Occupy full viewport height (dvh is better for mobile) */
    top: flex;
    right: flex;
    left: auto; /* Reset for LTR layouts */
    max-width: none; /* IMPORTANT: Removes the width constraint from mobile styles */
    border-radius: 0; /* A fullscreen panel should not have rounded corners */
    border-left: none; /* Remove side border in fullscreen */
    z-index: 5000; 
}


body[data-lang="fa"] .layer-panel.active:not(.collapsed):not(.logo-only),
body[data-lang="ar"] .layer-panel.active:not(.collapsed):not(.logo-only) {
    left: 0;
    right: auto;
    border-right: none;
}


</style>
</head>
<body data-lang="en">
<div class="sr-only" role="region" aria-live="polite" id="announcements"></div>
<div id="orientation-lock-overlay" class="orientation-lock-overlay" role="dialog" aria-labelledby="orientation-title" aria-describedby="orientation-desc">
<div class="orientation-lock-message">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
<rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
<line x1="12" y1="18" x2="12.01" y2="18"/>
</svg>
<h2 id="orientation-title" data-en="Portrait Mode Required" data-fa="حالت عمودی مورد نیاز است" data-ar="الوضع العمودي مطلوب">Portrait Mode Required</h2>
<p id="orientation-desc" data-en="Please rotate your device to portrait mode for the best experience." data-fa="لطفاً دستگاه خود را به حالت عمودی بچرخانید تا بهترین تجربه را داشته باشید." data-ar="يرجى تدوير جهازك إلى الوضع العمودي للحصول على أفضل تجربة.">Please rotate your device to portrait mode for the best experience.</p>
</div>
</div>

<!-- Enhanced PWA Add to Home Screen Prompt -->
<div id="pwaInstallPrompt" class="pwa-install-prompt" role="dialog" aria-labelledby="pwa-install-title" aria-describedby="pwa-install-desc">
<div class="pwa-install-content">
<div class="pwa-install-icon">
<svg width="256px" height="256px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier_pwa" stroke-width="0"></g><g id="SVGRepo_tracerCarrier_pwa" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier_pwa"> <circle cx="12" cy="12" r="8.4" stroke="#ffffff" stroke-opacity="0.24" stroke-width="1.2"></circle> <path d="M12 8L12 16" stroke="#ffffff" stroke-width="1.2" stroke-linecap="round"></path> <path d="M16 12L8 12" stroke="#ffffff" stroke-width="1.2" stroke-linecap="round"></path> </g></svg>
</div>
<div class="pwa-install-text">
<div id="pwa-install-title" class="pwa-install-title" data-en="Install DACO Pro" data-fa="نصب DACO Pro" data-ar="تثبيت DACO Pro">Install DACO Pro</div>
<div id="pwa-install-desc" class="pwa-install-desc" data-en="Add to your home screen for fast access and enhanced performance." data-fa="برای دسترسی سریع و عملکرد بهتر به صفحه اصلی اضافه کنید." data-ar="أضف إلى الشاشة الرئيسية للوصول السريع والأداء المحسن.">Add to your home screen for fast access and enhanced performance.</div>
</div>
<button id="pwaInstallClose" class="pwa-install-close" aria-label="Close install prompt">×</button>
</div>
</div>

<div class="main-app-container">
<div id="dacoLoadingScreen" class="daco-loading-screen" role="dialog" aria-labelledby="loading-title" aria-describedby="loading-desc">
<div class="daco-logo-container">
<div class="daco-logo">
<img src="https://pfst.cf2.poecdn.net/base/image/9364acf5be21b0eee6147030618bf2683bcb6c9d5f8c0b333df2670ff59a892f?w=512&h=512" alt="DACO Logo">
</div>
</div>
<div id="loading-title" class="loading-text" data-en=" DACO" data-fa="داکو" data-ar="داکو">Loading DACO...</div>
<div id="loading-desc" class="loading-subtitle" data-en="made by parham darabi" data-fa="ساخته پرهام دارابی" data-ar="پرهام دارابی"></div>
</div>
<div id="quickActionModal" class="quick-action-modal" role="dialog" aria-labelledby="quick-modal-title" aria-hidden="true" onclick="if(event.target === this) interactionManager.hideQuickActionModal();">
<div class="quick-action-content" onclick="event.stopPropagation();">
<h3 id="quick-modal-title" class="quick-action-title" data-en="Quick Actions" data-fa="اعمال سریع" data-ar="الإجراءات السريعة">Quick Actions</h3>
<div class="quick-action-buttons">
<button class="quick-action-btn" id="quickAddImage" aria-describedby="quick-image-desc">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
<circle cx="8.5" cy="8.5" r="1.5"/>
<polyline points="21,15 16,10 5,21"/>
</svg>
<div class="quick-action-btn-text">
<div class="quick-action-btn-title" data-en="Add Image" data-fa="اضافه کردن عکس" data-ar="إضافة صورة">Add Image</div>
<div id="quick-image-desc" class="quick-action-btn-desc" data-en="Upload and crop your photo" data-fa="عکس خود را بارگذاری و برش دهید" data-ar="تحميل وقص صورتك">Upload and crop your photo</div>
</div>
</button>
<button class="quick-action-btn" id="quickAddText" aria-describedby="quick-text-desc">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
<polyline points="4 7 4 4 20 4 20 7"></polyline>
<line x1="9" y1="20" x2="15" y2="20"></line>
<line x1="12" y1="4" x2="12" y2="20"></line>
</svg>
<div class="quick-action-btn-text">
<div class="quick-action-btn-title" data-en="Add Text" data-fa="اضافه کردن متن" data-ar="إضافة نص">Add Text</div>
<div id="quick-text-desc" class="quick-action-btn-desc" data-en="Create beautiful text overlay" data-fa="متن زیبای روی تصویر بسازید" data-ar="إنشاء نص جميل على الصورة">Create beautiful text overlay</div>
</div>
</button>
</div>
</div>
</div>
<div id="cropModal" class="crop-modal" role="dialog" aria-labelledby="crop-modal-title" aria-hidden="true">
<div class="crop-container">
<div class="crop-header">
<h3 id="crop-modal-title" data-en="Crop Image - Perfect 9:16 Format" data-fa="برش تصویر - فرمت کامل ۹:۱۶" data-ar="قص الصورة - تنسيق 9:16 مثالي">Crop Image - Perfect 9:16 Format</h3>
</div>
<div class="crop-viewport" id="cropViewport" role="img" aria-label="Image cropping area">
<img id="cropImage" class="crop-image" style="display: none;" alt="Image being cropped">
<div class="crop-loading" id="cropLoading" aria-live="polite">
<div class="crop-loading-spinner" aria-hidden="true"></div>
<span data-en="Loading image..." data-fa="در حال بارگذاری عکس..." data-ar="جاري تحميل الصورة...">Loading image...</span>
</div>
<div class="crop-overlay" aria-hidden="true">
<div id="cropFrame" class="crop-frame"></div>
</div>
</div>
<div class="crop-controls">
<div class="crop-instructions" data-en="Pinch to zoom • Drag to position • Perfect 9:16 story format" data-fa="زوم کنید • جابجا کنید • فرمت کامل ۹:۱۶ استوری" data-ar="اقرص للتكبير • اسحب للموضع • تنسيق قصة 9:16 مثالي">Pinch to zoom • Drag to position • Perfect 9:16 story format</div>
<div class="crop-tools-container">
<div class="crop-tool-group">
<div class="zoom-controls" role="group" aria-label="Zoom controls">
<input type="range" id="zoomSlider" class="zoom-slider" min="100" max="300" value="100" step="1" aria-label="Zoom level">
<span class="zoom-info" id="zoomInfo" aria-live="polite">100%</span>
</div>
</div>
<div class="crop-tool-group">
    <button class="crop-aspect-btn active" id="cropAspectStory" aria-label="Set aspect ratio to 9:16">
        <svg viewBox="0 0 24 24"><rect x="7.5" y="2" width="9" height="20" rx="1"></rect></svg>
        <span>Story</span>
    </button>
    <button class="crop-aspect-btn" id="cropAspectSquare" aria-label="Set aspect ratio to 1:1">
        <svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="1"></rect></svg>
        <span>Square</span>
    </button>
    <button class="crop-aspect-btn" id="cropAspectPortrait" aria-label="Set aspect ratio to 4:5">
        <svg viewBox="0 0 24 24"><rect x="6" y="3" width="12" height="18" rx="1"></rect></svg>
        <span>Portrait</span>
    </button>
</div>
</div>
<div class="crop-actions" role="group" aria-label="Crop actions">
<button class="crop-btn cancel" id="cropCancel" data-en="Cancel" data-fa="لغو" data-ar="إلغاء">Cancel</button>
<button class="crop-btn confirm" id="cropConfirm" data-en="Apply Crop" data-fa="اعمال برش" data-ar="تطبيق القص">Apply Crop</button>
</div>
</div>
</div>
</div>
<div id="downloadModal" class="download-modal" role="dialog" aria-labelledby="download-modal-title" aria-hidden="true">
<div class="download-modal-content">
<div class="download-modal-header">
<h3 id="download-modal-title" data-en="Download & Export" data-fa="دانلود و خروجی" data-ar="التحميل والتصدير">Download & Export</h3>
<p data-en="Choose your preferred export option" data-fa="گزینه خروجی مورد نظر خود را انتخاب کنید" data-ar="اختر خيار التصدير المفضل لديك">Choose your preferred export option</p>
</div>
<div class="download-grid" role="group" aria-label="Download options">
<button class="download-card" id="saveToGalleryCard" aria-describedby="save-gallery-desc" data-action="save-gallery">
<div class="download-icon" aria-hidden="true">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
<circle cx="8.5" cy="8.5" r="1.5"/>
<polyline points="21,15 16,10 5,21"/>
</svg>
</div>
<div class="download-content">
<h3 id="saveToGalleryTitle" data-en="Good Quality JPEG" data-fa="JPEG کیفیت خوب" data-ar="JPEGجودة جيدة">Good Quality JPEG</h3>
<p id="save-gallery-desc" data-en="HD JPEG Quality" data-fa="کیفیت HD JPEG" data-ar="جودة HD JPEG">HD JPEG Quality</p>
</div>
</button>
<div class="download-row" role="group" aria-label="Additional download options">
<button class="download-card download-card-vip download-card-half" id="saveVipQualityCard" aria-describedby="save-vip-desc" data-action="save-vip-quality">
<div class="download-icon download-icon-vip" aria-hidden="true">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
</svg>
</div>
<div class="download-content">
<h3 id="saveVipQualityTitle" data-en="VIP JPEG" data-fa="کیفیت VIP" data-ar="جودة VIP">VIP JPEG</h3>
<p id="save-vip-desc" data-en="4K Quality" data-fa="رزولوشن ۴K" data-ar="دقة 4K">4K Quality</p>
</div>
</button>
<button class="download-card download-card-half" id="downloadTransparentCard" aria-describedby="download-transparent-desc" data-action="download-transparent">
<div class="download-icon" aria-hidden="true">
<svg xmlns="http://www.w3.org/2000/<svg 
  xmlns="http://www.w3.org/2000/svg" 
  viewBox="0 0 24 24" 
  fill="none" 
  stroke="currentColor" 
  stroke-width="1.5" 
  stroke-linecap="round" 
  stroke-linejoin="round"
>
  <path d="M12 3H8C6.114 3 5.172 3 4.586 3.586C4 4.172 4 5.114 4 7V7.95M12 3H16C17.886 3 18.828 3 19.414 3.586C20 4.172 20 5.114 20 7V7.95M12 3V21"/>
  <path d="M7 21H17"/>
</svg>
</div>
<div class="download-content">
<h3 data-en="Text PNG" data-fa="فقط متن PNG" data-ar="النص فقط PNG">Text PNG</h3>
<p id="download-transparent-desc" data-en="Transparent" data-fa="پس‌زمینه شفاف" data-ar="خلفية شفافة">Transparent</p>
</div>
</button>
</div>
</div>
<div class="app-info">
<h4 data-en="DACO   Pro" data-fa="DACO   Pro" data-ar="DACO   Pro">DACO   Pro</h4>
<div class="app-version" data-en="Version 5.2.0 • made by parham darabi" data-fa="نسخه ۵.۲.۰ • ویرایش بهبود یافته" data-ar="الإصدار 5.2.0 • إصدار محسن">Version 5.2.0 • made by parham darabi</div>
<div class="follow-text" data-en="Follow us on Instagram" data-fa="ما را در اینستاگرام دنبال کنید" data-ar="تابعونا على إنستغرام للتحديثات">Follow us on Instagram</div>
<div class="contact-links">
<a href="/cdn-cgi/l/email-protection#2b4f4a4844054a595f4c59445e5b6b4c464a424705484446" class="contact-link" aria-label="Send email to DACO Art Group">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
<polyline points="22,6 12,13 2,6"/>
</svg>
<span data-en="Email" data-fa="ایمیل" data-ar="البريد">Email</span>
</a>
<a href="https://www.instagram.com/daco.artgroup?igsh=MTI3OTljdmU2M3hlcg==" class="contact-link" target="_blank" rel="noopener noreferrer" aria-label="Follow DACO Art Group on Instagram">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
<rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
<path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
<line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/>
</svg>
<span data-en="Instagram" data-fa="اینستاگرام" data-ar="إنستغرام">Instagram</span>
</a>
</div>
</div>
<button class="close-download-modal" id="closeDownloadModal" data-en="Close" data-fa="بستن" data-ar="إغلاق">Close</button>
</div>
</div>
<header class="header" role="banner">
<div class="header-top">
<div class="header-controls-left">
<input type="file" id="imageInput" accept="image/*" aria-label="Upload image file">
<button class="hamburger-menu-btn" id="hamburgerMenuBtn" aria-label="Open menu">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
<line x1="3" y1="12" x2="21" y2="12"/>
<line x1="3" y1="6" x2="21" y2="6"/>
<line x1="3" y1="18" x2="21" y2="18"/>
</svg>
</button>
<button class="header-btn" id="uploadImageBtn" aria-label="Upload new image">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
<circle cx="8.5" cy="8.5" r="1.5"/>
<polyline points="21,15 16,10 5,21"/>
</svg>
</button>
</div>
<div class="app-title-section">
<h1 id="appTitle">DACO Storymaker</h1>
<p class="subtitle" id="appSubtitle">made by parham darabi</p>
</div>
<div class="header-controls-right">
<button class="delete-image-btn" id="deleteImageBtn" aria-label="Delete current image">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
<polyline points="3,6 5,6 21,6"/>
<path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
<line x1="10" y1="11" x2="10" y2="17"/>
<line x1="14" y1="11" x2="14" y2="17"/>
</svg>
</button>
<button class="header-btn" id="downloadHeaderBtn" aria-label="Open download options">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
<polyline points="7 10 12 15 17 10"></polyline>
<line x1="12" y1="15" x2="12" y2="3"></line>
</svg>
</button>
</div>
</div>
</header>

<!-- Hamburger Menu Panel -->
<div class="hamburger-overlay" id="hamburgerOverlay"></div>
<div class="hamburger-panel" id="hamburgerPanel">
<div class="hamburger-section">
<div class="hamburger-section-title" data-en="Account" data-fa="حساب کاربری" data-ar="الحساب">Account</div>
<div class="hamburger-item" id="loginBtn">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
<circle cx="12" cy="7" r="4"/>
</svg>
<span data-en="Login / Sign Up" data-fa="ورود / ثبت‌نام" data-ar="تسجيل الدخول / التسجيل">Login / Sign Up</span>
</div>

</div>

<div class="hamburger-section">
<div class="hamburger-section-title" data-en="Panels" data-fa="پنل‌ها" data-ar="اللوحات">Panels</div>
<div class="hamburger-toggle">
    <div class="hamburger-toggle-label">
        <svg 
  xmlns="http://www.w3.org/2000/svg" 
  viewBox="0 0 24 24" 
  fill="none" 
  stroke="currentColor" 
  stroke-width="1.5" 
  stroke-linecap="round" 
  stroke-linejoin="round"
>
  <path d="M13.01 2.92L18.91 5.54C20.61 6.29 20.61 7.53 18.91 8.28L13.01 10.9C12.34 11.2 11.24 11.2 10.57 10.9L4.67 8.28C2.97 7.53 2.97 6.29 4.67 5.54L10.57 2.92C11.24 2.62 12.34 2.62 13.01 2.92Z"/>
  <path d="M3 11C3 11.84 3.63 12.81 4.4 13.15L11.19 16.17C11.71 16.4 12.3 16.4 12.81 16.17L19.6 13.15C20.37 12.81 21 11.84 21 11"/>
  <path d="M3 16C3 16.93 3.55 17.77 4.4 18.15L11.19 21.17C11.71 21.4 12.3 21.4 12.81 21.17L19.6 18.15C20.45 17.77 21 16.93 21 16"/>
</svg>
        <span data-en="Layer Management" data-fa="مدیریت لایه‌ها" data-ar="إدارة الطبقات">Layer Management</span>
    </div>
    <div class="toggle-switch" id="layersPanelToggleSwitch"></div> </div>

</div>

<div class="hamburger-section">
<div class="hamburger-section-title" data-en="Settings" data-fa="تنظیمات" data-ar="الإعدادات">Settings</div>
<div class="hamburger-toggle">
<div class="hamburger-toggle-label">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
<circle cx="12" cy="12" r="5"/>
<line x1="12" y1="1" x2="12" y2="3"/>
<line x1="12" y1="21" x2="12" y2="23"/>
<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
<line x1="1" y1="12" x2="3" y2="12"/>
<line x1="21" y1="12" x2="23" y2="12"/>
<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
</svg>
<span data-en="Dark Mode" data-fa="حالت شب" data-ar="الوضع الليلي">Dark Mode</span>
</div>
<div class="toggle-switch" id="themeToggleSwitch"></div>
</div>

<div class="hamburger-item" id="langSwitchMenu">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
<circle cx="12" cy="12" r="10"/>
<line x1="2" y1="12" x2="22" y2="12"/>
<path d="M12,2a15.3,15.3,0,0,1,4,10,15.3,15.3,0,0,1-4,10,15.3,15.3,0,0,1-4-10A15.3,15.3,0,0,1,12,2z"/>
</svg>
<span id="currentLangText" data-en="Language: EN" data-fa="زبان: فارسی" data-ar="اللغة: العربية">Language: EN</span>
</div>

<div class="hamburger-toggle">
<div class="hamburger-toggle-label">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
<path d="M3 7v6h6"/>
<path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/>
</svg>
<span data-en="Undo/Redo Bar" data-fa="نوار بازگشت" data-ar="شريط التراجع">Undo/Redo Bar</span>
</div>
<div class="toggle-switch" id="undoRedoToggle"></div>
</div>
</div>
</div>

<!-- Login/Sign Up Modal (Outside Hamburger Menu) -->
<div class="login-modal" id="loginModal" role="dialog" aria-labelledby="login-modal-title" aria-modal="true" aria-hidden="true">
    <div class="login-modal-overlay" id="loginModalOverlay"></div>
    <div class="login-modal-content">
        <button class="login-modal-close" id="loginModalClose" aria-label="Close modal">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
        <div class="login-tabs">
            <button class="login-tab active" data-tab="login" data-en="Login" data-fa="ورود" data-ar="تسجيل الدخول">ورود</button>
            <button class="login-tab" data-tab="signup" data-en="Sign Up" data-fa="ثبت نام" data-ar="التسجيل">ثبت نام</button>
        </div>

        <div class="login-form-container active" id="loginFormContainer">
            <h3 id="login-modal-title" data-en="Welcome Back!" data-fa="خوش آمدید!" data-ar="مرحباً بعودتك!">خوش آمدید!</h3>
            <p data-en="Please enter your details to sign in." data-fa="لطفاً برای ورود اطلاعات خود را وارد کنید." data-ar="الرجاء إدخال بياناتك لتسجيل الدخول.">لطفاً برای ورود اطلاعات خود را وارد کنید.</p>
            <form id="loginForm" action="/api/login" method="POST" novalidate>
                <div class="input-group">
                    <input type="email" id="loginEmail" name="email" required placeholder=" ">
                    <label for="loginEmail" data-en="Email" data-fa="ایمیل" data-ar="البريد الإلكتروني">ایمیل</label>
                </div>
                <div class="input-group">
                    <input type="password" id="loginPassword" name="password" required placeholder=" ">
                    <label for="loginPassword" data-en="Password" data-fa="رمز عبور" data-ar="كلمة المرور">رمز عبور</label>
                </div>
                <a href="#" class="forgot-password" data-en="Forgot password?" data-fa="فراموشی رمز عبور؟" data-ar="هل نسيت كلمة المرور؟">فراموشی رمز عبور؟</a>
                <button type="submit" class="submit-btn" data-en="Sign In" data-fa="ورود" data-ar="تسجيل الدخول">ورود</button>
            </form>
            <div class="login-divider">
                <span data-en="OR" data-fa="یا" data-ar="أو">یا</span>
            </div>
            <button type="button" class="google-login-btn" id="googleLoginBtn">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                <span data-en="Continue with Google" data-fa="ادامه با گوگل" data-ar="متابعة مع جوجل">ادامه با گوگل</span>
            </button>
        </div>

        <div class="login-form-container" id="signupFormContainer">
            <h3 data-en="Create an Account" data-fa="ساخت حساب کاربری" data-ar="إنشاء حساب">ساخت حساب کاربری</h3>
            <p data-en="Start your journey with us today." data-fa="همین امروز سفر خود را با ما آغاز کنید." data-ar="ابدأ رحلتك معنا اليوم.">همین امروز سفر خود را با ما آغاز کنید.</p>
            <form id="signupForm" action="/api/register" method="POST" novalidate>
                 <div class="input-group">
                    <input type="text" id="signupName" name="name" required placeholder=" ">
                    <label for="signupName" data-en="Full Name" data-fa="نام کامل" data-ar="الاسم الكامل">نام کامل</label>
                </div>
                <div class="input-group">
                    <input type="email" id="signupEmail" name="email" required placeholder=" ">
                    <label for="signupEmail" data-en="Email" data-fa="ایمیل" data-ar="البريد الإلكتروني">ایمیل</label>
                </div>
                <div class="input-group">
                    <input type="password" id="signupPassword" name="password" required placeholder=" ">
                    <label for="signupPassword" data-en="Password" data-fa="رمز عبور" data-ar="كلمة المرور">رمز عبور</label>
                </div>
                <button type="submit" class="submit-btn" data-en="Sign Up" data-fa="ثبت نام" data-ar="التسجيل">ثبت نام</button>
            </form>
        </div>
    </div>
</div>

<!-- Undo/Redo Bar (Below Header) -->
<div class="undo-redo-bar" id="undoRedoBar">
<button class="undo-redo-btn" id="undoBtn" aria-label="Undo last action" disabled>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
<path d="M3 7v6h6"/>
<path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/>
</svg>
</button>
<button class="undo-redo-btn" id="redoBtn" aria-label="Redo last action" disabled>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
<path d="M21 7v6h-6"/>
<path d="M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"/>
</svg>	
</button>
</div>

<main class="main-content" role="main">
<div class="canvas-container">
<div class="canvas-wrapper bounded">
<div class="guide-lines" aria-hidden="true">
<div class="guide-line vertical"></div>
<div class="guide-line horizontal"></div>
</div>
<label for="imageInput" id="photo-placeholder" role="button" aria-label="Upload image or double tap for quick actions">+</label>
<canvas id="canvas" role="img" aria-label="Canvas with image and text overlay"></canvas>
<div class="color-picker-cursor" id="colorPickerCursor">
<svg version="1.1" id="Icons_cursor" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve" width="222px" height="222px" fill="#ffffff" stroke="#ffffff"><g id="SVGRepo_bgCarrier_cursor" stroke-width="0"></g><g id="SVGRepo_tracerCarrier_cursor" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier_cursor"><style >.st0{fill:none;stroke:#ffffff;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;}.undo-redo-bar{position:fixed;top:calc(var(--header-height) + var(--safe-area-top));left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;gap:8px;background:var(--panel-bg-light);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));border:1px solid var(--border-color-light);border-top:none;border-radius:0 0 16px 16px;padding:8px 20px;z-index:1999;box-shadow:0 4px 15px var(--shadow-color);transition:all var(--transition-smooth)}
.undo-redo-btn{background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);cursor:pointer;padding:8px 16px;border-radius:12px;transition:all var(--transition-smooth);color:var(--text-color-light);display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.85rem;font-weight:600;min-width:85px;outline:none}
.undo-redo-btn:hover,.undo-redo-btn:focus{background:rgba(255,110,65,0.2);border-color:var(--orange-main);transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,110,65,0.3)}
.undo-redo-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none!important;background:rgba(128,128,128,0.1)!important;border-color:rgba(128,128,128,0.2)!important}
.undo-redo-btn svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
.text-align-group{display:flex;gap:8px;margin-bottom:12px;padding:12px;background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:12px;border:1px solid var(--border-color-light)}
.text-align-btn{flex:1;background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);cursor:pointer;padding:10px;border-radius:10px;transition:all var(--transition-smooth);color:var(--text-color-light);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;outline:none}
.text-align-btn:hover,.text-align-btn:focus{background:rgba(255,110,65,0.15);border-color:var(--orange-main);transform:translateY(-1px)}
.text-align-btn.active{background:var(--orange-main);color:white;border-color:var(--orange-dark);box-shadow:0 4px 12px rgba(255,110,65,0.4)}
.text-align-btn svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2}
.text-align-btn span{font-size:0.7rem;font-weight:600}
.text-direction-group{display:flex;gap:8px;margin-bottom:12px}
.text-direction-btn{flex:1;background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);cursor:pointer;padding:12px;border-radius:10px;transition:all var(--transition-smooth);color:var(--text-color-light);display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.85rem;font-weight:600;outline:none}
.text-direction-btn:hover,.text-direction-btn:focus{background:rgba(255,110,65,0.15);border-color:var(--orange-main);transform:translateY(-1px)}
.text-direction-btn.active{background:var(--orange-main);color:white;border-color:var(--orange-dark);box-shadow:0 4px 12px rgba(255,110,65,0.4)}

</style><line class="st0" x1="15" y1="8" x2="23" y2="16"></line><path class="st0" d="M17,10l6-6c1.1-1.1,2.9-1.1,4,0l0,0c1.1,1.1,1.1,2.9,0,4l-6,6"></path><path class="st0" d="M16.7,10.3l-11,11c-0.6,0.6-0.8,1.3-0.8,2.1C4.4,23.7,4,24.3,4,25c0,1.1,0.9,2,2,2c0.7,0,1.3-0.4,1.7-0.9 c0.7,0,1.5-0.3,2.1-0.8l11-11"></path></g></svg>
</div>
</div>
</div>
</main>
<footer class="footer-controls" role="contentinfo">
<nav class="control-icons" role="navigation" aria-label="Main controls">
<button class="control-icon" data-panel="text" aria-label="Text settings" aria-describedby="text-control-desc">
<svg 
  xmlns="http://www.w3.org/2000/svg" 
  viewBox="0 0 24 24" 
  fill="none" 
  stroke="currentColor" 
  stroke-width="1.5" 
  stroke-linecap="round" 
  stroke-linejoin="round"
>
  <path d="M12 3H8C6.114 3 5.172 3 4.586 3.586C4 4.172 4 5.114 4 7V7.95M12 3H16C17.886 3 18.828 3 19.414 3.586C20 4.172 20 5.114 20 7V7.95M12 3V21"/>
  <path d="M7 21H17"/>
</svg>
<span id="text-control-desc" data-en="Text" data-fa="متن" data-ar="نص">Text</span>
</button>
<button class="control-icon" data-panel="color" aria-label="Color settings" aria-describedby="color-control-desc">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="theme-icon">
  <g id="SVGRepo_iconCarrier">
    <g id="ic-editor-color">
      <line x1="8" y1="3" x2="18" y2="13"
            fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M9,4,2.41,10.59a2,2,0,0,0,0,2.82l5.22,5.22a2,2,0,0,0,2.78,0l6.83-6.43"
            fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="1.83" y1="12" x2="17" y2="12"
            fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="6" y1="12" x2="6" y2="17"
            fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="9" y1="12" x2="9" y2="19.21"
            fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="12" y1="12" x2="12" y2="17.17"
            fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M19.26,22.41h.54a2.54,2.54,0,0,0,1.89-3.75l-1.88-3.5a.32.32,0,0,0-.55,0l-1.89,3.5A2.54,2.54,0,0,0,19.26,22.41Z"
            fill="none" stroke="currentColor" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="bevel"/>
    </g>
  </g>
</svg>
<span id="color-control-desc" data-en="Color" data-fa="رنگ" data-ar="لون">Color</span>
</button>
<button class="control-icon" data-panel="background" aria-label="Background settings" aria-describedby="bg-control-desc">
<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="theme-icon">
  <g id="SVGRepo_iconCarrier">
    <path 
      d="M11.25 17C11.25 17.4142 11.5858 17.75 12 17.75C12.4142 17.75 12.75 17.4142 12.75 17H11.25ZM15.25 9.75C15.25 10.1642 15.5858 10.5 16 10.5C16.4142 10.5 16.75 10.1642 16.75 9.75H15.25ZM7.25 9.75C7.25 10.1642 7.58579 10.5 8 10.5C8.41421 10.5 8.75 10.1642 8.75 9.75H7.25ZM15.7071 7.32544L16.2646 6.82371V6.82371L15.7071 7.32544ZM9.5 16.25C9.08579 16.25 8.75 16.5858 8.75 17C8.75 17.4142 9.08579 17.75 9.5 17.75V16.25ZM15 17.75C15.4142 17.75 15.75 17.4142 15.75 17C15.75 16.5858 15.4142 16.25 15 16.25V17.75ZM10 7.75H12V6.25H10V7.75ZM12 7.75H14V6.25H12V7.75ZM12.75 17V7H11.25V17H12.75ZM15.25 9.22222V9.75H16.75V9.22222H15.25ZM7.25 9.22222V9.75H8.75V9.22222H7.25ZM14 7.75C14.4949 7.75 14.7824 7.75196 14.9865 7.78245C15.0783 7.79617 15.121 7.8118 15.1376 7.8194C15.148 7.82415 15.1477 7.82503 15.1496 7.82716L16.2646 6.82371C15.96 6.4853 15.579 6.35432 15.2081 6.29891C14.8676 6.24804 14.4479 6.25 14 6.25V7.75ZM16.75 9.22222C16.75 8.71757 16.7513 8.27109 16.708 7.91294C16.6629 7.54061 16.559 7.15082 16.2646 6.82371L15.1496 7.82716C15.1523 7.83015 15.1609 7.83939 15.1731 7.87221C15.1873 7.91048 15.2048 7.97725 15.2188 8.09313C15.2487 8.34011 15.25 8.67931 15.25 9.22222H16.75ZM10 6.25C9.55208 6.25 9.13244 6.24804 8.79192 6.29891C8.42102 6.35432 8.04 6.4853 7.73542 6.82371L8.85036 7.82716C8.85228 7.82503 8.85204 7.82415 8.86242 7.8194C8.87904 7.8118 8.92168 7.79617 9.01354 7.78245C9.21765 7.75196 9.50511 7.75 10 7.75V6.25ZM8.75 9.22222C8.75 8.67931 8.75129 8.34011 8.78118 8.09313C8.7952 7.97725 8.81273 7.91048 8.8269 7.87221C8.83905 7.83939 8.84767 7.83015 8.85036 7.82716L7.73542 6.82371C7.44103 7.15082 7.3371 7.54061 7.29204 7.91294C7.24871 8.27109 7.25 8.71757 7.25 9.22222H8.75ZM9.5 17.75H15V16.25H9.5V17.75Z" 
      fill="currentColor"/>
    <path 
      d="M2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2C16.714 2 19.0711 2 20.5355 3.46447C22 4.92893 22 7.28595 22 12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12Z" 
      stroke="currentColor" 
      stroke-width="1.5"/>
  </g>
</svg>
<span id="bg-control-desc" data-en="Background" data-fa="بک گراند" data-ar="خلف��ة">Background</span>
</button>
<button class="control-icon" data-panel="effects" aria-label="Effects settings" aria-describedby="effects-control-desc">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
</svg>
<span id="effects-control-desc" data-en="Effects" data-fa="افکت" data-ar="تأثيرات">Effects</span>
</button>
</nav>
</footer>

<!-- Layer Panel Overlay -->
<div id="layerPanelOverlay" class="layer-panel-overlay"></div>

<!-- Layer Management Panel - Modern Side Panel -->
<div id="layersPanel" class="layer-panel" role="dialog" aria-labelledby="layer-panel-title">
<div class="panel-header">
<button class="collapse-btn" id="layerCollapseBtn" aria-label="Collapse panel">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
<polyline points="9 18 15 12 9 6"></polyline>
</svg>
</button>
<span id="layer-panel-title" data-en="Layers" data-fa="لایه‌ها" data-ar="الطبقات">Layers</span>
<button class="close-panel" data-close="layers" aria-label="Close layer panel">×</button>
</div>
<div class="panel-content">
<div class="layer-list" id="layerList" role="list">
    <div class="layer-drop-indicator" id="layerDropIndicator"></div>
</div>
</div>
</div>
<div id="textPanel" class="accordion-panel" role="dialog" aria-labelledby="text-panel-title">
<div class="panel-header">
<span id="text-panel-title" data-en="Text Settings" data-fa="تنظیمات متن" data-ar="إعدادات النص">Text Settings</span>
<button class="close-panel" data-close="text" aria-label="Close text panel">×</button>
</div>
<div class="panel-content">
<div class="font-panels-container" id="fontPanelsContainer" role="group" aria-label="Text panels">
</div>
<button class="add-font-panel-btn" id="addFontPanelBtn" aria-describedby="add-text-desc">
<span aria-hidden="true">+</span>
<span id="add-text-desc" data-en="Add new text" data-fa="اضافه کردن متن جدید" data-ar="إضافة نص جديد">Add new text</span>
</button>
<div class="font-add-group">
<label for="fontSelector" data-en="Font:" data-fa="فونت:" data-ar="الخط:">Font:</label>
<select id="fontSelector" aria-label="Select font family">
<option value="Vazirmatn" selected>Vazirmatn</option>
<option value="Lalezar">Lalezar</option>
<option value="Amiri">Amiri</option>
<option value="Markazi Text">Markazi Text</option>
<option value="Noto Naskh Arabic">Noto Naskh Arabic</option>
</select>
<label for="fontInput" class="add-font-btn" aria-label="Upload custom font">+</label>
<input type="file" id="fontInput" accept=".ttf,.otf" aria-label="Upload custom font file">
</div>
<div class="text-align-group" role="group" aria-label="Text alignment">
<button class="text-align-btn active" id="alignLeftBtn" data-align="left" aria-label="Align text left">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
<line x1="17" y1="10" x2="3" y2="10"/>
<line x1="21" y1="6" x2="3" y2="6"/>
<line x1="21" y1="14" x2="3" y2="14"/>
<line x1="17" y1="18" x2="3" y2="18"/>
</svg>
</button>
<button class="text-align-btn" id="alignCenterBtn" data-align="center" aria-label="Align text center">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
<line x1="18" y1="10" x2="6" y2="10"/>
<line x1="21" y1="6" x2="3" y2="6"/>
<line x1="21" y1="14" x2="3" y2="14"/>
<line x1="18" y1="18" x2="6" y2="18"/>
</svg>
</button>
<button class="text-align-btn" id="alignRightBtn" data-align="right" aria-label="Align text right">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
<line x1="21" y1="10" x2="7" y2="10"/>
<line x1="21" y1="6" x2="3" y2="6"/>
<line x1="21" y1="14" x2="3" y2="14"/>
<line x1="21" y1="18" x2="7" y2="18"/>
</svg>
</button>
</div>

<div class="slider-group">
<label for="fontSizeSlider" data-en="Size:" data-fa="سایز:" data-ar="الحجم:">Size:</label>
<input type="range" id="fontSizeSlider" min="10" max="500" value="50" aria-label="Font size">
<span id="fontSizeValue" class="slider-value" aria-live="polite">50</span>
</div>

<div class="slider-group">
<label for="letterSpacingSlider" data-en="Spacing:" data-fa="فاصله حروف:" data-ar="تباعد الحروف:">Letter Spacing:</label>
<input type="range" id="letterSpacingSlider" min="0" max="50" value="0" step="1" aria-label="Letter spacing">
<span id="letterSpacingValue" class="slider-value" aria-live="polite">0</span>
</div>

<div class="slider-group">
<label for="lineHeightSlider" data-en="Line Height:" data-fa="فاصله خطوط:" data-ar="ارتفاع الخط:">Line Height:</label>
<input type="range" id="lineHeightSlider" min="0.5" max="3" value="1.2" step="0.1" aria-label="Line height">
<span id="lineHeightValue" class="slider-value" aria-live="polite">1.2</span>
</div>
</div>
</div>
<div id="colorPanel" class="accordion-panel" role="dialog" aria-labelledby="color-panel-title">
<div class="panel-header">
<span id="color-panel-title" data-en="Text Color" data-fa="رنگ متن" data-ar="لون النص">Text Color</span>
<button class="close-panel" data-close="color" aria-label="Close color panel">×</button>
</div>
<div class="panel-content">
<div class="color-tools-container">
    <div class="color-tool-card" id="colorPickerTool">
        <button class="color-tool-btn" id="colorPickerBtn" aria-label="Activate color picker tool" tabindex="0">
            <svg version="1.1" id="Icons_btn" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve" fill="#ffffff" stroke="#ffffff">
                <g id="SVGRepo_bgCarrier_btn" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier_btn" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier_btn">
                    <style >.st0{fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;}.undo-redo-bar{position:fixed;top:calc(var(--header-height) + var(--safe-area-top));left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;gap:8px;background:var(--panel-bg-light);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));border:1px solid var(--border-color-light);border-top:none;border-radius:0 0 16px 16px;padding:8px 20px;z-index:1999;box-shadow:0 4px 15px var(--shadow-color);transition:all var(--transition-smooth)}
.undo-redo-btn{background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);cursor:pointer;padding:8px 16px;border-radius:12px;transition:all var(--transition-smooth);color:var(--text-color-light);display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.85rem;font-weight:600;min-width:85px;outline:none}
.undo-redo-btn:hover,.undo-redo-btn:focus{background:rgba(255,110,65,0.2);border-color:var(--orange-main);transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,110,65,0.3)}
.undo-redo-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none!important;background:rgba(128,128,128,0.1)!important;border-color:rgba(128,128,128,0.2)!important}
.undo-redo-btn svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2}
.text-align-group{display:flex;gap:8px;margin-bottom:4px;padding:12px;background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:12px;border:1px solid var(--border-color-light)}
.text-align-btn{flex:1;background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);cursor:pointer;padding:10px;border-radius:10px;transition:all var(--transition-smooth);color:var(--text-color-light);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;outline:none}
.text-align-btn:hover,.text-align-btn:focus{background:rgba(255,110,65,0.15);border-color:var(--orange-main);transform:translateY(-1px)}
.text-align-btn.active{background:var(--orange-main);color:white;border-color:var(--orange-dark);box-shadow:0 4px 12px rgba(255,110,65,0.4)}
.text-align-btn svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2}
.text-align-btn span{font-size:0.7rem;font-weight:600}
.text-direction-group{display:flex;gap:8px;margin-bottom:12px}
.text-direction-btn{flex:1;background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color-light);cursor:pointer;padding:12px;border-radius:10px;transition:all var(--transition-smooth);color:var(--text-color-light);display:flex;align-items:center;justify-content:center;gap:6px;font-size:0.85rem;font-weight:600;outline:none}
.text-direction-btn:hover,.text-direction-btn:focus{background:rgba(255,110,65,0.15);border-color:var(--orange-main);transform:translateY(-1px)}
.text-direction-btn.active{background:var(--orange-main);color:white;border-color:var(--orange-dark);box-shadow:0 4px 12px rgba(255,110,65,0.4)}
body[data-lang="fa"] .hamburger-panel,
body[data-lang="ar"] .hamburger-panel {
    left: auto;
    right: -300px;
    border-right: none;
    border-left: 1px solid var(--border-color-light);
}

body[data-lang="fa"] .hamburger-panel.active,
body[data-lang="ar"] .hamburger-panel.active {
    left: auto;
    right: 0; /* Slide in from the right */
}
.footer-controls [data-panel="layers"] {
    display: none;
}


</style>
                    <line class="st0" x1="15" y1="8" x2="23" y2="16"></line>
                    <path class="st0" d="M17,10l6-6c1.1-1.1,2.9-1.1,4,0l0,0c1.1,1.1,1.1,2.9,0,4l-6,6"></path>
                    <path class="st0" d="M16.7,10.3l-11,11c-0.6,0.6-0.8,1.3-0.8,2.1C4.4,23.7,4,24.3,4,25c0,1.1,0.9,2,2,2c0.7,0,1.3-0.4,1.7-0.9 c0.7,0,1.5-0.3,2.1-0.8l11-11"></path>
                </g>
            </svg>
        </button>
        <div class="color-picker-info">
            <div class="color-picker-title" data-en="Pick from Image" data-fa="انتخاب از عکس" data-ar="اختر من الصورة">Pick from Image</div>
            <div class="color-picker-desc" data-en="Tap to activate eyedropper" data-fa="برای فعال‌سازی قطره‌چکان ضربه بزنید" data-ar="اضغط لتفعيل أداة القطارة">Tap to activate eyedropper</div>
        </div>
        <div class="color-picker-preview" id="colorPickerPreview"></div>
    </div>
    <div class="color-tool-card" id="colorWheelTool">
        <button class="color-tool-btn" id="colorWheelBtn" aria-label="Open professional color wheel picker" tabindex="0">
            <svg fill="currentColor" height="32px" width="32px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 487.15 487.15" xml:space="preserve">
                <path d="M243.575,0C109.265,0,0,109.265,0,243.576C0,377.885,109.265,487.15,243.575,487.15S487.15,377.885,487.15,243.576 C487.15,109.265,377.885,0,243.575,0z M243.575,363.927c-66.361,0-120.352-53.991-120.352-120.352 c0-66.361,53.991-120.352,120.352-120.352c66.362,0,120.352,53.99,120.352,120.352C363.927,309.936,309.937,363.927,243.575,363.927 z M336.489,137.345c-22.398-19.615-51.027-32.279-82.489-34.587V21.103c53.924,2.498,102.897,24.262,140.187,58.552L336.489,137.345 z M233.149,102.758c-31.464,2.308-60.094,14.974-82.493,34.591L92.962,79.656c37.29-34.291,86.264-56.055,140.187-58.553V102.758z M136.021,152.199c-19.15,22.506-31.374,51.071-33.353,82.376H21.048c2.148-53.763,23.436-102.684,57.235-140.113L136.021,152.199z M102.874,255.426c2.581,30.9,15.152,59.004,34.47,81.062L79.65,394.183c-33.986-36.961-55.671-85.397-58.483-138.757H102.874z M152.194,351.125c22.165,18.862,50.207,31.013,80.956,33.268v81.654c-53.205-2.465-101.594-23.683-138.693-57.186L152.194,351.125z M254,384.393c30.747-2.255,58.786-14.403,80.951-33.263l57.737,57.736c-37.099,33.5-85.485,54.717-138.689,57.181V384.393z M349.801,336.494c19.321-22.06,31.895-50.166,34.475-81.068h81.706c-2.812,53.361-24.499,101.801-58.488,138.762L349.801,336.494z M384.483,234.574c-1.98-31.307-14.206-59.874-33.358-82.381l57.741-57.732c33.799,37.43,55.087,86.351,57.235,140.113H384.483z"></path>
            </svg>
        </button>
        <div class="color-picker-info">
            <div class="color-picker-title" data-en="Professional Color Wheel" data-fa="چرخ رنگ حرفه‌ای" data-ar="عجلة الألوان المتقدمة">Professional Color Wheel</div>
            <div class="color-picker-desc" data-en="Advanced HSL color selection" data-fa="انتخاب رنگ پیشرفته HSL" data-ar="اختيار ألوان HSL متقدم">Advanced HSL color selection</div>
        </div>
    </div>
</div>

<div class="color-grid" id="textColorGrid" role="group" aria-label="Text color options">
</div>
<div class="slider-group">
<label for="opacitySlider" data-en="Opacity:" data-fa="شفافیت:" data-ar="الشفافية:">Opacity:</label>
<input type="range" id="opacitySlider" min="0" max="100" value="100" aria-label="Text opacity">
<span id="opacityValue" class="slider-value" aria-live="polite">100%</span>
</div>
</div>
</div>
<div id="backgroundPanel" class="accordion-panel" role="dialog" aria-labelledby="bg-panel-title">
<div class="panel-header">
<span id="bg-panel-title" data-en="Text Background" data-fa="پس زمینه متن" data-ar="خلفية النص">Text Background</span>
<button class="close-panel" data-close="background" aria-label="Close background panel">×</button>
</div>
<div class="panel-content">
<div class="color-grid" id="bgColorGrid" role="group" aria-label="Background color options">
</div>
<div class="slider-group">
<label for="backdropOpacitySlider" data-en="Background:" data-fa="پس‌زمینه:" data-ar="الخلفية:">Background:</label>
<input type="range" id="backdropOpacitySlider" min="0" max="100" value="0" aria-label="Background opacity">
<span id="backdropOpacityValue" class="slider-value" aria-live="polite">0%</span>
</div>
<div class="slider-group">
<label for="backdropRadiusSlider" data-en="Radius:" data-fa="گردی:" data-ar="الزاوية:">Radius:</label>
<input type="range" id="backdropRadiusSlider" min="0" max="100" value="0" aria-label="Background border radius">
<span id="backdropRadiusValue" class="slider-value" aria-live="polite">0</span>
</div>
<div class="slider-group">
<label for="backdropWidthSlider" data-en="Width:" data-fa="پهنا:" data-ar="العرض:">Width:</label>
<input type="range" id="backdropWidthSlider" min="0" max="100" value="0" aria-label="Background width padding">
<span id="backdropWidthValue" class="slider-value" aria-live="polite">0</span>
</div>
<div class="slider-group">
<label for="backdropHeightSlider" data-en="Height:" data-fa="ارتفاع:" data-ar="الارتفاع:">Height:</label>
<input type="range" id="backdropHeightSlider" min="0" max="100" value="0" aria-label="Background height padding">
<span id="backdropHeightValue" class="slider-value" aria-live="polite">0</span>
</div>
</div>
</div>
<div id="effectsPanel" class="accordion-panel" role="dialog" aria-labelledby="effects-panel-title">
<div class="panel-header">
<span id="effects-panel-title" data-en="Effects" data-fa="افکت‌ها" data-ar="التأثيرات">Effects</span>
<button class="close-panel" data-close="effects" aria-label="Close effects panel">×</button>
</div>
<div class="panel-content">
    <div class="slider-group">
        <label for="strokeSlider" data-en="Stroke:" data-fa="حاشیه:" data-ar="الحد:">Stroke:</label>
        <input type="range" id="strokeSlider" min="0" max="100" value="0" aria-label="Text stroke width">
        <span id="strokeValue" class="slider-value" aria-live="polite">0</span>
    </div>
    <div class="slider-group" style="opacity: 0.5; pointer-events: none;">
        <label for="shadowSlider" data-en="Shadow:" data-fa="سایه:" data-ar="الظل:">Shadow:</label>
        <input type="range" id="shadowSlider" min="0" max="10" value="0" aria-label="Text shadow intensity" disabled>
        <span id="shadowValue" class="slider-value" aria-live="polite">0</span>
    </div>
    <div class="slider-group">
        <label for="glowSlider" data-en="Glow:" data-fa="درخشش:" data-ar="التوهج:">Glow:</label>
        <input type="range" id="glowSlider" min="0" max="10" value="0" aria-label="Text glow effect">
        <span id="glowValue" class="slider-value" aria-live="polite">0</span>
    </div>
</div>

</div>
</div>
</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
'use strict';
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

class ServiceWorkerManager{static async register(){if(!('serviceWorker' in navigator))return false;try{const swCode=`const CACHE_NAME='daco- -pro-v5.2';const urlsToCache=['/'];self.addEventListener('install',event=>{event.waitUntil(caches.open(CACHE_NAME).then(cache=>cache.addAll(urlsToCache)).catch(err=>console.warn('SW Cache failed:',err)));self.skipWaiting()});self.addEventListener('fetch',event=>{event.respondWith(caches.match(event.request).then(response=>response||fetch(event.request)).catch(()=>new Response('Offline')))});self.addEventListener('activate',event=>{event.waitUntil(caches.keys().then(cacheNames=>Promise.all(cacheNames.filter(cacheName=>cacheName!==CACHE_NAME).map(cacheName=>caches.delete(cacheName)))))});`;const blob=new Blob([swCode],{type:'application/javascript'});const swUrl=URL.createObjectURL(blob);const registration=await navigator.serviceWorker.register(swUrl);URL.revokeObjectURL(swUrl);return true}catch(error){return false}}}

// Enhanced PWA Add to Home Screen Manager
class PWAInstallManager{constructor(){this.promptEvent=null;this.isInstalled=false;this.hasShownPrompt=false;this.installTimeout=null;this.setupBeforeInstallPrompt();this.checkInstallStatus()}setupBeforeInstallPrompt(){window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();this.promptEvent=e;console.log('PWA install prompt ready')});window.addEventListener('appinstalled',()=>{this.isInstalled=true;this.hidePrompt();console.log('PWA installed successfully')})}checkInstallStatus(){this.isInstalled=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone||document.referrer.includes('android-app://')}showPromptIfNeeded(){if(!this.isInstalled&&!this.hasShownPrompt){const promptElement=document.getElementById('pwaInstallPrompt');if(promptElement){console.log('Showing PWA install prompt');promptElement.classList.add('active');this.hasShownPrompt=true;this.setupPromptEvents(promptElement);this.installTimeout=setTimeout(()=>{this.hidePrompt()},15000)}}}setupPromptEvents(promptElement){const closeBtn=document.getElementById('pwaInstallClose');const promptContent=promptElement.querySelector('.pwa-install-content');if(closeBtn){closeBtn.addEventListener('click',(e)=>{e.stopPropagation();this.hidePrompt()})}if(promptContent){promptContent.addEventListener('click',()=>{this.triggerInstall()})}}async triggerInstall(){if(this.promptEvent){try{console.log('Triggering PWA install...');const result=await this.promptEvent.prompt();console.log('Install prompt result:',result);if(result.outcome==='accepted'){this.isInstalled=true;console.log('User accepted PWA install')}else{console.log('User dismissed PWA install')}this.hidePrompt()}catch(error){console.warn('PWA install failed:',error);this.hidePrompt()}}else{console.log('No install prompt available - opening install instructions');this.showManualInstallInstructions()}}showManualInstallInstructions(){const lang=document.body.getAttribute('data-lang')||'en';const instructions={en:'To install this app: Open browser menu → "Add to Home Screen" or "Install App"',fa:'برای نصب این اپ: منوی مرورگر → "افزودن به صفحه اصلی" یا "نصب اپ"',ar:'لتثبيت هذا التطبيق: قائمة المتصفح ← "إضافة إلى الشاشة ا��رئيسية" أو "تثب��ت التطبيق"'};if(typeof showAlert==='function'){showAlert(instructions[lang]||instructions.en)}}hidePrompt(){const promptElement=document.getElementById('pwaInstallPrompt');if(promptElement){promptElement.classList.remove('active')}if(this.installTimeout){clearTimeout(this.installTimeout);this.installTimeout=null}}}

class MemoryManager{
    constructor(){
        this.blobUrls=new Set();
        this.eventListeners=new Map();
        this.globalListeners=[];
        this.errors=[];
        this.maxErrors=10
    }
    createBlobUrl(blob){
        try{
            const url=URL.createObjectURL(blob);
            this.blobUrls.add(url);
            return url
        }catch(error){
            this.logError('BLOB_URL_CREATION_ERROR',error);
            return null
        }
    }
    revokeBlobUrl(url){
        if(this.blobUrls.has(url)){
            try{
                URL.revokeObjectURL(url);
                this.blobUrls.delete(url)
            }catch(error){
                this.logError('BLOB_URL_REVOKE_ERROR',error)
            }
        }
    }
    addEventListener(element,event,handler,options={}){
        if(!element||typeof handler!=='function')return false;
        try{
            element.addEventListener(event,handler,options);
            if(!this.eventListeners.has(element)){
                this.eventListeners.set(element,[])
            }
            this.eventListeners.get(element).push({event,handler,options});
            if(element===window||element===document){
                this.globalListeners.push({element,event,handler})
            }
            return true
        }catch(error){
            this.logError('EVENT_LISTENER_ERROR',error);
            return false
        }
    }

    removeEventListener(element, event, handler) {
        if (!element || !this.eventListeners.has(element)) return;

        try {
            element.removeEventListener(event, handler);
            
            const listeners = this.eventListeners.get(element);
            const index = listeners.findIndex(
                (listener) => listener.event === event && listener.handler === handler
            );

            if (index > -1) {
                listeners.splice(index, 1);
            }
            
            if (listeners.length === 0) {
                this.eventListeners.delete(element);
            }
        } catch (error) {
            this.logError('EVENT_REMOVE_ERROR', error);
        }
    }

    cleanupElement(element) {
        if (!element || !this.eventListeners.has(element)) return;

        const listeners = this.eventListeners.get(element);
        
        listeners.forEach(({ event, handler }) => {
            try {
                element.removeEventListener(event, handler);
            } catch (e) {
                this.logError('CLEANUP_REMOVE_ERROR', e);
            }
        });

        this.eventListeners.delete(element);
    }
    
    logError(type,error){
        const errorEntry={type,message:error?.message||error,timestamp:Date.now(),stack:error?.stack};
        this.errors.push(errorEntry);
        if(this.errors.length>this.maxErrors){
            this.errors.shift()
        }
    }
    cleanup(){
        try{
            this.blobUrls.forEach(url=>{
                try{URL.revokeObjectURL(url)}catch(e){}
            });
            this.blobUrls.clear();
            this.eventListeners.forEach((listeners,element)=>{
                listeners.forEach(({event,handler})=>{
                    try{element.removeEventListener(event,handler)}catch(e){}
                })
            });
            this.eventListeners.clear();
            this.globalListeners.forEach(({element,event,handler})=>{
                try{element.removeEventListener(event,handler)}catch(e){}
            });
            this.globalListeners=[]
        }catch(error){
        }
    }
    getMemoryUsage(){
        return{
            blobUrls:this.blobUrls.size,
            eventListeners:this.eventListeners.size,
            globalListeners:this.globalListeners.length,
            errors:this.errors.length
        }
    }
}

class ErrorBoundary{constructor(memoryManager){this.memoryManager=memoryManager;this.setupGlobalErrorHandling()}setupGlobalErrorHandling(){const handleError=(event)=>{this.handleError(event.error||event.reason||new Error('Unknown error'))};const handlePromiseRejection=(event)=>{this.handleError(event.reason||new Error('Unhandled promise rejection'));event.preventDefault()};this.memoryManager.addEventListener(window,'error',handleError);this.memoryManager.addEventListener(window,'unhandledrejection',handlePromiseRejection)}handleError(error){this.memoryManager.logError('GLOBAL_ERROR',error);const userMessage=this.translateError(error?.message||'خطای غیرمنتظره رخ داد');if(this.isCriticalError(error)){this.showUserFriendlyError(userMessage)}}isCriticalError(error){const criticalPatterns=['memory','quota','canvas','failed to fetch','network'];const message=(error?.message||'').toLowerCase();return criticalPatterns.some(pattern=>message.includes(pattern))}translateError(message){const lang=appState?.currentLang||'en';const errorMap={'CANVAS_EMPTY':{en:'Please add an image or text first',fa:'لطفاً ابتدا تصویر یا متن اضافه کنید',ar:'يرجى إضافة صورة أو نص أولاً'},'MEMORY_ERROR':{en:'Insufficient memory, choose a smaller image',fa:'حافظه کافی نیست، تصویر کوچکتری انتخاب کنید',ar:'ذاكرة غير كافية، اختر صورة أصغر'},'QUOTA_EXCEEDED':{en:'Storage space exceeded',fa:'فضای ذخیره‌سازی تمام شده',ar:'مساحة التخزين ممتلئة'},'NETWORK_ERROR':{en:'Network connection error',fa:'خطا در اتصال به شبکه',ar:'خطأ في اتصال الشبكة'}};for(const[key,translations]of Object.entries(errorMap)){if(message.toLowerCase().includes(key.toLowerCase())){return translations[lang]||translations.en}}return{en:'An unexpected error occurred',fa:'خطای غیرمنتظره رخ داد',ar:'حدث خطأ غير متوقع'}[lang]||'An unexpected error occurred'}showUserFriendlyError(message){if(typeof showAlert==='function'){showAlert(message)}}}
class AppState{constructor(){this.img=null;this.originalImageData=null;this.textObjects=[];this.selectedTextIndex=-1;this.currentLang='en';this.currentFont='Vazirmatn';this.maxTextObjects=3;this.maxCustomFonts=3;this.customFontsCount=0;this.fontPanels=[];this.loadedCustomFonts=new Map();this.currentModal=null;this.lastFocusedElement=null;this.isDraggingText=false;this.isDraggingCanvas=false;this.isPinching=false;this.initialPinchDistance=0;this.lastFontSize=50;this.canvasTransform={x:0,y:0};this.dragStart={x:0,y:0};this.lastPointer={x:0,y:0};this.momentum={x:0,y:0};this.isAnimating=false;this.canvasBounds={left:0,top:0,right:0,bottom:0};this.lastTapTime=0;this.tapCount=0;this.doubleTapDelay=300;this.lastTouchTime=0;this.touchCount=0;this.lastCanvasTouchTime=0;this.canvasTouchCount=0;this.selectionBorderTimeout=null;this.borderFadeTimeout=null;this.borderOpacity=0.8;this.borderFadeStartTime=null;this.borderFadeDuration=500;this.isColorPickerActive=false;this.colorPickerTargetType='text'}createTextObject(text='',x=0,y=0){return{text,x,y,width:200,height:60,fontSize:50,color:'#000000',opacity:1,shadowBlur:0,strokeWidth:0,glowBlur:0,backdropColor:'#FFFFFF',backdropOpacity:0,backdropRadius:0,backdropWidthPercentage:0,backdropHeightPercentage:0,font:this.currentFont,textAlign:'center',textDirection:'ltr',letterSpacing:0,lineHeight:1.2}}resetImageState(){try{this.textObjects.forEach((textObj,index)=>{if(DOM.canvas){textObj.x=(DOM.canvas.width-textObj.width)/2;textObj.y=(DOM.canvas.height-textObj.height)/2+(index*(DOM.canvas.height*0.1));textObj.width=Math.max(200,DOM.canvas.width*0.3);textObj.height=Math.max(60,DOM.canvas.height*0.08)}})}catch(error){memoryManager.logError('IMAGE_STATE_RESET_ERROR',error)}}cleanup(){try{if(this.selectionBorderTimeout){clearTimeout(this.selectionBorderTimeout);this.selectionBorderTimeout=null}if(this.borderFadeTimeout){clearTimeout(this.borderFadeTimeout);this.borderFadeTimeout=null}this.img=null;this.originalImageData=null;this.textObjects=[];this.fontPanels=[];this.loadedCustomFonts.clear()}catch(error){}}}
class CropState{constructor(){this.reset()}reset(){this.scale=1;this.position={x:0,y:0};this.minScale=1;this.maxScale=5;this.initialScale=1;this.isDragging=false;this.isPinching=false;this.lastTouchPos={x:0,y:0};this.bounds={left:0,top:0,right:0,bottom:0};        this.originalImage = null;
        this.currentAspectRatio = 9 / 16}}
class DOMManager{constructor(){this.elements={};this.batchSelectors={};this.initializeElements()}initializeElements(){const selectors={dacoLoadingScreen:'#dacoLoadingScreen',orientationLockOverlay:'#orientation-lock-overlay',announcements:'#announcements',quickActionModal:'#quickActionModal',quickAddImage:'#quickAddImage',quickAddText:'#quickAddText',cropModal:'#cropModal',cropViewport:'#cropViewport',cropImage:'#cropImage',cropLoading:'#cropLoading',cropFrame:'#cropFrame',zoomSlider:'#zoomSlider',zoomInfo:'#zoomInfo',cropCancel:'#cropCancel',cropConfirm:'#cropConfirm',downloadModal:'#downloadModal',closeDownloadModal:'#closeDownloadModal',saveToGalleryCard:'#saveToGalleryCard',downloadTransparentCard:'#downloadTransparentCard',saveVipQualityCard:'#saveVipQualityCard',downloadHeaderBtn:'#downloadHeaderBtn',imageInput:'#imageInput',uploadImageBtn:'#uploadImageBtn',deleteImageBtn:'#deleteImageBtn',themeToggle:'#themeToggle',langSwitch:'#langSwitch',canvas:'#canvas',photoPlaceholder:'#photo-placeholder',canvasWrapper:'.canvas-wrapper',canvasContainer:'.canvas-container',verticalGuide:'.guide-line.vertical',horizontalGuide:'.guide-line.horizontal',fontInput:'#fontInput',fontSelector:'#fontSelector',fontPanelsContainer:'#fontPanelsContainer',addFontPanelBtn:'#addFontPanelBtn',fontSizeSlider:'#fontSizeSlider',fontSizeValue:'#fontSizeValue',textColorGrid:'#textColorGrid',bgColorGrid:'#bgColorGrid',opacitySlider:'#opacitySlider',opacityValue:'#opacityValue',shadowSlider:'#shadowSlider',shadowValue:'#shadowValue',strokeSlider:'#strokeSlider',strokeValue:'#strokeValue',glowSlider:'#glowSlider',glowValue:'#glowValue',backdropOpacitySlider:'#backdropOpacitySlider',backdropWidthSlider:'#backdropWidthSlider',backdropHeightSlider:'#backdropHeightSlider',backdropRadiusSlider:'#backdropRadiusSlider',backdropOpacityValue:'#backdropOpacityValue',backdropWidthValue:'#backdropWidthValue',backdropHeightValue:'#backdropHeightValue',backdropRadiusValue:'#backdropRadiusValue',letterSpacingSlider:'#letterSpacingSlider',
letterSpacingValue:'#letterSpacingValue',
lineHeightSlider:'#lineHeightSlider',
lineHeightValue:'#lineHeightValue',colorPickerBtn:'#colorPickerBtn',colorWheelBtn:'#colorWheelBtn',colorPickerCursor:'#colorPickerCursor',colorPickerPreview:'#colorPickerPreview',pwaInstallPrompt:'#pwaInstallPrompt',pwaInstallClose:'#pwaInstallClose',iosGalleryPermission:'#iosGalleryPermission',saveToGalleryTitle:'#saveToGalleryTitle'};this.batchSelectors={controlIcons:'.control-icon',accordionPanels:'.accordion-panel',closePanelBtns:'.close-panel'};this.elements={};this.validateAndAssignElements(selectors);this.validateAndAssignBatchElements()}validateAndAssignElements(selectors){const missingElements=[];for(const[key,selector]of Object.entries(selectors)){const element=document.querySelector(selector);if(element){this.elements[key]=element}else{missingElements.push({key,selector})}}}validateAndAssignBatchElements(){for(const[key,selector]of Object.entries(this.batchSelectors)){const elements=document.querySelectorAll(selector);this.elements[key]=elements}}get(elementKey){return this.elements[elementKey]||null}validateCriticalElements(){const criticalElements=['canvas','imageInput','uploadImageBtn','themeToggle','langSwitch','downloadHeaderBtn','fontSelector','fontSizeSlider','textColorGrid','bgColorGrid','controlIcons'];const missing=criticalElements.filter(key=>{const element=this.elements[key];return!element||(key==='controlIcons'&&element.length===0)});return missing.length===0}}
class PerformanceMonitor{constructor(){this.isDrawScheduled=false;this.needsFullRedraw=true;this.lastDrawnState=null;this.drawCount=0;this.lastPerformanceCheck=Date.now();this.pendingUpdates=new Set()}scheduleDraw(forceFullRedraw=false){if(forceFullRedraw)this.needsFullRedraw=true;if(!this.isDrawScheduled){this.isDrawScheduled=true;requestAnimationFrame(()=>{try{canvasRenderer.drawCanvas();this.cacheCurrentState();this.needsFullRedraw=false;this.drawCount++}catch(error){memoryManager.logError('DRAW_ERROR',error)}finally{this.isDrawScheduled=false}})}}scheduleUIUpdate(elementId,updateFunction){if(!this.pendingUpdates.has(elementId)){this.pendingUpdates.add(elementId);requestAnimationFrame(()=>{try{updateFunction()}catch(error){memoryManager.logError('UI_UPDATE_ERROR',error)}finally{this.pendingUpdates.delete(elementId)}})}}cacheCurrentState(){if(!appState?.textObjects)return;this.lastDrawnState=JSON.stringify({textObjects:appState.textObjects.map(t=>({text:t.text,x:t.x,y:t.y,fontSize:t.fontSize,color:t.color})),hasImage:!!appState.img})}getPerformanceReport(){const now=Date.now();const duration=now-this.lastPerformanceCheck;const drawsPerSecond=duration>0?(this.drawCount*1000/duration).toFixed(2):0;return{drawCount:this.drawCount,drawsPerSecond,memoryUsage:memoryManager.getMemoryUsage(),duration:duration}}reset(){this.drawCount=0;this.lastPerformanceCheck=Date.now()}}

// Enhanced Professional Undo/Redo Manager
class UndoRedoManager{
    constructor(){
        this.undoStack=[];
        this.redoStack=[];
        this.maxStackSize=50;
        this.isPerformingUndoRedo=false;
    }

    saveState(){
        if(this.isPerformingUndoRedo)return;
        try{
            const state={
                textObjects:JSON.parse(JSON.stringify(appState.textObjects)),
                selectedTextIndex:appState.selectedTextIndex,
                img:appState.img,
                timestamp:Date.now()
            };
            this.undoStack.push(state);
            if(this.undoStack.length>this.maxStackSize){
                this.undoStack.shift();
            }
            this.redoStack=[];
            this.updateButtons();
        }catch(error){
            memoryManager.logError('UNDO_SAVE_STATE_ERROR',error);
        }
    }

    undo(){
        if(this.undoStack.length===0)return;
        try{
            this.isPerformingUndoRedo=true;
            const currentState={
                textObjects:JSON.parse(JSON.stringify(appState.textObjects)),
                selectedTextIndex:appState.selectedTextIndex,
                img:appState.img,
                timestamp:Date.now()
            };
            this.redoStack.push(currentState);
            const prevState=this.undoStack.pop();
            this.restoreState(prevState);
            this.updateButtons();
            accessibilityManager.announce(appState.currentLang==='fa'?'تغییرات برگردانده شد':appState.currentLang==='ar'?'تم التراجع':'Undone');
        }catch(error){
            memoryManager.logError('UNDO_ERROR',error);
        }finally{
            this.isPerformingUndoRedo=false;
        }
    }

    redo(){
        if(this.redoStack.length===0)return;
        try{
            this.isPerformingUndoRedo=true;
            const currentState={
                textObjects:JSON.parse(JSON.stringify(appState.textObjects)),
                selectedTextIndex:appState.selectedTextIndex,
                img:appState.img,
                timestamp:Date.now()
            };
            this.undoStack.push(currentState);
            const nextState=this.redoStack.pop();
            this.restoreState(nextState);
            this.updateButtons();
            accessibilityManager.announce(appState.currentLang==='fa'?'تغییرات دوباره اعمال شد':appState.currentLang==='ar'?'تمت الإعادة':'Redone');
        }catch(error){
            memoryManager.logError('REDO_ERROR',error);
        }finally{
            this.isPerformingUndoRedo=false;
        }
    }

    restoreState(state){
        try{
            appState.textObjects=JSON.parse(JSON.stringify(state.textObjects));
            appState.selectedTextIndex=state.selectedTextIndex;
            if(textManager&&typeof textManager.syncPanelsWithState==='function'){
                textManager.syncPanelsWithState();
            }
            if(textManager&&typeof textManager.updateUIFromSelectedText==='function'){
                textManager.updateUIFromSelectedText();
            }
            performanceMonitor.scheduleDraw();
        }catch(error){
            memoryManager.logError('RESTORE_STATE_ERROR',error);
        }
    }

    updateButtons(){
        const undoBtn=document.getElementById('undoBtn');
        const redoBtn=document.getElementById('redoBtn');
        if(undoBtn){
            undoBtn.disabled=this.undoStack.length===0;
        }
        if(redoBtn){
            redoBtn.disabled=this.redoStack.length===0;
        }
    }

    clear(){
        this.undoStack=[];
        this.redoStack=[];
        this.updateButtons();
    }
}

const memoryManager=new MemoryManager();const errorBoundary=new ErrorBoundary(memoryManager);const appState=new AppState();const cropState=new CropState();const DOM=new DOMManager();const performanceMonitor=new PerformanceMonitor();const pwaInstallManager=new PWAInstallManager();
const undoRedoManager=new UndoRedoManager();

// Enhanced Professional Color Wheel Manager (Corrected Version)
class ColorWheelManager{
    constructor(){
        this.isActive=false;
        this.canvas=null;
        this.ctx=null;
        this.wheelRadius=95;
        this.centerX=0;
        this.centerY=0;
        this.selectedColor='#ff0000';
        this.selectedHue=0;
        this.selectedSaturation=1;
        this.selectedLightness=0.5;
        this.selectedRed=255;
        this.selectedGreen=0;
        this.selectedBlue=0;
        this.isDragging=false;
        this.indicator=null;
        this.colorPreview=null;
        this.hexInput=null;
        this.rgbInputs={r:null,g:null,b:null};
        this.setupColorWheel();
    }

    setupColorWheel(){
        const colorWheelBtn=DOM.get('colorWheelBtn');
        const colorWheelTool=DOM.get('colorWheelTool');
        if(colorWheelBtn){
            memoryManager.addEventListener(colorWheelBtn,'click',(e)=>{e.preventDefault();this.openColorWheel()});
            memoryManager.addEventListener(colorWheelBtn,'keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();this.openColorWheel()}});
        }
        if(colorWheelTool){
            memoryManager.addEventListener(colorWheelTool,'click',(e)=>{e.preventDefault();this.openColorWheel()});
        }
    }

    openColorWheel(){
        this.createColorWheelModal();
    }

    createColorWheelModal(){
        if(document.querySelector('.color-wheel-modal'))return;
        const modal=document.createElement('div');
        modal.className='color-wheel-modal';
        modal.setAttribute('role','dialog');
        modal.setAttribute('aria-labelledby','color-wheel-title');
        modal.setAttribute('aria-modal','true');
        const isDark=document.body.classList.contains('night-mode');
        const bgColor=isDark?'rgba(21, 46, 17, 0.95)':'rgba(255, 243, 227, 0.95)';
        const textColor=isDark?'#fff3e3':'#152e11';
        const borderColor=isDark?'rgba(255, 243, 227, 0.2)':'rgba(21, 46, 17, 0.2)';
        const wheelContainer=document.createElement('div');
        wheelContainer.className='color-wheel-container';
        wheelContainer.style.cssText=`background: ${bgColor}; border: 1px solid ${borderColor}; color: ${textColor};`;
        const title=document.createElement('h3');
        title.id='color-wheel-title';
        title.className='color-wheel-title';
        title.textContent=appState.currentLang==='fa'?'چرخ انتخاب رنگ حرفه‌ای':appState.currentLang==='ar'?'عجلة اختيار الألوان ا��متقدمة':'Professional Color Wheel';
        const canvasContainer=document.createElement('div');
        canvasContainer.className='color-wheel-canvas-container';
        this.canvas=document.createElement('canvas');
        this.canvas.width=190;
        this.canvas.height=190;
        this.canvas.className='color-wheel-canvas';
        this.ctx=this.canvas.getContext('2d',{alpha:false,willReadFrequently:false});
        this.centerX=this.canvas.width/2;
        this.centerY=this.canvas.height/2;
        this.wheelRadius=this.canvas.width/2-8;
        this.indicator=document.createElement('div');
        this.indicator.className='color-wheel-indicator';
        canvasContainer.appendChild(this.canvas);
        canvasContainer.appendChild(this.indicator);
        this.drawHighQualityColorWheel();
        const controlsSection=document.createElement('div');
        controlsSection.className='color-controls-section';
        this.colorPreview=document.createElement('div');
        this.colorPreview.className='color-preview-compact';
        this.colorPreview.style.backgroundColor=this.selectedColor;
        const hexGroup=document.createElement('div');
        hexGroup.className='color-input-group';
        const hexLabel=document.createElement('label');
        hexLabel.className='color-input-label';
        hexLabel.textContent='HEX:';
        this.hexInput=document.createElement('input');
        this.hexInput.className='color-input-field';
        this.hexInput.type='text';
        this.hexInput.value=this.selectedColor.toUpperCase();
        this.hexInput.maxLength=7;
        hexGroup.appendChild(hexLabel);
        hexGroup.appendChild(this.hexInput);
        const rgbContainer=document.createElement('div');

        // *** FIX APPLIED HERE ***
// The max value for G and B sliders was incorrectly set to 0. Corrected to 255.
const rGroup=this.createRGBSlider('R', 255, this.selectedRed);
const gGroup=this.createRGBSlider('G', 255, this.selectedGreen);
const bGroup=this.createRGBSlider('B', 255, this.selectedBlue);
        this.rgbInputs.r=rGroup.slider;
        this.rgbInputs.g=gGroup.slider;
        this.rgbInputs.b=bGroup.slider;
        rgbContainer.appendChild(rGroup.element);
        rgbContainer.appendChild(gGroup.element);
        rgbContainer.appendChild(bGroup.element);
        controlsSection.appendChild(this.colorPreview);
        controlsSection.appendChild(hexGroup);
        controlsSection.appendChild(rgbContainer);
        this.setupCanvasEvents();
        this.setupInputEvents();
        const buttonContainer=document.createElement('div');
        buttonContainer.className='color-wheel-actions';
        const cancelBtn=document.createElement('button');
        cancelBtn.className='color-wheel-btn cancel';
        cancelBtn.textContent=appState.currentLang==='fa'?'لغو':appState.currentLang==='ar'?'إلغاء':'Cancel';
        const selectBtn=document.createElement('button');
        selectBtn.className='color-wheel-btn select';
        selectBtn.textContent=appState.currentLang==='fa'?'انتخاب':appState.currentLang==='ar'?'اختيار':'Select';
        cancelBtn.addEventListener('click',()=>modal.remove());
        selectBtn.addEventListener('click',()=>{this.applySelectedColor();modal.remove()});
        buttonContainer.appendChild(cancelBtn);
        buttonContainer.appendChild(selectBtn);
        wheelContainer.appendChild(title);
        wheelContainer.appendChild(canvasContainer);
        wheelContainer.appendChild(controlsSection);
        wheelContainer.appendChild(buttonContainer);
        modal.appendChild(wheelContainer);
        document.body.appendChild(modal);
        this.updateIndicatorPosition();
        setTimeout(()=>selectBtn.focus(),100);
        const handleEscape=(e)=>{if(e.key==='Escape'){modal.remove();document.removeEventListener('keydown',handleEscape)}};
        document.addEventListener('keydown',handleEscape);
        setTimeout(()=>{modal.style.opacity='1'},10);
    }

    createRGBSlider(label,max,value){
        const group=document.createElement('div');
        group.className='color-slider-group';
        const labelEl=document.createElement('label');
        labelEl.className='color-slider-label';
        labelEl.textContent=label+':';
        const slider=document.createElement('input');
        slider.type='range';
        slider.className='color-slider';
        slider.min='0';
        slider.max=max.toString();
        slider.value=value.toString();
        const valueEl=document.createElement('span');
        valueEl.className='color-slider-value';
        valueEl.textContent=value.toString();
        slider.addEventListener('input',(e)=>{
            const val=parseInt(e.target.value);
            valueEl.textContent=val.toString();
            this.updateColorFromRGB();
        });
        group.appendChild(labelEl);
        group.appendChild(slider);
        group.appendChild(valueEl);
        return{element:group,slider:slider,value:valueEl};
    }

    setupCanvasEvents(){
        this.canvas.addEventListener('mousedown',(e)=>this.handleCanvasStart(e));
        this.canvas.addEventListener('mousemove',(e)=>this.handleCanvasMove(e));
        this.canvas.addEventListener('mouseup',()=>this.handleCanvasEnd());
        this.canvas.addEventListener('touchstart',(e)=>{e.preventDefault();this.handleCanvasStart(e.touches[0])});
        this.canvas.addEventListener('touchmove',(e)=>{e.preventDefault();this.handleCanvasMove(e.touches[0])});
        this.canvas.addEventListener('touchend',()=>this.handleCanvasEnd());
    }

    setupInputEvents(){
        this.hexInput.addEventListener('input',(e)=>{
            let value=e.target.value;
            if(!value.startsWith('#'))value='#'+value;
            if(/^#[0-9A-Fa-f]{6}$/.test(value)){
                this.selectedColor=value.toUpperCase();
                this.updateFromHex(value);
                this.updateIndicatorPosition();
            }
        });
        this.hexInput.addEventListener('blur',()=>{
            this.hexInput.value=this.selectedColor.toUpperCase();
        });
    }

    handleCanvasStart(e){this.isDragging=true;this.updateColorFromPosition(e)}
    handleCanvasMove(e){if(this.isDragging){this.updateColorFromPosition(e)}}
    handleCanvasEnd(){this.isDragging=false}

    updateColorFromPosition(e){
        const rect=this.canvas.getBoundingClientRect();
        const x=(e.clientX-rect.left)*(this.canvas.width/rect.width);
        const y=(e.clientY-rect.top)*(this.canvas.height/rect.height);
        const color=this.getColorAtPosition(x,y);
        if(color){
            this.selectedColor=color;
            const rgb=this.hexToRgb(color);
            if(rgb){
                this.selectedRed=rgb.r;
                this.selectedGreen=rgb.g;
                this.selectedBlue=rgb.b;
                this.updateAllDisplays();
                this.updateIndicatorPosition();
            }
        }
    }

    updateColorFromRGB(){
        this.selectedRed=parseInt(this.rgbInputs.r.value);
        this.selectedGreen=parseInt(this.rgbInputs.g.value);
        this.selectedBlue=parseInt(this.rgbInputs.b.value);
        this.selectedColor=this.rgbToHex(this.selectedRed,this.selectedGreen,this.selectedBlue);
        this.updateAllDisplays();
        this.updateIndicatorPosition();
    }

    updateFromHex(hex){
        const rgb=this.hexToRgb(hex);
        if(rgb){
            this.selectedRed=rgb.r;
            this.selectedGreen=rgb.g;
            this.selectedBlue=rgb.b;
            this.updateRGBSliders();
            this.updatePreview();
        }
    }

    updateAllDisplays(){
        this.updatePreview();
        this.updateHexInput();
        this.updateRGBSliders();
    }

    updatePreview(){if(this.colorPreview){this.colorPreview.style.backgroundColor=this.selectedColor}}
    updateHexInput(){if(this.hexInput){this.hexInput.value=this.selectedColor.toUpperCase()}}

    updateRGBSliders(){
        if(this.rgbInputs.r){this.rgbInputs.r.value=this.selectedRed;this.rgbInputs.r.nextElementSibling.textContent=this.selectedRed}
        if(this.rgbInputs.g){this.rgbInputs.g.value=this.selectedGreen;this.rgbInputs.g.nextElementSibling.textContent=this.selectedGreen}
        if(this.rgbInputs.b){this.rgbInputs.b.value=this.selectedBlue;this.rgbInputs.b.nextElementSibling.textContent=this.selectedBlue}
    }

    updateIndicatorPosition(){
        const hsl=this.rgbToHsl(this.selectedRed,this.selectedGreen,this.selectedBlue);
const angle = (hsl.h * Math.PI / 180) - Math.PI;
        const distance=hsl.s*this.wheelRadius;
        const x=this.centerX+Math.cos(angle)*distance;
        const y=this.centerY+Math.sin(angle)*distance;
        if(this.indicator){
            this.indicator.style.left=x+'px';
            this.indicator.style.top=y+'px';
            this.indicator.classList.add('active');
        }
    }

    drawHighQualityColorWheel(){
        if(!this.ctx)return;

        // ایجاد canvas با وضوح بالاتر برای کیفیت بهتر
        const superSampleScale = 2;
        const highResWidth = this.canvas.width * superSampleScale;
        const highResHeight = this.canvas.height * superSampleScale;
        const highResCanvas = document.createElement('canvas');
        highResCanvas.width = highResWidth;
        highResCanvas.height = highResHeight;
        const highResCtx = highResCanvas.getContext('2d', {alpha: true, willReadFrequently: false});

        const centerX = highResWidth / 2;
        const centerY = highResHeight / 2;
        const radius = (this.wheelRadius * superSampleScale);

        // رسم چرخ رنگ با gradient های شعاعی برای کیفیت بالاتر
        const segments = 360;
        const segmentAngle = (2 * Math.PI) / segments;

        for (let i = 0; i < segments; i++) {
            const startAngle = i * segmentAngle - Math.PI;
            const endAngle = (i + 1) * segmentAngle - Math.PI;
            const hue = (i / segments) * 360;

            // ایجاد gradient شعاعی از مرکز به خارج
            const gradient = highResCtx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);

            // از مرکز (سفید) تا بیرون (رنگ کامل با اشباع کامل)
            const centerColor = this.hslToRgb(hue, 0, 0.5);
            const edgeColor = this.hslToRgb(hue, 1, 0.5);

            gradient.addColorStop(0, `rgb(${centerColor.r}, ${centerColor.g}, ${centerColor.b})`);
            gradient.addColorStop(1, `rgb(${edgeColor.r}, ${edgeColor.g}, ${edgeColor.b})`);

            highResCtx.beginPath();
            highResCtx.moveTo(centerX, centerY);
            highResCtx.arc(centerX, centerY, radius, startAngle, endAngle);
            highResCtx.closePath();
            highResCtx.fillStyle = gradient;
            highResCtx.fill();
        }

        // صاف‌سازی لبه‌ها با anti-aliasing
        highResCtx.globalCompositeOperation = 'destination-in';
        const maskGradient = highResCtx.createRadialGradient(centerX, centerY, radius - 2 * superSampleScale, centerX, centerY, radius + 1 * superSampleScale);
        maskGradient.addColorStop(0, 'rgba(0,0,0,1)');
        maskGradient.addColorStop(0.9, 'rgba(0,0,0,1)');
        maskGradient.addColorStop(1, 'rgba(0,0,0,0)');
        highResCtx.fillStyle = maskGradient;
        highResCtx.fillRect(0, 0, highResWidth, highResHeight);

        // کاهش مقیاس با smoothing برای نتیجه نهایی با کیفیت بالا
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.imageSmoothingEnabled = true;
        this.ctx.imageSmoothingQuality = 'high';
        this.ctx.drawImage(highResCanvas, 0, 0, this.canvas.width, this.canvas.height);
    }

    hslToRgb(h,s,l){
        h/=360;
        const c=(1-Math.abs(2*l-1))*s;
        const x=c*(1-Math.abs((h*6)%2-1));
        const m=l-c/2;
        let r,g,b;
        if(h<1/6){r=c;g=x;b=0}
        else if(h<2/6){r=x;g=c;b=0}
        else if(h<3/6){r=0;g=c;b=x}
        else if(h<4/6){r=0;g=x;b=c}
        else if(h<5/6){r=x;g=0;b=c}
        else{r=c;g=0;b=x}
        return{r:Math.round((r+m)*255),g:Math.round((g+m)*255),b:Math.round((b+m)*255)};
    }

    rgbToHsl(r,g,b){
        r/=255;g/=255;b/=255;
        const max=Math.max(r,g,b);
        const min=Math.min(r,g,b);
        let h,s,l=(max+min)/2;
        if(max===min){h=s=0}
        else{
            const d=max-min;
            s=l>0.5?d/(2-max-min):d/(max+min);
            switch(max){
                case r:h=(g-b)/d+(g<b?6:0);break;
                case g:h=(b-r)/d+2;break;
                case b:h=(r-g)/d+4;break;
            }
            h/=6;
        }
        return{h:h*360,s:s,l:l};
    }

    getColorAtPosition(x,y){
        const dx=x-this.centerX;
        const dy=y-this.centerY;
        const distance=Math.sqrt(dx*dx+dy*dy);
        if(distance>this.wheelRadius)return null;
        const angle=Math.atan2(dy,dx);
        const hue=((angle+Math.PI)/(2*Math.PI))*360;
        const saturation=distance/this.wheelRadius;
        const lightness=0.5;
        const rgb=this.hslToRgb(hue,saturation,lightness);
        return this.rgbToHex(rgb.r,rgb.g,rgb.b);
    }

    hexToRgb(hex){
        const result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result?{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}:null;
    }

    rgbToHex(r,g,b){
        return"#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1).toUpperCase();
    }

    applySelectedColor(){
    if(appState.selectedTextIndex>=0&&appState.textObjects[appState.selectedTextIndex]){
        undoRedoManager.saveState();
        const colorPanel=document.getElementById('colorPanel');
        const backgroundPanel=document.getElementById('backgroundPanel');
        let targetType='text';
        if(backgroundPanel&&backgroundPanel.classList.contains('active')){targetType='background'}
        const textObj=appState.textObjects[appState.selectedTextIndex];
        if(targetType==='background'){
            textObj.backdropColor=this.selectedColor;
            this.updateColorGridSelection('bgColorGrid',this.selectedColor);
        }else{
            textObj.color=this.selectedColor;
            this.updateColorGridSelection('textColorGrid',this.selectedColor);
        }
        const colorPreview=DOM.get('colorPickerPreview');
        if(colorPreview){colorPreview.style.backgroundColor=this.selectedColor}

        const colorPickerBtn = DOM.get('colorPickerBtn');
        const colorWheelBtn = DOM.get('colorWheelBtn');
        if(colorPickerBtn) colorPickerBtn.style.borderColor = this.selectedColor;
        if(colorWheelBtn) colorWheelBtn.style.borderColor = this.selectedColor;

performanceMonitor.scheduleDraw();
        accessibilityManager.announce(`Color ${this.selectedColor} selected`);
    }
}


    updateColorGridSelection(gridId,color){
        try{
            const colorGrid=DOM.get(gridId);
            if(!colorGrid)return;
            colorGrid.querySelectorAll('.color-grid-swatch').forEach(swatch=>{
                const isActive=swatch.dataset.color.toLowerCase()===color.toLowerCase();
                swatch.classList.toggle('active',isActive);
            });
        }catch(error){
            memoryManager.logError('COLOR_GRID_UPDATE_ERROR',error);
        }
    }
}

class ColorPickerManager{constructor(){this.isActive=false;this.cursorElement=null;this.previewElement=null;this.btnElement=null;this.magnifierElement=null;this.magnifierCanvas=null;this.magnifierCtx=null;this.colorInfoElement=null;this.targetType='text';this.imageDataCache=null;this.lastPickedColor='#000000';this.cachedRects=new Map();this.zoomLevel=8;this.setupElements()}updateCursorPosition(clientX,clientY){if(!this.cursorElement)return;try{const canvasWrapper=DOM.get('canvasWrapper');if(!canvasWrapper)return;const rect=canvasWrapper.getBoundingClientRect();const cursorSize=32;const x=clientX-rect.left;const y=clientY-rect.top-cursorSize;const constrainedX=Math.max(0,Math.min(x,rect.width-cursorSize));const constrainedY=Math.max(0,Math.min(y,rect.height-cursorSize));this.cursorElement.style.position='absolute';this.cursorElement.style.left='0px';this.cursorElement.style.top='0px';this.cursorElement.style.transform=`translate(${constrainedX}px, ${constrainedY}px)`;this.cursorElement.style.zIndex='20';this.cursorElement.style.willChange='transform';if(this.magnifierElement){const magnifierSize=120;const magnifierX=clientX-rect.left;const magnifierY=clientY-rect.top-magnifierSize-60;const magnifierConstrainedX=Math.max(magnifierSize/2,Math.min(magnifierX,rect.width-magnifierSize/2));const magnifierConstrainedY=Math.max(magnifierSize/2,Math.min(magnifierY,rect.height-magnifierSize/2));this.magnifierElement.style.position='absolute';this.magnifierElement.style.left='0px';this.magnifierElement.style.top='0px';this.magnifierElement.style.transform=`translate(${magnifierConstrainedX}px, ${magnifierConstrainedY}px)`;this.magnifierElement.style.willChange='transform'}}catch(error){memoryManager.logError('CURSOR_POSITION_ERROR',error)}}activateColorPicker(){try{this.isActive=true;appState.isColorPickerActive=true;if(this.cursorElement){this.cursorElement.style.transform='translate(0px, 0px)';this.cursorElement.classList.add('active')}if(this.magnifierElement){this.magnifierElement.classList.add('active')}if(this.btnElement){this.btnElement.classList.add('active');this.btnElement.setAttribute('aria-pressed','true')}const canvasWrapper=DOM.get('canvasWrapper');if(canvasWrapper){canvasWrapper.classList.add('color-picking')}this.cacheImageData();this.cachedRects.clear();this.setupColorPickingEvents();accessibilityManager.announce(appState.currentLang==='fa'?'انتخابگر رنگ فعال شد':appState.currentLang==='ar'?'تم تفعيل منتقي الألوان':'Color picker activated')}catch(error){memoryManager.logError('COLOR_PICKER_ACTIVATE_ERROR',error);this.deactivateColorPicker()}}deactivateColorPicker(){try{this.isActive=false;appState.isColorPickerActive=false;if(this.cursorElement){this.cursorElement.classList.remove('active');this.cursorElement.style.transform='translate(0px, 0px)'}if(this.magnifierElement){this.magnifierElement.classList.remove('active')}if(this.btnElement){this.btnElement.classList.remove('active');this.btnElement.setAttribute('aria-pressed','false')}const canvasWrapper=DOM.get('canvasWrapper');if(canvasWrapper){canvasWrapper.classList.remove('color-picking')}this.removeColorPickingEvents();this.imageDataCache=null;this.cachedRects.clear();accessibilityManager.announce(appState.currentLang==='fa'?'انتخابگر رنگ غیرفعال شد':appState.currentLang==='ar'?'تم إلغاء تفعيل منتقي الألوان':'Color picker deactivated')}catch(error){memoryManager.logError('COLOR_PICKER_DEACTIVATE_ERROR',error)}}setupElements(){this.cursorElement=DOM.get('colorPickerCursor');this.previewElement=DOM.get('colorPickerPreview');this.btnElement=DOM.get('colorPickerBtn');const colorPickerTool=DOM.get('colorPickerTool');this.createMagnifier();if(this.btnElement){memoryManager.addEventListener(this.btnElement,'click',(e)=>{e.preventDefault();this.toggleColorPicker()});memoryManager.addEventListener(this.btnElement,'keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();this.toggleColorPicker()}})}if(colorPickerTool){memoryManager.addEventListener(colorPickerTool,'click',(e)=>{e.preventDefault();this.toggleColorPicker()})}}createMagnifier(){const canvasWrapper=DOM.get('canvasWrapper');if(!canvasWrapper)return;this.magnifierElement=document.createElement('div');this.magnifierElement.className='color-picker-magnifier';this.magnifierCanvas=document.createElement('canvas');this.magnifierCanvas.width=120;this.magnifierCanvas.height=120;this.magnifierCtx=this.magnifierCanvas.getContext('2d',{alpha:false,willReadFrequently:true});this.magnifierElement.appendChild(this.magnifierCanvas);this.colorInfoElement=document.createElement('div');this.colorInfoElement.className='color-picker-color-info';this.colorInfoElement.textContent='#000000';this.magnifierElement.appendChild(this.colorInfoElement);canvasWrapper.appendChild(this.magnifierElement)}toggleColorPicker(){try{if(!appState.img){const message=appState.currentLang==='fa'?'لطفاً ابتدا تصویری بارگذاری کنید':appState.currentLang==='ar'?'يرجى تحميل صورة أولاً':'Please upload an image first';showAlert(message);return}if(this.isActive){this.deactivateColorPicker()}else{this.activateColorPicker()}}catch(error){memoryManager.logError('COLOR_PICKER_TOGGLE_ERROR',error)}}cacheImageData(){try{const canvas=DOM.get('canvas');if(!canvas||!canvasRenderer.ctx)return;const tempCanvas=document.createElement('canvas');const tempCtx=tempCanvas.getContext('2d');tempCanvas.width=canvas.width;tempCanvas.height=canvas.height;if(appState.img){tempCtx.drawImage(appState.img,0,0,canvas.width,canvas.height)}else{tempCtx.fillStyle='#FFFFFF';tempCtx.fillRect(0,0,canvas.width,canvas.height)}this.imageDataCache=tempCtx.getImageData(0,0,canvas.width,canvas.height)}catch(error){memoryManager.logError('COLOR_PICKER_CACHE_ERROR',error)}}setupColorPickingEvents(){const canvas=DOM.get('canvas');if(!canvas)return;this.handleColorPickMove=this.handleColorPickMove.bind(this);this.handleColorPickClick=this.handleColorPickClick.bind(this);this.handleColorPickTouchMove=this.handleColorPickTouchMove.bind(this);this.handleColorPickTouchEnd=this.handleColorPickTouchEnd.bind(this);memoryManager.addEventListener(canvas,'mousemove',this.handleColorPickMove);memoryManager.addEventListener(canvas,'click',this.handleColorPickClick);memoryManager.addEventListener(canvas,'touchmove',this.handleColorPickTouchMove,{passive:false});memoryManager.addEventListener(canvas,'touchend',this.handleColorPickTouchEnd)}removeColorPickingEvents(){const canvas=DOM.get('canvas');if(!canvas)return;if(this.handleColorPickMove){canvas.removeEventListener('mousemove',this.handleColorPickMove)}if(this.handleColorPickClick){canvas.removeEventListener('click',this.handleColorPickClick)}if(this.handleColorPickTouchMove){canvas.removeEventListener('touchmove',this.handleColorPickTouchMove)}if(this.handleColorPickTouchEnd){canvas.removeEventListener('touchend',this.handleColorPickTouchEnd)}}handleColorPickMove(e){if(!this.isActive)return;try{const{canvasX,canvasY}=this.getCanvasCoordinates(e);this.updateCursorPosition(e.clientX,e.clientY);this.previewColorAtPosition(canvasX,canvasY)}catch(error){memoryManager.logError('COLOR_PICK_MOVE_ERROR',error)}}handleColorPickClick(e){if(!this.isActive)return;try{e.preventDefault();e.stopPropagation();const{canvasX,canvasY}=this.getCanvasCoordinates(e);const color=this.getColorAtPosition(canvasX,canvasY);if(color){this.applyPickedColor(color);this.deactivateColorPicker()}}catch(error){memoryManager.logError('COLOR_PICK_CLICK_ERROR',error)}}handleColorPickTouchMove(e){if(!this.isActive)return;try{e.preventDefault();const touch=e.touches[0];const{canvasX,canvasY}=this.getCanvasCoordinates(touch);this.updateCursorPosition(touch.clientX,touch.clientY);this.previewColorAtPosition(canvasX,canvasY)}catch(error){memoryManager.logError('COLOR_PICK_TOUCH_MOVE_ERROR',error)}}handleColorPickTouchEnd(e){if(!this.isActive)return;try{e.preventDefault();e.stopPropagation();const touch=e.changedTouches[0];const{canvasX,canvasY}=this.getCanvasCoordinates(touch);const color=this.getColorAtPosition(canvasX,canvasY);if(color){this.applyPickedColor(color);this.deactivateColorPicker()}}catch(error){memoryManager.logError('COLOR_PICK_TOUCH_END_ERROR',error)}}getCanvasCoordinates(e){const canvas=DOM.get('canvas');if(!canvas)return{canvasX:0,canvasY:0};const rect=canvas.getBoundingClientRect();const clientX=e.clientX||(e.touches&&e.touches[0]?e.touches[0].clientX:0);const clientY=e.clientY||(e.touches&&e.touches[0]?e.touches[0].clientY:0);const canvasX=Math.round((clientX-rect.left)*(canvas.width/rect.width));const canvasY=Math.round((clientY-rect.top)*(canvas.height/rect.height));return{canvasX,canvasY}}previewColorAtPosition(x,y){const color=this.getColorAtPosition(x,y);if(color&&this.btnElement){this.btnElement.style.borderColor=color}this.updateMagnifier(x,y,color)}updateMagnifier(canvasX,canvasY,color){if(!this.magnifierCtx||!this.imageDataCache||!this.magnifierElement)return;try{const canvas=DOM.get('canvas');if(!canvas)return;const sampleSize=15;const startX=Math.max(0,canvasX-sampleSize);const startY=Math.max(0,canvasY-sampleSize);const endX=Math.min(canvas.width,canvasX+sampleSize);const endY=Math.min(canvas.height,canvasY+sampleSize);const width=endX-startX;const height=endY-startY;const tempCanvas=document.createElement('canvas');tempCanvas.width=width;tempCanvas.height=height;const tempCtx=tempCanvas.getContext('2d',{alpha:false});const imageData=this.magnifierCtx.createImageData(width,height);for(let y=0;y<height;y++){for(let x=0;x<width;x++){const srcX=startX+x;const srcY=startY+y;const srcIndex=(srcY*canvas.width+srcX)*4;const dstIndex=(y*width+x)*4;imageData.data[dstIndex]=this.imageDataCache.data[srcIndex];imageData.data[dstIndex+1]=this.imageDataCache.data[srcIndex+1];imageData.data[dstIndex+2]=this.imageDataCache.data[srcIndex+2];imageData.data[dstIndex+3]=255}}tempCtx.putImageData(imageData,0,0);this.magnifierCtx.imageSmoothingEnabled=false;this.magnifierCtx.clearRect(0,0,this.magnifierCanvas.width,this.magnifierCanvas.height);this.magnifierCtx.drawImage(tempCanvas,0,0,width,height,0,0,this.magnifierCanvas.width,this.magnifierCanvas.height);if(this.colorInfoElement){this.colorInfoElement.textContent=color}}catch(error){memoryManager.logError('MAGNIFIER_UPDATE_ERROR',error)}}getColorAtPosition(x,y){try{if(!this.imageDataCache)return null;const canvas=DOM.get('canvas');if(!canvas)return null;x=Math.max(0,Math.min(x,canvas.width-1));y=Math.max(0,Math.min(y,canvas.height-1));const index=(y*canvas.width+x)*4;const data=this.imageDataCache.data;const r=data[index];const g=data[index+1];const b=data[index+2];const a=data[index+3];const hex=this.rgbToHex(r,g,b);return hex}catch(error){memoryManager.logError('GET_COLOR_ERROR',error);return null}}rgbToHex(r,g,b){return"#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1)}applyPickedColor(color){
    try{
        this.lastPickedColor=color;
        const colorPanel=document.getElementById('colorPanel');
        const backgroundPanel=document.getElementById('backgroundPanel');
        let targetType='text';
        if(backgroundPanel&&backgroundPanel.classList.contains('active')){targetType='background'}
        if(appState.selectedTextIndex>=0&&appState.textObjects[appState.selectedTextIndex]){
            undoRedoManager.saveState();
            const textObj=appState.textObjects[appState.selectedTextIndex];
            if(targetType==='background'){
                textObj.backdropColor=color;
                this.updateColorGridSelection('bgColorGrid',color);
            }else{
                textObj.color=color;
                this.updateColorGridSelection('textColorGrid',color);
            }
            if(this.previewElement){this.previewElement.style.backgroundColor=color}
            
            // --- START: Added Code for Preview ---
            const colorPickerBtn = DOM.get('colorPickerBtn');
            const colorWheelBtn = DOM.get('colorWheelBtn');
            if(colorPickerBtn) colorPickerBtn.style.borderColor = color;
            if(colorWheelBtn) colorWheelBtn.style.borderColor = color;
            // --- END: Added Code for Preview ---
            
            performanceMonitor.scheduleDraw();
            const colorName=this.getColorName(color);
            const message=targetType==='background'?(appState.currentLang==='fa'?`رنگ پس‌زمینه ${colorName} انتخاب شد`:appState.currentLang==='ar'?`تم تحديد لون الخلفية ${colorName}`:`Background color ${colorName} selected`):(appState.currentLang==='fa'?`رنگ متن ${colorName} انتخاب شد`:appState.currentLang==='ar'?`تم تحديد لون النص ${colorName}`:`Text color ${colorName} selected`);
            accessibilityManager.announce(message);
        }
    }catch(error){
        memoryManager.logError('APPLY_PICKED_COLOR_ERROR',error);
    }
}
updateColorGridSelection(gridId,color){try{const colorGrid=DOM.get(gridId);if(!colorGrid)return;colorGrid.querySelectorAll('.color-grid-swatch').forEach(swatch=>{const isActive=swatch.dataset.color.toLowerCase()===color.toLowerCase();swatch.classList.toggle('active',isActive)})}catch(error){memoryManager.logError('COLOR_GRID_UPDATE_ERROR',error)}}getColorName(hex){const colorNames={'#000000':'black','#ffffff':'white','#ff0000':'red','#00ff00':'green','#0000ff':'blue','#ffff00':'yellow','#ff00ff':'magenta','#00ffff':'cyan'};return colorNames[hex.toLowerCase()]||hex}cleanup(){try{this.deactivateColorPicker();this.imageDataCache=null;this.cachedRects.clear()}catch(error){memoryManager.logError('COLOR_PICKER_CLEANUP_ERROR',error)}}}

// Enhanced Canvas Renderer with corrected stroke thickness in export
class CanvasRenderer{constructor(){this.measurementCanvas=document.createElement('canvas');this.measurementCtx=this.measurementCanvas.getContext('2d');this.ctx=this.initializeCanvasContext();this.standardCanvasSize={width:1080,height:1920};this.vipCanvasSize={width:2160,height:3840}}
    isKashidaOpportunity(char1, char2) {
        const nonLeftJoining = /[\u0627\u0623\u0625\u0622\u062F\u0630\u0631\u0632\u0698\u0648\u0649]/;
        const isArabic = /[\u0600-\u06FF]/;
        
        if (char1 === ' ' || char2 === ' ' || !isArabic.test(char1) || !isArabic.test(char2)) {
            return false;
        }

        
        if (nonLeftJoining.test(char1)) {
            return false;
        }
       
        return true;
    }


    getExportDimensions(quality='standard'){
        const canvas=DOM.get('canvas');
        if(!canvas||canvas.width===0||canvas.height===0){
            return quality==='vip'?this.vipCanvasSize:this.standardCanvasSize;
        }
        const aspectRatio=canvas.width/canvas.height;
        let baseHeight=quality==='vip'?3840:1920;
        let width,height;
        if(aspectRatio<1){
            height=baseHeight;
            width=Math.round(height*aspectRatio);
        }else if(aspectRatio===1){
            height=baseHeight;
            width=height;
        }else{
            height=baseHeight;
            width=Math.round(height*aspectRatio);
        }
        return{width,height};
    }

initializeCanvasContext(){try{const canvas=DOM.get('canvas');if(!canvas)throw new Error('Canvas element not found');const context=canvas.getContext('2d');if(!context)throw new Error('Failed to get 2D context');return context}catch(error){memoryManager.logError('CANVAS_CONTEXT_ERROR',error);return null}}drawCanvas(){try{if(!this.ctx||!DOM.get('canvas'))return;if(!appState.img&&appState.textObjects.every(t=>!t.text.trim())){this.drawEmptyCanvas();return}if(DOM.get('photoPlaceholder'))DOM.get('photoPlaceholder').style.display='none';this.ctx.clearRect(0,0,DOM.get('canvas').width,DOM.get('canvas').height);if(appState.img){this.ctx.imageSmoothingEnabled=true;this.ctx.imageSmoothingQuality='high';this.drawImageCover(appState.img,0,0,DOM.get('canvas').width,DOM.get('canvas').height)}else{this.setupStandardCanvasSize();this.ctx.fillStyle="#FFFFFF";this.ctx.fillRect(0,0,DOM.get('canvas').width,DOM.get('canvas').height)}this.updateCanvasWrapperSize();this.updateCanvasBounds();this.drawTextObjects()}catch(error){memoryManager.logError('CANVAS_DRAW_ERROR',error)}}drawImageCover(img,x,y,w,h){if(!this.ctx||!img)return;const imgRatio=img.naturalWidth/img.naturalHeight;const canvasRatio=w/h;let sx,sy,sw,sh;if(imgRatio>canvasRatio){sh=img.naturalHeight;sw=sh*canvasRatio;sx=(img.naturalWidth-sw)/2;sy=0}else{sw=img.naturalWidth;sh=sw/canvasRatio;sx=0;sy=(img.naturalHeight-sh)/2}this.ctx.drawImage(img,sx,sy,sw,sh,x,y,w,h)}setupStandardCanvasSize(){try{const canvas=DOM.get('canvas');if(!canvas)return;canvas.width=this.standardCanvasSize.width;canvas.height=this.standardCanvasSize.height}catch(error){memoryManager.logError('STANDARD_CANVAS_SIZE_ERROR',error)}}drawEmptyCanvas(){try{const canvas=DOM.get('canvas');if(!canvas||!this.ctx)return;const targetRatio=9/16;const container=document.querySelector('.canvas-container');if(!container)return;const containerRect=container.getBoundingClientRect();let canvasWidth,canvasHeight;const containerAspect=containerRect.width/containerRect.height;if(targetRatio>containerAspect){canvasWidth=Math.min(containerRect.width*0.75,350);canvasHeight=canvasWidth/targetRatio}else{canvasHeight=Math.min(containerRect.height*0.75,400);canvasWidth=canvasHeight*targetRatio}canvas.width=this.standardCanvasSize.width;canvas.height=this.standardCanvasSize.height;const canvasWrapper=DOM.get('canvasWrapper');if(canvasWrapper){canvasWrapper.style.width=canvasWidth+'px';canvasWrapper.style.height=canvasHeight+'px'}this.ctx.fillStyle="#f0f0f0";this.ctx.fillRect(0,0,canvas.width,canvas.height);if(DOM.get('photoPlaceholder'))DOM.get('photoPlaceholder').style.display='flex';this.updateCanvasBounds()}catch(error){memoryManager.logError('EMPTY_CANVAS_DRAW_ERROR',error)}}    updateCanvasWrapperSize() {
        const canvasWrapper = DOM.get('canvasWrapper');
        const canvas = DOM.get('canvas');
        if (!canvasWrapper || !canvas || canvas.height === 0) return;

        // دریافت نسبت ابعاد به صورت داینامیک از خود Canvas
        const targetRatio = canvas.width / canvas.height;

        const container = document.querySelector('.canvas-container');
        if (!container) return;
        const containerRect = container.getBoundingClientRect();
        let displayWidth, displayHeight;
        const containerAspect = containerRect.width / containerRect.height;

        if (targetRatio > containerAspect) {
            displayWidth = Math.min(containerRect.width * 0.9, 420);
            displayHeight = displayWidth / targetRatio;
        } else {
            displayHeight = Math.min(containerRect.height * 0.9, 490);
            displayWidth = displayHeight * targetRatio;
        }
        canvasWrapper.style.width = Math.round(displayWidth) + 'px';
        canvasWrapper.style.height = Math.round(displayHeight) + 'px';
    }
updateCanvasBounds(){try{const canvasWrapper=DOM.get('canvasWrapper');if(!canvasWrapper)return;const container=document.querySelector('.canvas-container');if(!container)return;const wrapperWidth=canvasWrapper.offsetWidth;const wrapperHeight=canvasWrapper.offsetHeight;const containerWidth=container.offsetWidth;const containerHeight=container.offsetHeight;if(!wrapperWidth||!containerWidth||!wrapperHeight||!containerHeight)return;const minVisibleWidth=wrapperWidth/3;const minVisibleHeight=wrapperHeight/3;const limitX=(containerWidth/2)+(wrapperWidth/2)-minVisibleWidth;const limitY=(containerHeight/2)+(wrapperHeight/2)-minVisibleHeight;appState.canvasBounds={left:-limitX,right:limitX,top:-limitY,bottom:limitY}}catch(error){memoryManager.logError('BOUNDS_UPDATE_ERROR',error)}}drawTextObjects(){if(!this.ctx)return;try{appState.textObjects.forEach((textObj,index)=>{if(!textObj.text.trim())return;this.drawTextObject(textObj,index===appState.selectedTextIndex)});this.ctx.globalAlpha=1;this.ctx.shadowBlur=0}catch(error){memoryManager.logError('TEXT_OBJECTS_DRAW_ERROR',error)}}drawTextObject(textObj, isSelected = false) {
    if (!this.ctx) return;
    try {
        const canvas = DOM.get('canvas');
        const scaleFactor = Math.min(canvas.width, canvas.height) / Math.min(this.standardCanvasSize.width, this.standardCanvasSize.height);
        let calculatedFontSize = Math.max(16, textObj.fontSize * scaleFactor);

        this.ctx.font = `${calculatedFontSize}px ${textObj.font}`;

        const isRTLText = /[\u0590-\u05FF\u0600-\u06FF\u0750-\u077F]/.test(textObj.text);
        const isRTL = textObj.textDirection === 'rtl' || isRTLText;
        const direction = isRTL ? 'rtl' : 'ltr';
        
        const maxWidth = canvas.width * 0.95;
        const manualLines = textObj.text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
        const textLines = [];

        manualLines.forEach(line => {
            const testWidth = this.measureText(line, textObj.font, calculatedFontSize, direction).width;
            
            if (testWidth <= maxWidth) {
                textLines.push(line);
            } else {
                const words = line.split(' ');
                let currentLine = '';
                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    const testLine = currentLine ? currentLine + ' ' + word : word;
                    const testLineWidth = this.measureText(testLine, textObj.font, calculatedFontSize, direction).width;

                    if (testLineWidth > maxWidth && i > 0) {
                        textLines.push(currentLine);
                        currentLine = word;
                    } else {
                        currentLine = testLine;
                    }
                }
                textLines.push(currentLine);
            }
        });

        const letterSpacing = (textObj.letterSpacing || 0) * (calculatedFontSize / 100);
        const rawSpacingValue = (textObj.letterSpacing || 0);

        let maxTextWidth = 0;
        textLines.forEach(line => {
            let lineWidth = 0;
            const isRTL = textObj.textDirection === 'rtl' || isRTLText;
            const direction = isRTL ? 'rtl' : 'ltr'; 

            if (isRTL && rawSpacingValue > 0) { 
                let transformedText = "";
                const kashidaChar = '\u0640';
                const chars = Array.from(line);
                const opportunityIndices = [];
                for (let i = 0; i < chars.length - 1; i++) {
                    if (this.isKashidaOpportunity(chars[i], chars[i+1])) {
                        opportunityIndices.push(i);
                    }
                }
                
                if (opportunityIndices.length === 0) {
                    transformedText = line;
                } else {
                    const totalKashidas = Math.round((rawSpacingValue / 50) * 15); 
                    const kashidasPerPoint = Math.floor(totalKashidas / opportunityIndices.length);
                    let extraKashidas = totalKashidas % opportunityIndices.length;
                    const kashidaString = kashidaChar.repeat(kashidasPerPoint);
                    let opportunityIndex = 0;
                    for (let i = 0; i < chars.length; i++) {
                        transformedText += chars[i];
                        if (opportunityIndex < opportunityIndices.length && i === opportunityIndices[opportunityIndex]) {
                            transformedText += kashidaString;
                            if (extraKashidas > 0) {
                                transformedText += kashidaChar;
                                extraKashidas--;
                            }
                            opportunityIndex++;
                        }
                    }
                }
                
                lineWidth = this.measureText(transformedText, textObj.font, calculatedFontSize, direction).width;

            } else if (!isRTL && letterSpacing > 0) {
                const chars = Array.from(line);
                let totalWidth = 0;
                for (let i = 0; i < chars.length; i++) {
                    
                    totalWidth += this.measureText(chars[i], textObj.font, calculatedFontSize, direction).width;
                    if (i < chars.length - 1) totalWidth += letterSpacing;
                }
                lineWidth = totalWidth;
            } else {
                
                lineWidth = this.measureText(line, textObj.font, calculatedFontSize, direction).width;
            }

            maxTextWidth = Math.max(maxTextWidth, lineWidth);
        });

        if (maxTextWidth > canvas.width * 0.95) {
            const reductionFactor = (canvas.width * 0.95) / maxTextWidth;
            calculatedFontSize *= reductionFactor;
            calculatedFontSize = Math.max(12, calculatedFontSize);
            
            maxTextWidth *= reductionFactor; 
        }

        this.ctx.font = `${calculatedFontSize}px ${textObj.font}`; 
        
        const lineHeight = calculatedFontSize * (textObj.lineHeight || 1.2);
        const backdropPaddingX = (textObj.backdropWidthPercentage / 100) * maxTextWidth;
        const backdropPaddingY = (textObj.backdropHeightPercentage / 100) * (lineHeight * textLines.length);

        
        textObj.width = maxTextWidth + backdropPaddingX;
        textObj.height = (lineHeight * textLines.length) + backdropPaddingY;
        

        textObj.x = Math.max(0, Math.min(textObj.x, canvas.width - textObj.width));
        textObj.y = Math.max(0, Math.min(textObj.y, canvas.height - textObj.height));

        if (textObj.backdropOpacity > 0) {
            this.drawTextBackdrop(textObj, calculatedFontSize);
        }
        this.drawTextContent(textObj, textLines, calculatedFontSize, lineHeight, isRTLText);
        if (isSelected) {
            this.drawSelectionBorder(textObj, calculatedFontSize);
        }
    } catch (error) {
        memoryManager.logError('TEXT_OBJECT_DRAW_ERROR', error);
    }
}


drawTextBackdrop(textObj,fontSize){if(!this.ctx)return;this.ctx.fillStyle=textObj.backdropColor;this.ctx.globalAlpha=textObj.backdropOpacity;const radius=Math.max(0,(textObj.backdropRadius/100)*Math.min(textObj.width,textObj.height)/2);if(radius>0){this.ctx.beginPath();this.ctx.moveTo(textObj.x+radius,textObj.y);this.ctx.arcTo(textObj.x+textObj.width,textObj.y,textObj.x+textObj.width,textObj.y+textObj.height,radius);this.ctx.arcTo(textObj.x+textObj.width,textObj.y+textObj.height,textObj.x,textObj.y+textObj.height,radius);this.ctx.arcTo(textObj.x,textObj.y+textObj.height,textObj.x,textObj.y,radius);this.ctx.arcTo(textObj.x,textObj.y,textObj.x+textObj.width,textObj.y,radius);this.ctx.closePath();this.ctx.fill()}else{this.ctx.fillRect(textObj.x,textObj.y,textObj.width,textObj.height)}this.ctx.globalAlpha=1}drawTextContent(textObj, textLines, fontSize, lineHeight, isRTL) {
    if (!this.ctx) return;
    this.ctx.save();
    this.ctx.font = `${fontSize}px ${textObj.font}`;
    const align = textObj.textAlign || 'center';
    const dir = textObj.textDirection || 'ltr';
    
    // -- START FIX --
    // 'scaledLtrSpacing' برای فاصله بین حروف لاتین (وابسته به فونت)
    const scaledLtrSpacing = (textObj.letterSpacing || 0) * (fontSize / 100);
    // 'rawSpacingValue' برای تعداد کشیدگی فارسی (مستقل از فونت)
    const rawSpacingValue = (textObj.letterSpacing || 0);
    // -- END FIX --
    
    this.ctx.textAlign = align;
    this.ctx.textBaseline = "middle";
    this.ctx.lineJoin = 'round';
    const isRTLDir = dir === 'rtl' || isRTL;
    if (isRTLDir) {
        this.ctx.direction = 'rtl'
    } else {
        this.ctx.direction = 'ltr'
    }
    let lineY = textObj.y + (textObj.height / 2) - (((textLines.length - 1) * lineHeight) / 2);
    textLines.forEach(line => {
        let x;
        if (align === 'left') {
            x = textObj.x + 10
        } else if (align === 'right') {
            x = textObj.x + textObj.width - 10
        } else {
            x = textObj.x + textObj.width / 2
        }
        this.ctx.save();
        this.ctx.globalAlpha = textObj.opacity;
        if (textObj.shadowBlur > 0) {
            this.ctx.shadowColor = 'rgba(0,0,0,0.9)';
            this.ctx.shadowBlur = Math.max(6, textObj.shadowBlur * (fontSize / 15));
            this.ctx.shadowOffsetX = Math.max(3, fontSize / 25);
            this.ctx.shadowOffsetY = Math.max(3, fontSize / 25);
            this.ctx.filter = `blur(${Math.max(1, textObj.shadowBlur / 20)}px)`
        }
        if (textObj.strokeWidth > 0) {
            const strokeWidth = Math.max(2, (textObj.strokeWidth / 15) * (fontSize / 45));
            this.ctx.strokeStyle = '#000000';
            this.ctx.lineWidth = strokeWidth;
            this.ctx.lineJoin = 'round';
            this.ctx.lineCap = 'round';
            this.ctx.filter = 'none';
            // -- FIX: Pass both values --
            this.renderTextWithLetterSpacing(this.ctx, line, x, lineY, scaledLtrSpacing, rawSpacingValue, true)
        }
        this.ctx.shadowColor = 'transparent';
        this.ctx.shadowBlur = 0;
        this.ctx.shadowOffsetX = 0;
        this.ctx.shadowOffsetY = 0;
        this.ctx.filter = 'none';
        if (textObj.glowBlur > 0) {
            this.ctx.shadowColor = textObj.color;
            this.ctx.shadowBlur = Math.max(8, textObj.glowBlur * (fontSize / 12));
            this.ctx.filter = `drop-shadow(0 0 ${Math.max(4, textObj.glowBlur / 3)}px ${textObj.color})`
        }
        this.ctx.fillStyle = textObj.color;
        // -- FIX: Pass both values --
        this.renderTextWithLetterSpacing(this.ctx, line, x, lineY, scaledLtrSpacing, rawSpacingValue, false);
        this.ctx.restore();
        lineY += lineHeight
    });
    this.ctx.restore()
}
drawSelectionBorder(textObj, fontSize) {
    if (!this.ctx || appState.borderOpacity <= 0) return;

    let color, shadowColor;

    if (appState.img) {
        // Image exists: Follow day/night mode
        const isNightMode = document.body.classList.contains('night-mode');
        color = isNightMode ? `rgba(255, 243, 227, ${appState.borderOpacity})` : `rgba(27, 59, 20, ${appState.borderOpacity})`;
        shadowColor = isNightMode ? 'rgba(255, 243, 227, 0.6)' : 'rgba(27, 59, 20, 0.6)';
    } else {
        // No image (white canvas): Force green border
        color = `rgba(27, 59, 20, ${appState.borderOpacity})`; // --green-dark
        shadowColor = 'rgba(27, 59, 20, 0.6)';
    }


    const fixedLineWidth = 3;
    const fixedDash = [8, 4];
    const fixedCornerRadius = 10;
    const fixedPadding = 8;

    this.ctx.globalAlpha = 1;
    this.ctx.strokeStyle = color;
    this.ctx.lineWidth = fixedLineWidth;
    this.ctx.setLineDash(fixedDash);
    this.ctx.lineCap = 'round';
    this.ctx.lineJoin = 'round';
    this.ctx.filter = `drop-shadow(0 0 8px ${shadowColor})`;
    
    const x = textObj.x - fixedPadding;
    const y = textObj.y - fixedPadding;
    const width = textObj.width + fixedPadding * 2;
    const height = textObj.height + fixedPadding * 2;
    
    this.ctx.beginPath();
    this.ctx.moveTo(x + fixedCornerRadius, y);
    this.ctx.arcTo(x + width, y, x + width, y + height, fixedCornerRadius);
    this.ctx.arcTo(x + width, y + height, x, y + height, fixedCornerRadius);
    this.ctx.arcTo(x, y + height, x, y, fixedCornerRadius);
    this.ctx.arcTo(x, y, x + width, y, fixedCornerRadius);
    this.ctx.closePath();
    this.ctx.stroke();
    this.ctx.setLineDash([]);
    this.ctx.filter = 'none';
}
renderTextWithBiDiSupport(text,x,y,font,isRTL=false,isStroke=false){if(!this.ctx)return;const currentDirection=this.ctx.direction;const currentTextAlign=this.ctx.textAlign;if(isRTL||/[\u0590-\u05FF\u0600-\u06FF\u0750-\u077F]/.test(text)){this.ctx.direction='rtl'}else{this.ctx.direction='ltr'}if(isStroke){this.ctx.strokeText(text,x,y)}else{this.ctx.fillText(text,x,y)}this.ctx.direction=currentDirection;this.ctx.textAlign=currentTextAlign}
        renderTextWithLetterSpacing(ctx, text, x, y, scaledLtrSpacing, rawSpacingValue, isStroke = false) {
    if (!ctx || !text) return;

    const isRTL = ctx.direction === 'rtl';
    const kashidaChar = '\u0640';

    // -- START FIX: Logic uses rawSpacingValue for kashida count --
    if (isRTL && rawSpacingValue > 0) {
        const chars = Array.from(text);
        
        const opportunityIndices = [];
        for (let i = 0; i < chars.length - 1; i++) {
            if (this.isKashidaOpportunity(chars[i], chars[i+1])) {
                opportunityIndices.push(i);
            }
        }

        let transformedText = "";
        if (opportunityIndices.length === 0) {
            transformedText = text;
        } else {
            // FIX: Use rawSpacingValue (0-50) NOT scaledLtrSpacing
            const totalKashidas = Math.round((rawSpacingValue / 50) * 15);
            const kashidasPerPoint = Math.floor(totalKashidas / opportunityIndices.length);
            let extraKashidas = totalKashidas % opportunityIndices.length;

            const kashidaString = kashidaChar.repeat(kashidasPerPoint);
            let opportunityIndex = 0;

            for (let i = 0; i < chars.length; i++) {
                transformedText += chars[i];

                if (opportunityIndex < opportunityIndices.length && i === opportunityIndices[opportunityIndex]) {
                    transformedText += kashidaString; 
                    if (extraKashidas > 0) {
                        transformedText += kashidaChar;
                        extraKashidas--;
                    }
                    opportunityIndex++;
                }
            }
        }
        
        if (isStroke) {
            ctx.strokeText(transformedText, x, y);
        } else {
            ctx.fillText(transformedText, x, y);
        }
    // -- END FIX --

    // FIX: Check both values
    } else if (scaledLtrSpacing === 0 && rawSpacingValue === 0) {
        if (isStroke) {
            ctx.strokeText(text, x, y);
        } else {
            ctx.fillText(text, x, y);
        }

    } else { 
        // This is the LTR + letterSpacing logic
        // FIX: Use scaledLtrSpacing
        const chars = Array.from(text);
        const align = ctx.textAlign;
        let currentX = x;

        let totalWidth = 0;
        for (let i = 0; i < chars.length; i++) {
            totalWidth += ctx.measureText(chars[i]).width;
            if (i < chars.length - 1) totalWidth += scaledLtrSpacing;
        }

        if (align === 'center') {
            currentX = x - totalWidth / 2;
        } else if (align === 'right') {
            currentX = x - totalWidth;
        } else { // 'left'
            currentX = x;
        }

        const originalAlign = ctx.textAlign;
        ctx.textAlign = 'left';

        // Render char by char
        chars.forEach((char, i) => {
            if (isStroke) {
                ctx.strokeText(char, currentX, y);
            } else {
                ctx.fillText(char, currentX, y);
            }
            const charWidth = ctx.measureText(char).width;
            currentX += charWidth + scaledLtrSpacing;
        });
        ctx.textAlign = originalAlign;
    }
}

measureText(text, font, fontSize, direction = 'ltr') {
    try {
        this.measurementCtx.font = `${fontSize}px ${font}`;
        this.measurementCtx.direction = direction; // <-- FIX: جهت قبل از اندازه‌گیری تنظیم می‌شود
        return this.measurementCtx.measureText(text)
    } catch (error) {
        memoryManager.logError('TEXT_MEASURE_ERROR', error);
        return {
            width: 0
        }
    }
}
drawTextObjectsToExportCanvas(ctx, canvasWidth, canvasHeight) {
    const onScreenCanvas = DOM.get('canvas');
    if (!onScreenCanvas) {
        memoryManager.logError('EXPORT_SCALE_ERROR', 'On-screen canvas not found');
        return; 
    }
    const scaleFactor = canvasWidth / onScreenCanvas.width;

    appState.textObjects.forEach(textObj => {
        if (!textObj.text.trim()) return;

        const scaledFontSize = textObj.fontSize * scaleFactor;
        ctx.font = `${scaledFontSize}px ${textObj.font}`;

        const isRTLText = /[\u0590-\u05FF\u0600-\u06FF\u0750-\u077F]/.test(textObj.text);
        const isRTL = textObj.textDirection === 'rtl' || isRTLText;
        const direction = isRTL ? 'rtl' : 'ltr';
        
        const maxWidth = canvasWidth * 0.95;
        const manualLines = textObj.text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
        const textLines = [];

        manualLines.forEach(line => {
            const testWidth = this.measureText(line, textObj.font, scaledFontSize, direction).width;
            
            if (testWidth <= maxWidth) {
                textLines.push(line);
            } else {
                const words = line.split(' ');
                let currentLine = '';
                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    const testLine = currentLine ? currentLine + ' ' + word : word;
                    const testLineWidth = this.measureText(testLine, textObj.font, scaledFontSize, direction).width;

                    if (testLineWidth > maxWidth && i > 0) {
                        textLines.push(currentLine);
                        currentLine = word;
                    } else {
                        currentLine = testLine;
                    }
                }
                textLines.push(currentLine);
            }
        });

        const scaledLtrSpacing = (textObj.letterSpacing || 0) * (scaledFontSize / 100);
        const rawSpacingValue = (textObj.letterSpacing || 0);

        let maxTextWidth = 0;
        textLines.forEach(line => {
            let lineWidth = 0;
            const isRTL = textObj.textDirection === 'rtl' || isRTLText;

            const direction = isRTL ? 'rtl' : 'ltr';
            ctx.direction = direction;

            if (isRTL && rawSpacingValue > 0) {
                const kashidaChar = '\u0640';
                const chars = Array.from(line);
                const opportunityIndices = [];
                for (let i = 0; i < chars.length - 1; i++) {
                    if (this.isKashidaOpportunity(chars[i], chars[i + 1])) {
                        opportunityIndices.push(i);
                    }
                }
                
                let transformedText = "";
                if (opportunityIndices.length === 0) {
                    transformedText = line;
                } else {
                    const totalKashidas = Math.round((rawSpacingValue / 50) * 15);
                    const kashidasPerPoint = Math.floor(totalKashidas / opportunityIndices.length);
                    let extraKashidas = totalKashidas % opportunityIndices.length;
                    const kashidaString = kashidaChar.repeat(kashidasPerPoint);
                    let opportunityIndex = 0;
                    for (let i = 0; i < chars.length; i++) {
                        transformedText += chars[i];
                        if (opportunityIndex < opportunityIndices.length && i === opportunityIndices[opportunityIndex]) {
                            transformedText += kashidaString;
                            if (extraKashidas > 0) {
                                transformedText += kashidaChar;
                                extraKashidas--;
                            }
                            opportunityIndex++;
                        }
                    }
                }
                lineWidth = ctx.measureText(transformedText).width;

            } else if (!isRTL && scaledLtrSpacing > 0) {
                const chars = Array.from(line);
                let totalWidth = 0;
                for (let i = 0; i < chars.length; i++) {
                    totalWidth += ctx.measureText(chars[i]).width;
                    if (i < chars.length - 1) totalWidth += scaledLtrSpacing;
                }
                lineWidth = totalWidth;
            } else {
                lineWidth = ctx.measureText(line).width;
            }
            maxTextWidth = Math.max(maxTextWidth, lineWidth);
        });
        
        ctx.direction = 'ltr'; 

        const lineHeight = scaledFontSize * (textObj.lineHeight || 1.2);
        const backdropPaddingX = (textObj.backdropWidthPercentage / 100) * maxTextWidth;
        const backdropPaddingY = (textObj.backdropHeightPercentage / 100) * (lineHeight * textLines.length);

        const width = maxTextWidth + backdropPaddingX;
        const height = (lineHeight * textLines.length) + backdropPaddingY;
        const x = textObj.x * scaleFactor;
        const y = textObj.y * scaleFactor;

        if (textObj.backdropOpacity > 0) {
            ctx.fillStyle = textObj.backdropColor;
            ctx.globalAlpha = textObj.backdropOpacity;
            const radius = Math.max(0, (textObj.backdropRadius / 100) * Math.min(width, height) / 2);
            if (radius > 0) {
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.arcTo(x + width, y, x + width, y + height, radius);
                ctx.arcTo(x + width, y + height, x, y + height, radius);
                ctx.arcTo(x, y + height, x, y, radius);
                ctx.arcTo(x, y, x + width, y, radius);
                ctx.closePath();
                ctx.fill();
            } else {
                ctx.fillRect(x, y, width, height);
            }
            ctx.globalAlpha = 1;
        }

        ctx.save();
        ctx.font = `${scaledFontSize}px ${textObj.font}`;
        ctx.textAlign = textObj.textAlign || "center"; 
        ctx.textBaseline = "middle";
        ctx.lineJoin = 'round';
        
        let lineY = y + (height / 2) - (((textLines.length - 1) * lineHeight) / 2);

        textLines.forEach(line => {
            let textX;
            const align = textObj.textAlign || 'center';
            if (align === 'left') {
                textX = x + (backdropPaddingX / 2); 
            } else if (align === 'right') {
                textX = x + width - (backdropPaddingX / 2); 
            } else {
                textX = x + width / 2;
            }

            ctx.save();
            ctx.globalAlpha = textObj.opacity;
            if (textObj.shadowBlur > 0) {
                ctx.shadowColor = 'rgba(0,0,0,0.9)';
                ctx.shadowBlur = Math.max(6, textObj.shadowBlur * (scaledFontSize / 15));
                ctx.shadowOffsetX = Math.max(3, scaledFontSize / 25);
                ctx.shadowOffsetY = Math.max(3, scaledFontSize / 25);
                ctx.filter = `blur(${Math.max(1, textObj.shadowBlur / 20)}px)`;
            }
            if (textObj.strokeWidth > 0) {
                const strokeWidth = Math.max(2, (textObj.strokeWidth / 15) * (scaledFontSize / 45));
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = strokeWidth;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.filter = 'none';
                if (textObj.textDirection === 'rtl' || isRTLText) {
                    ctx.direction = 'rtl';
                } else {
                    ctx.direction = 'ltr';
                }
                this.renderTextWithLetterSpacing(ctx, line, textX, lineY, scaledLtrSpacing, rawSpacingValue, true);
            }
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            ctx.filter = 'none';
            if (textObj.glowBlur > 0) {
                ctx.shadowColor = textObj.color;
                ctx.shadowBlur = Math.max(8, textObj.glowBlur * (scaledFontSize / 12));
                ctx.filter = `drop-shadow(0 0 ${Math.max(4, textObj.glowBlur / 3)}px ${textObj.color})`;
            }
            ctx.fillStyle = textObj.color;
            if (textObj.textDirection === 'rtl' || isRTLText) {
                ctx.direction = 'rtl';
            } else {
                ctx.direction = 'ltr';
            }
            this.renderTextWithLetterSpacing(ctx, line, textX, lineY, scaledLtrSpacing, rawSpacingValue, false);
            ctx.restore();
            lineY += lineHeight;
        });
        ctx.restore();
    });
}
}

const canvasRenderer=new CanvasRenderer();const colorPickerManager=new ColorPickerManager();const colorWheelManager=new ColorWheelManager();

const translations={en:{initialCanvasText:'',alertImage:'Please upload an image first.',alertText:'Please enter text to download.',alertFont:'You can add maximum 3 custom fonts.',alertFontSuccess:(fileName)=>`Font ${fileName} loaded successfully!`,alertFontError:(message)=>`Font loading failed. Using default font instead.`,copySuccess:'Image copied to clipboard successfully!',maxPanels:'You can have maximum 3 text panels.',textPlaceholder:'Write your text',saveSuccess:'High-quality 9:16 image saved perfectly!',downloadSuccess:'High-quality file downloaded!',saveVipSuccess:'VIP JPEG 4K image saved perfectly!',saveError:'Error saving image',downloadError:'Error downloading',fileDownloaded:'File downloaded',orientationMessage:'Please rotate your device to portrait mode for the best experience.',fontFallback:'Font loading failed, using default font.',memoryError:'Insufficient memory for this operation',networkError:'Network connection error',fileError:'File processing error'},fa:{initialCanvasText:'',alertImage:'لطفاً ابتدا یک عکس بارگذاری کنید.',alertText:'لطفاً متنی برای دانلود وارد کنید.',alertFont:'شما می‌توانید حداکثر ۳ فونت سفارشی اضافه کنید.',alertFontSuccess:(fileName)=>`فونت ${fileName} با موفقیت بارگذاری شد!`,alertFontError:(message)=>`بارگذاری فونت ناموفق بود. از فونت پیش‌فرض است��اده می‌شود.`,copySuccess:'تصویر با موفقیت به کلیپ‌بورد کپی شد!',maxPanels:'حداکثر ۳ پنل متن می‌توانید داشته باشید.',textPlaceholder:'متن خود را بنویسید',saveSuccess:'عکس ۹:۱۶ با کیفیت خوب ذخیره شد!',downloadSuccess:'فایل با کیفیت خوب دانلود شد!',saveVipSuccess:'تصویر ۴K با کیفیت VIP ذخیره شد!',saveError:'خطا در ذخیره سازی',downloadError:'خطا در دانلود',fileDownloaded:'فایل دانلود شد',orientationMessage:'لطفاً دستگاه خود را به حالت عمودی بچرخانید تا بهترین تجربه را داشته باشید.',fontFallback:'بارگذاری فونت ناموفق بود، از فونت پیش‌فرض استفاده می‌شود.',memoryError:'حافظه کافی برای این عملیات وجود ندارد',networkError:'خطا در اتصال به شبکه',fileError:'خطا در پردازش فایل'},ar:{initialCanvasText:'',alertImage:'يرجى تحميل صورة أولاً.',alertText:'يرجى إدخال نص للتحميل.',alertFont:'يمكنك إضافة حد ��قصى 3 خطوط مخصصة.',alertFontSuccess:(fileName)=>`تم تحميل الخط ${fileName} بنجاح!`,alertFontError:(message)=>`فشل تحميل الخط. سيتم استخدام الخط الافتراضي ����دلاً من ذلك.`,copySuccess:'تم نسخ الصورة إلى الحافظة بنجاح!',maxPanels:'يمكنك الحصول على حد أقصى 3 لوحات نص.',textPlaceholder:'اكتب نصك',saveSuccess:'تم حفظ صورة 9:16 عالية الجودة بشكل مثالي!',downloadSuccess:'تم تحميل الملف عالي الجودة!',saveVipSuccess:'تم حفظ صورة 4K بجودة VIP بشكل مثالي!',saveError:'خطأ في حفظ الصورة',downloadError:'خطأ في التحميل',fileDownloaded:'تم تحميل الملف',orientationMessage:'يرجى تدوير جهازك إلى الوضع العمودي للحصول على أفضل تجربة.',fontFallback:'فشل تحميل الخط، سيتم استخدام الخط الافتراضي.',memoryError:'ذاكرة غير كافية لهذه الع��لية',networkError:'خطأ في اتصال الشبكة',fileError:'خطأ في معالجة الملف'}};
const numToFa=(num)=>String(num).replace(/\d/g,d=>'۰۱۲۳۴۵۶۷۸۹'[d]);const numToAr=(num)=>String(num).replace(/\d/g,d=>'٠١٢٣٤٥٦٧٨٩'[d]);const numToEn=(num)=>String(num);
class FontManager{constructor(){this.fontFamilies=[{name:'Vazirmatn',weights:[100,200,300,400,500,600,700,800,900]},{name:'Lalezar',weights:[400]},{name:'Amiri',weights:[400,700]},{name:'Markazi Text',weights:[400,500,600,700]},{name:'Noto Naskh Arabic',weights:[400,500,600,700]},{name:'Shabnam',weights:[400,700]}];this.loadedFonts=new Set();this.fontCache=new Map();this.fontLoadPromises=new Map()}async preloadFonts(){try{const fontPromises=[];const maxRetries=3;this.fontFamilies.forEach(fontFamily=>{fontFamily.weights.forEach(weight=>{const fontKey=`${weight}_${fontFamily.name}`;const fontPromise=this.retryOperation(()=>this.loadAndCacheFont(fontFamily.name,weight),maxRetries).then(()=>{this.loadedFonts.add(fontKey)}).catch(error=>{});fontPromises.push(fontPromise)})});await Promise.allSettled([...fontPromises,document.fonts.ready]);await this.ensureFontsLoaded();return true}catch(error){memoryManager.logError('FONT_PRELOAD_ERROR',error);return false}}async loadAndCacheFont(fontName,weight){const fontKey=`${fontName}_${weight}`;if(this.fontLoadPromises.has(fontKey)){return this.fontLoadPromises.get(fontKey)}const fontPromise=(async()=>{try{const fontFace=`${weight} 20px ${fontName}`;await document.fonts.load(fontFace);const testCanvas=document.createElement('canvas');const testCtx=testCanvas.getContext('2d');testCtx.font=fontFace;const metrics=testCtx.measureText('Test');if(metrics.width>0){this.fontCache.set(fontKey,true);return true}throw new Error('Font not properly loaded')}catch(error){throw error}})();this.fontLoadPromises.set(fontKey,fontPromise);return fontPromise}async ensureFontsLoaded(){const testPromises=this.fontFamilies.map(async(fontFamily)=>{try{const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');ctx.font=`400 24px ${fontFamily.name}`;const metrics=ctx.measureText('Test أبجد');await new Promise(resolve=>setTimeout(resolve,100));const metricsAfter=ctx.measureText('Test أبجد');return metricsAfter.width>0}catch(error){return false}});await Promise.allSettled(testPromises)}async retryOperation(operation,maxRetries=3,delay=1000){for(let i=0;i<maxRetries;i++){try{return await operation()}catch(error){if(i===maxRetries-1)throw error;await new Promise(resolve=>setTimeout(resolve,delay*Math.pow(2,i)))}}}async loadCustomFont(file,fileName){try{if(appState.customFontsCount>=appState.maxCustomFonts)throw new Error('MAX_CUSTOM_FONTS_EXCEEDED');if(file.size>10*1024*1024)throw new Error('FILE_TOO_LARGE');const fontName=`CustomFont_${Date.now()}`;const arrayBuffer=await this.readFileAsArrayBuffer(file);const font=new FontFace(fontName,arrayBuffer);const loadPromise=font.load();const timeoutPromise=new Promise((_,reject)=>setTimeout(()=>reject(new Error('FONT_LOAD_TIMEOUT')),10000));await Promise.race([loadPromise,timeoutPromise]);document.fonts.add(font);await new Promise(resolve=>setTimeout(resolve,200));const testCanvas=document.createElement('canvas');const testCtx=testCanvas.getContext('2d');testCtx.font=`24px ${fontName}`;const testMetrics=testCtx.measureText('Test');if(testMetrics.width===0)throw new Error('Font validation failed');appState.loadedCustomFonts.set(fontName,fileName);const fontSelector=DOM.get('fontSelector');if(fontSelector){const option=new Option(fileName,fontName);fontSelector.add(option);fontSelector.value=fontName}appState.customFontsCount++;appState.currentFont=fontName;if(appState.selectedTextIndex>=0&&appState.textObjects[appState.selectedTextIndex]){appState.textObjects[appState.selectedTextIndex].font=fontName;this.forceCanvasRedraw()}performanceMonitor.scheduleDraw(true);showAlert(translations[appState.currentLang].alertFontSuccess(fileName));return true}catch(error){this.applyFontFallback(fileName,error);return false}}forceCanvasRedraw(){setTimeout(()=>{const fontSelector=DOM.get('fontSelector');if(fontSelector&&appState.selectedTextIndex>=0&&appState.textObjects[appState.selectedTextIndex]){appState.textObjects[appState.selectedTextIndex].font=fontSelector.value;performanceMonitor.scheduleDraw(true)}},100)}async readFileAsArrayBuffer(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=(e)=>resolve(e.target.result);reader.onerror=()=>reject(new Error('FILE_READ_ERROR'));reader.readAsArrayBuffer(file)})}applyFontFallback(fileName,error){try{memoryManager.logError('FONT_LOAD_ERROR',error);const fallbackFont='Vazirmatn';const fontSelector=DOM.get('fontSelector');if(fontSelector)fontSelector.value=fallbackFont;appState.currentFont=fallbackFont;if(appState.selectedTextIndex>=0&&appState.textObjects[appState.selectedTextIndex]){appState.textObjects[appState.selectedTextIndex].font=fallbackFont}performanceMonitor.scheduleDraw(true);let errorMessage=translations[appState.currentLang].fontFallback;if(error.message==='FONT_LOAD_TIMEOUT'){errorMessage=appState.currentLang==='fa'?'بارگذاری ف��نت طولانی شد، از فونت پیش‌فرض استفاده می‌شود':appState.currentLang==='ar'?'ا��تغرق تحميل الخط وقتاً طويلاً، سيتم استخدام الخط الافتراضي':'Font loading took too long, using default font'}else if(error.message==='MAX_CUSTOM_FONTS_EXCEEDED'){errorMessage=translations[appState.currentLang].alertFont}else if(error.message==='FILE_TOO_LARGE'){errorMessage=appState.currentLang==='fa'?'حجم فونت نباید بیشتر از ۱۰ مگابایت باشد':appState.currentLang==='ar'?'يجب ألا يتجاوز حجم الخط 10 ميجابايت':'Font size should not exceed 10MB'}showAlert(errorMessage)}catch(fallbackError){}}}
const fontManager=new FontManager();
class AccessibilityManager{constructor(){this.currentModal=null;this.lastFocusedElement=null;this.setupGlobalAccessibility()}setupGlobalAccessibility(){this.announcementsElement=DOM.get('announcements');this.setupFocusManagement();this.setupKeyboardNavigation()}setupFocusManagement(){memoryManager.addEventListener(document,'focusin',(e)=>{if(!this.currentModal&&e.target!==document.body){this.lastFocusedElement=e.target}});memoryManager.addEventListener(document,'keydown',(e)=>{if(e.key==='Tab'&&this.currentModal){this.trapFocusInModal(e)}})}setupKeyboardNavigation(){memoryManager.addEventListener(document,'keydown',(e)=>{if(e.key==='Escape'&&this.currentModal){this.closeCurrentModal()}})}trapFocusInModal(e){const modal=document.getElementById(this.currentModal);if(!modal)return;const focusableElements=modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');const firstFocusable=focusableElements[0];const lastFocusable=focusableElements[focusableElements.length-1];if(e.shiftKey){if(document.activeElement===firstFocusable){e.preventDefault();lastFocusable.focus()}}else{if(document.activeElement===lastFocusable){e.preventDefault();firstFocusable.focus()}}}openModal(modalId){try{const modal=document.getElementById(modalId);if(!modal)return false;this.lastFocusedElement=document.activeElement;this.currentModal=modalId;modal.classList.add('active');modal.setAttribute('aria-hidden','false');const firstFocusable=modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(firstFocusable){setTimeout(()=>firstFocusable.focus(),100)}this.announce(`${modalId} modal opened`);return true}catch(error){memoryManager.logError('MODAL_OPEN_ERROR',error);return false}}closeModal(modalId){try{const modal=document.getElementById(modalId);if(!modal)return false;modal.classList.remove('active');modal.setAttribute('aria-hidden','true');this.currentModal=null;if(this.lastFocusedElement){setTimeout(()=>{try{this.lastFocusedElement.focus()}catch(e){document.body.focus()}},100)}this.announce(`${modalId} modal closed`);return true}catch(error){memoryManager.logError('MODAL_CLOSE_ERROR',error);return false}}closeCurrentModal(){if(this.currentModal){this.closeModal(this.currentModal)}}announce(message){if(this.announcementsElement){this.announcementsElement.textContent=message;setTimeout(()=>{this.announcementsElement.textContent=''},1000)}}setAriaLabel(element,label){if(element){element.setAttribute('aria-label',label)}}setAriaDescribedBy(element,id){if(element){element.setAttribute('aria-describedby',id)}}}
const accessibilityManager=new AccessibilityManager();
function showAlert(message){try{const modal=document.createElement('div');modal.className='custom-alert-modal';modal.style.cssText='position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:10000; backdrop-filter: blur(10px);';modal.setAttribute('role','dialog');modal.setAttribute('aria-labelledby','alert-message');modal.setAttribute('aria-modal','true');const isDark=document.body.classList.contains('night-mode');const bgColor=isDark?'rgba(21, 46, 17, 0.95)':'rgba(255, 243, 227, 0.95)';const textColor=isDark?'#fff3e3':'#152e11';const borderColor=isDark?'rgba(255, 243, 227, 0.2)':'rgba(21, 46, 17, 0.2)';const successIcon=`<div class="success-icon" style="width: 50px; height: 50px; border-radius: 50%; background: var(--orange-main); display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; animation: successPulse 0.6s ease-out;" aria-hidden="true"><svg style="width: 24px; height: 24px; stroke: white; stroke-width: 3;" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"></polyline></svg></div>`;const closeButton=document.createElement('button');closeButton.innerHTML=appState.currentLang==='fa'?'باشه':appState.currentLang==='ar'?'حسناً':'OK';closeButton.style.cssText=`background: var(--orange-main); color: white; border: none; padding: 15px 30px; border-radius: 15px; cursor: pointer; font-family: 'Vazirmatn', sans-serif; font-weight: 600; font-size: 1rem; transition: all 0.3s ease; min-width: 120px; box-shadow: 0 5px 20px rgba(255, 110, 65, 0.4);`;closeButton.setAttribute('aria-label','Close alert');closeButton.addEventListener('mouseenter',()=>{closeButton.style.background='var(--orange-dark)';closeButton.style.transform='translateY(-2px)'});closeButton.addEventListener('mouseleave',()=>{closeButton.style.background='var(--orange-main)';closeButton.style.transform='translateY(0)'});closeButton.addEventListener('click',()=>modal.remove());modal.innerHTML=`<div style="background: ${bgColor}; padding: 30px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); max-width: 380px; width: 90%; text-align: center; border: 1px solid ${borderColor}; backdrop-filter: blur(20px); transform: scale(0.9); animation: modalZoomIn 0.3s ease-out forwards;">${message.includes('VIP')||message.includes('4K')||message.includes('ذخیره')||message.includes('saved')||message.includes('حفظ')?successIcon:''}<p id="alert-message" style="color: ${textColor}; margin-bottom: 25px; font-family: 'Vazirmatn', sans-serif; line-height: 1.6; font-size: 1.1rem; font-weight: 500;">${message}</p></div>`;modal.querySelector('div').appendChild(closeButton);document.body.appendChild(modal);setTimeout(()=>closeButton.focus(),100);const handleEscape=(e)=>{if(e.key==='Escape'){modal.remove();document.removeEventListener('keydown',handleEscape)}};document.addEventListener('keydown',handleEscape);setTimeout(()=>{if(modal.parentElement){modal.style.opacity='0';modal.style.transform='scale(0.9)';setTimeout(()=>{modal.remove();document.removeEventListener('keydown',handleEscape)},300)}},4000);accessibilityManager.announce(message)}catch(error){}}
class LanguageManager{constructor(){this.currentLang='en';this.supportedLanguages=['en','fa','ar']}switchLanguage(lang){try{if(!this.supportedLanguages.includes(lang))return false;this.currentLang=lang;appState.currentLang=lang;document.body.setAttribute('data-lang',lang);document.documentElement.setAttribute('lang',lang);const elements=document.querySelectorAll('[data-fa][data-en][data-ar]');elements.forEach(el=>{const text=el.getAttribute(`data-${lang}`);if(text){if(el.tagName==='INPUT'&&(el.type==='text'||el.type==='textarea')){el.placeholder=text}else if(el.tagName==='TEXTAREA'){el.placeholder=text}else{el.textContent=text}}});appState.fontPanels.forEach(panel=>{const input=panel.querySelector('.font-text-input');if(input){input.placeholder=translations[lang].textPlaceholder}});uiManager.updateSliderValues();accessibilityManager.announce(`Language changed to ${lang}`);return true}catch(error){memoryManager.logError('LANGUAGE_SWITCH_ERROR',error);return false}}getNextLanguage(){const currentIndex=this.supportedLanguages.indexOf(this.currentLang);const nextIndex=(currentIndex+1)%this.supportedLanguages.length;return this.supportedLanguages[nextIndex]}translateText(key,...args){const translation=translations[this.currentLang]?.[key];if(typeof translation==='function'){return translation(...args)}return translation||translations.en[key]||key}}
const languageManager=new LanguageManager();
class UIManager{constructor(){this.colorPalette=['#000000','#4b5563','#6b7280','#9ca3af','#d1d5db','#ffffff','#ef4444','#f87171','#f97316','#fb923c','#eab308','#facc15','#84cc16','#a3e635','#22c55e','#4ade80','#14b8a6','#2dd4bf','#06b6d4','#22d3ee','#3b82f6','#60a5fa','#8b5cf6','#a78bfa','#d946ef','#e879f9','#ec4899','#f472b6'];this.updateCache=new Map()}createColorGrid(container,onColorSelect){try{if(!container)return false;container.innerHTML='';container.setAttribute('role','group');container.setAttribute('aria-label','Color selection');this.colorPalette.forEach((color,index)=>{const swatch=document.createElement('button');swatch.className='color-grid-swatch';swatch.style.backgroundColor=color;swatch.dataset.color=color;swatch.setAttribute('aria-label',`Select color ${color}`);swatch.setAttribute('title',color);swatch.type='button';memoryManager.addEventListener(swatch,'click',()=>{try{container.querySelectorAll('.color-grid-swatch').forEach(s=>s.classList.remove('active'));swatch.classList.add('active');onColorSelect(color);accessibilityManager.announce(`Color ${color} selected`)}catch(error){memoryManager.logError('COLOR_SELECT_ERROR',error)}});memoryManager.addEventListener(swatch,'keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();swatch.click()}});container.appendChild(swatch)});return true}catch(error){memoryManager.logError('COLOR_GRID_ERROR',error);return false}}openPanel(panelId){try{const accordionPanels=DOM.get('accordionPanels');const controlIcons=DOM.get('controlIcons');
// بستن تمام پنل‌های دیگر
if(accordionPanels){accordionPanels.forEach(p=>{
    p.classList.remove('active');
    p.setAttribute('aria-hidden','true');
    p.style.transform='';
    p.style.opacity='';
    p.style.visibility='';
})}if(controlIcons){controlIcons.forEach(i=>{i.classList.remove('active');i.setAttribute('aria-expanded','false')})}const panel=document.getElementById(panelId+'Panel');const icon=document.querySelector(`[data-panel="${panelId}"]`);const layerOverlay=document.getElementById('layerPanelOverlay');const layersPanel=document.getElementById('layersPanel');

            // If opening a settings panel (not layers), check layer toggle state
            if (panelId !== 'layers' && layersPanel) {
                const layersPanelToggle = document.getElementById('layersPanelToggleSwitch');
                
                if (layersPanelToggle && layersPanelToggle.classList.contains('active')) {
                    // Toggle is ON: Force layers panel to logo-only
                    layersPanel.classList.remove('active', 'collapsed');
                    layersPanel.classList.add('logo-only');
                } else {
                    // Toggle is OFF: Force layers panel to close completely
                    layersPanel.classList.remove('active', 'collapsed', 'logo-only');
                    if (layersPanelToggle) {
                        layersPanelToggle.classList.remove('active');
                    }
                }
            }

if(panelId==='layers'&&layerOverlay){layerOverlay.classList.add('active')}

requestAnimationFrame(()=>{if(panel){panel.classList.add('active');

if(panelId === 'layers') {
    const layersPanelToggle = document.getElementById('layersPanelToggleSwitch');
    if (layersPanelToggle) {
        layersPanelToggle.classList.add('active');
    }
    // Remove logo-only when opening layers panel
    if(layersPanel){
        layersPanel.classList.remove('logo-only');
    }
}

panel.setAttribute('aria-hidden','false');panel.scrollTop=0}if(icon){icon.classList.add('active');icon.setAttribute('aria-expanded','true')}});accessibilityManager.announce(`${panelId} panel opened`);return true}catch(error){memoryManager.logError('PANEL_OPEN_ERROR',error);return false}}
closePanel(panelId){
try{
    const panel=document.getElementById(panelId+'Panel');
    const icon=document.querySelector(`[data-panel="${panelId}"]`);
    const layerOverlay=document.getElementById('layerPanelOverlay');
    if(panelId==='layers'&&layerOverlay){layerOverlay.classList.remove('active')}
    if(panel){
        panel.classList.remove('active');
        panel.setAttribute('aria-hidden','true');
        panel.style.transform='';
        panel.style.opacity='';
        panel.style.visibility='';
    }
    if(icon){icon.classList.remove('active');icon.setAttribute('aria-expanded','false')}

    if (panelId === 'layers') {
        const layersPanelToggle = document.getElementById('layersPanelToggleSwitch');
        if (layersPanelToggle) {
            layersPanelToggle.classList.remove('active');
        }
    }

    accessibilityManager.announce(`${panelId} panel closed`);
    return true
}catch(error){memoryManager.logError('PANEL_CLOSE_ERROR',error);return false}
}
updateSliderValues(){try{const numFormat=appState.currentLang==='fa'?numToFa:appState.currentLang==='ar'?numToAr:numToEn;const percentSymbol=appState.currentLang==='fa'?'٪':appState.currentLang==='ar'?'٪':'%';const updates=[{slider:DOM.get('fontSizeSlider'),value:DOM.get('fontSizeValue'),format:(v)=>numFormat(Math.round(v))},{slider:DOM.get('opacitySlider'),value:DOM.get('opacityValue'),format:(v)=>numFormat(v)+percentSymbol},{slider:DOM.get('shadowSlider'),value:DOM.get('shadowValue'),format:(v)=>numFormat(Math.round(v * 10))},{slider:DOM.get('strokeSlider'),value:DOM.get('strokeValue'),format:(v)=>numFormat(v)},{slider:DOM.get('glowSlider'),value:DOM.get('glowValue'),format:(v)=>numFormat(Math.round(v * 10))},{slider:DOM.get('backdropOpacitySlider'),value:DOM.get('backdropOpacityValue'),format:(v)=>numFormat(v)+percentSymbol},{slider:DOM.get('backdropRadiusSlider'),value:DOM.get('backdropRadiusValue'),format:(v)=>numFormat(v)},{slider:DOM.get('backdropWidthSlider'),value:DOM.get('backdropWidthValue'),format:(v)=>numFormat(v)},{slider:DOM.get('backdropHeightSlider'),value:DOM.get('backdropHeightValue'),format:(v)=>numFormat(v)},{slider:DOM.get('letterSpacingSlider'),value:DOM.get('letterSpacingValue'),format:(v)=>numFormat(Math.round(v))},{slider:DOM.get('lineHeightSlider'),value:DOM.get('lineHeightValue'),format:(v)=>numFormat(parseFloat(v).toFixed(1))}];updates.forEach(({slider,value,format})=>{if(slider&&value){const formattedValue=format(slider.value);value.textContent=formattedValue}})}catch(error){memoryManager.logError('SLIDER_UPDATE_ERROR',error)}}showGuideLines(textBox){try{const canvas=DOM.get('canvas');const verticalGuide=DOM.get('verticalGuide');const horizontalGuide=DOM.get('horizontalGuide');if(!canvas||!verticalGuide||!horizontalGuide)return;const centerX=canvas.width/2;const centerY=canvas.height/2;const textCenterX=textBox.x+textBox.width/2;const textCenterY=textBox.y+textBox.height/2;const threshold=10;if(Math.abs(textCenterX-centerX)<threshold){verticalGuide.classList.add('active');textBox.x=centerX-textBox.width/2}else{verticalGuide.classList.remove('active')}if(Math.abs(textCenterY-centerY)<threshold){horizontalGuide.classList.add('active');textBox.y=centerY-textBox.height/2}else{horizontalGuide.classList.remove('active')}}catch(error){memoryManager.logError('GUIDE_LINES_ERROR',error)}}hideGuideLines(){try{const verticalGuide=DOM.get('verticalGuide');const horizontalGuide=DOM.get('horizontalGuide');if(verticalGuide)verticalGuide.classList.remove('active');if(horizontalGuide)horizontalGuide.classList.remove('active')}catch(error){memoryManager.logError('HIDE_GUIDE_LINES_ERROR',error)}}}
const uiManager=new UIManager();
class TextManager{animateBorderFade(){const now=performance.now();if(!appState.borderFadeStartTime){appState.borderFadeStartTime=now}const elapsed=now-appState.borderFadeStartTime;const progress=Math.min(elapsed/appState.borderFadeDuration,1);appState.borderOpacity=0.8*(1-progress);performanceMonitor.scheduleDraw();if(progress<1){appState.borderFadeAnimationId=requestAnimationFrame(()=>this.animateBorderFade())}else{appState.borderFadeStartTime=null;appState.borderOpacity=0;performanceMonitor.scheduleDraw()}}constructor(){this.maxTextObjects=3}
    syncPanelsWithState() {
        try {
            const fontPanelsContainer = DOM.get('fontPanelsContainer');
            if (!fontPanelsContainer) return;
            const autoResizeTextarea = (textarea) => {
                try {
                    const maxHeight = 60; 

TextManager.prototype.calculateTextDimensions = function(textObj, newFontSize) {
    const lines = textObj.text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
    let maxTextWidth = 0;
    const isRTLText = /[\u0590-\u05FF\u0600-\u06FF\u0750-\u077F]/.test(textObj.text);
    const letterSpacing = (textObj.letterSpacing || 0) * (newFontSize / 100);
    const rawSpacingValue = (textObj.letterSpacing || 0);

    lines.forEach(line => {
        let lineWidth = 0;
        const isRTL = textObj.textDirection === 'rtl' || isRTLText;
        const direction = isRTL ? 'rtl' : 'ltr';

        if (isRTL && rawSpacingValue > 0) {
            let transformedText = "";
            const kashidaChar = '\u0640';
            const chars = Array.from(line);
            const opportunityIndices = [];
            for (let i = 0; i < chars.length - 1; i++) {
                if (canvasRenderer.isKashidaOpportunity(chars[i], chars[i+1])) {
                    opportunityIndices.push(i);
                }
            }
            if (opportunityIndices.length === 0) {
                transformedText = line;
            } else {
                const totalKashidas = Math.round((rawSpacingValue / 50) * 15);
                const kashidasPerPoint = Math.floor(totalKashidas / opportunityIndices.length);
                let extraKashidas = totalKashidas % opportunityIndices.length;
                const kashidaString = kashidaChar.repeat(kashidasPerPoint);
                let opportunityIndex = 0;
                for (let i = 0; i < chars.length; i++) {
                    transformedText += chars[i];
                    if (opportunityIndex < opportunityIndices.length && i === opportunityIndices[opportunityIndex]) {
                        transformedText += kashidaString;
                        if (extraKashidas > 0) {
                            transformedText += kashidaChar;
                            extraKashidas--;
                        }
                        opportunityIndex++;
                    }
                }
            }
            lineWidth = canvasRenderer.measureText(transformedText, textObj.font, newFontSize, direction).width;
        } else if (!isRTL && letterSpacing > 0) {
            const chars = Array.from(line);
            let totalWidth = 0;
            for (let i = 0; i < chars.length; i++) {
                totalWidth += canvasRenderer.measureText(chars[i], textObj.font, newFontSize, direction).width;
                if (i < chars.length - 1) totalWidth += letterSpacing;
            }
            lineWidth = totalWidth;
        } else {
            lineWidth = canvasRenderer.measureText(line, textObj.font, newFontSize, direction).width;
        }
        maxTextWidth = Math.max(maxTextWidth, lineWidth);
    });

    const lineHeight = newFontSize * (textObj.lineHeight || 1.2);
    const backdropPaddingX = (textObj.backdropWidthPercentage / 100) * maxTextWidth;
    const backdropPaddingY = (textObj.backdropHeightPercentage / 100) * (lineHeight * lines.length);

    const newWidth = maxTextWidth + backdropPaddingX;
    const newHeight = (lineHeight * lines.length) + backdropPaddingY;
    
    return { newWidth, newHeight };
}

// as defined in setupTextInput
                    textarea.style.height = 'auto';
                    const newHeight = Math.min(textarea.scrollHeight, maxHeight);
                    textarea.style.height = newHeight + 'px';
                    if (textarea.scrollHeight > maxHeight) {
                        textarea.classList.add('scrollable');
                    } else {
                        textarea.classList.remove('scrollable');
                    }
                } catch (error) {
                    memoryManager.logError('TEXTAREA_RESIZE_ERROR', error);
                }
            };
            appState.fontPanels.forEach(panel => panel.remove());
            appState.fontPanels = [];
            appState.textObjects.forEach((textObj, index) => {
                const panelDiv = document.createElement('div');
                panelDiv.className = 'font-panel';
                panelDiv.setAttribute('role', 'group');
                panelDiv.setAttribute('aria-label', `Text panel ${index + 1}`);
                panelDiv.innerHTML = `<textarea placeholder="${languageManager.translateText('textPlaceholder')}" class="font-text-input" rows="1" aria-label="Text input"></textarea><button class="remove-font" aria-label="Remove this text panel">×</button>`;
                
                const textInput = panelDiv.querySelector('.font-text-input');
                const removeBtn = panelDiv.querySelector('.remove-font');
                textInput.value = textObj.text;
                this.setupTextInput(textInput, panelDiv);
                this.setupRemoveButton(removeBtn, panelDiv);
                this.setupPanelInteraction(panelDiv);
                fontPanelsContainer.appendChild(panelDiv);
                appState.fontPanels.push(panelDiv);
autoResizeTextarea(textInput);
            });
            const addFontPanelBtn = DOM.get('addFontPanelBtn');
            if (addFontPanelBtn) {
                const disabled = appState.fontPanels.length >= this.maxTextObjects;
                addFontPanelBtn.disabled = disabled;
                addFontPanelBtn.setAttribute('aria-disabled', String(disabled));
            }
            if (appState.selectedTextIndex >= 0 && appState.fontPanels[appState.selectedTextIndex]) {
                appState.fontPanels[appState.selectedTextIndex].classList.add('selected');
                appState.fontPanels[appState.selectedTextIndex].setAttribute('aria-selected', 'true');
            }

        } catch (error) {
            memoryManager.logError('SYNC_PANELS_ERROR', error);
        }
    }
addFontPanel(){try{if(appState.fontPanels.length>=this.maxTextObjects){showAlert(languageManager.translateText('maxPanels'));return false}const panelDiv=document.createElement('div');panelDiv.className='font-panel';panelDiv.setAttribute('role','group');panelDiv.setAttribute('aria-label',`Text panel ${appState.fontPanels.length+1}`);panelDiv.innerHTML=`<textarea placeholder="${languageManager.translateText('textPlaceholder')}" class="font-text-input" rows="1" aria-label="Text input"></textarea><button class="remove-font" aria-label="Remove this text panel">×</button>`;const textInput=panelDiv.querySelector('.font-text-input');const removeBtn=panelDiv.querySelector('.remove-font');this.setupTextInput(textInput,panelDiv);this.setupRemoveButton(removeBtn,panelDiv);this.setupPanelInteraction(panelDiv);const fontPanelsContainer=DOM.get('fontPanelsContainer');if(fontPanelsContainer){fontPanelsContainer.appendChild(panelDiv)}appState.fontPanels.push(panelDiv);const canvas=DOM.get('canvas');const textObj=appState.createTextObject('',(canvas.width-200)/2,(canvas.height-60)/2+(appState.textObjects.length*(canvas.height*0.1)));appState.textObjects.push(textObj);const addFontPanelBtn=DOM.get('addFontPanelBtn');if(appState.fontPanels.length>=this.maxTextObjects&&addFontPanelBtn){addFontPanelBtn.disabled=true;addFontPanelBtn.setAttribute('aria-disabled','true')}this.selectTextObject(appState.textObjects.length-1);performanceMonitor.scheduleDraw(true);accessibilityManager.announce(`Text panel ${appState.fontPanels.length} added`);layerManager.updateLayerPanel();
return true}catch(error){memoryManager.logError('ADD_FONT_PANEL_ERROR',error);return false}}setupTextInput(textInput, panelDiv) {
    const autoResizeTextarea = (textarea) => {
        try {
            const maxHeight = 60;
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, maxHeight);
            textarea.style.height = newHeight + 'px';
            if (textarea.scrollHeight > maxHeight) {
                textarea.classList.add('scrollable');
            } else {
                textarea.classList.remove('scrollable');
            }
        } catch (error) {
            memoryManager.logError('TEXTAREA_RESIZE_ERROR', error);
        }
    };

    const debouncedDraw = debounce(() => {
        performanceMonitor.scheduleDraw();
    }, 250);

    const debouncedResize = debounce((textarea) => {
        autoResizeTextarea(textarea);
    }, 100);

    memoryManager.addEventListener(textInput, 'input', (e) => {
        try {
            const panelIndex = appState.fontPanels.indexOf(panelDiv);
            if (panelIndex >= 0 && appState.textObjects[panelIndex]) {
                appState.textObjects[panelIndex].text = e.target.value;
                debouncedDraw();
            }
            debouncedResize(e.target);
        } catch (error) {
            memoryManager.logError('TEXT_INPUT_ERROR', error);
        }
    });

    memoryManager.addEventListener(textInput, 'focus', () => {
        try {
            const panelIndex = appState.fontPanels.indexOf(panelDiv);
            this.selectTextObject(panelIndex);
        } catch (error) {
            memoryManager.logError('TEXT_FOCUS_ERROR', error);
        }
    });

    memoryManager.addEventListener(textInput, 'keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            setTimeout(() => autoResizeTextarea(e.target), 0);
        }
    });
    autoResizeTextarea(textInput);
}

setupRemoveButton(removeBtn,panelDiv){memoryManager.addEventListener(removeBtn,'click',()=>{this.removeFontPanel(panelDiv)});memoryManager.addEventListener(removeBtn,'keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();this.removeFontPanel(panelDiv)}})}setupPanelInteraction(panelDiv){memoryManager.addEventListener(panelDiv,'click',(e)=>{if(e.detail!==1)return;const panelIndex=appState.fontPanels.indexOf(panelDiv);this.selectTextObject(panelIndex)});memoryManager.addEventListener(panelDiv,'dblclick',(e)=>{e.preventDefault();e.stopPropagation();const panelIndex=appState.fontPanels.indexOf(panelDiv);this.selectTextObject(panelIndex);const textPanel=document.getElementById('textPanel');if(textPanel&&!textPanel.classList.contains('active')){uiManager.openPanel('text')}});let panelLastTouchTime=0;let panelTouchCount=0;memoryManager.addEventListener(panelDiv,'touchend',(e)=>{const now=Date.now();if(now-panelLastTouchTime<300){panelTouchCount++;if(panelTouchCount===2){e.preventDefault();e.stopPropagation();const panelIndex=appState.fontPanels.indexOf(panelDiv);this.selectTextObject(panelIndex);const textPanel=document.getElementById('textPanel');if(textPanel&&!textPanel.classList.contains('active')){uiManager.openPanel('text')}panelTouchCount=0}}else{panelTouchCount=1}panelLastTouchTime=now})}removeFontPanel(panelDiv){
    try{
        const index=appState.fontPanels.indexOf(panelDiv);
        if(index>-1){
            undoRedoManager.saveState();

            const textInput = panelDiv.querySelector('.font-text-input');
            const removeBtn = panelDiv.querySelector('.remove-font');

            if (textInput) memoryManager.cleanupElement(textInput);
            if (removeBtn) memoryManager.cleanupElement(removeBtn);
            memoryManager.cleanupElement(panelDiv);

            appState.fontPanels.splice(index,1);
            appState.textObjects.splice(index,1);
            panelDiv.remove();

            const addFontPanelBtn=DOM.get('addFontPanelBtn');
            if(addFontPanelBtn){
                addFontPanelBtn.disabled=appState.fontPanels.length>=this.maxTextObjects;
                addFontPanelBtn.setAttribute('aria-disabled',addFontPanelBtn.disabled)
            }
            if(appState.selectedTextIndex===index){
                appState.selectedTextIndex=Math.max(0,appState.fontPanels.length-1)
            }else if(appState.selectedTextIndex>index){
                appState.selectedTextIndex--
            }
            if(appState.textObjects.length===0){
                appState.selectedTextIndex=-1
            }else if(appState.selectedTextIndex>=appState.textObjects.length){
                appState.selectedTextIndex=appState.textObjects.length-1
            }
            this.updateUIFromSelectedText();
            layerManager.updateLayerPanel();
            performanceMonitor.scheduleDraw(true);
            accessibilityManager.announce(`Text panel ${index+1} removed`)
        }
    }catch(error){
        memoryManager.logError('REMOVE_FONT_PANEL_ERROR',error)
    }
}
selectTextObject(index){try{if(index>=0&&index<appState.textObjects.length){if(appState.selectionBorderTimeout)clearTimeout(appState.selectionBorderTimeout);if(appState.borderFadeAnimationId)cancelAnimationFrame(appState.borderFadeAnimationId);appState.selectedTextIndex=index;appState.borderOpacity=0.8;requestAnimationFrame(()=>{appState.fontPanels.forEach((panel,i)=>{const isSelected=i===index;panel.classList.toggle('selected',isSelected);panel.setAttribute('aria-selected',isSelected.toString())})});this.updateUIFromSelectedText();performanceMonitor.scheduleDraw(true);appState.selectionBorderTimeout=setTimeout(()=>{this.animateBorderFade()},3000);layerManager.updateLayerPanel();
accessibilityManager.announce(`Text object ${index+1} selected`)}}catch(error){memoryManager.logError('SELECT_TEXT_ERROR',error)}}updateUIFromSelectedText() {
    try {
        if (appState.selectedTextIndex >= 0 && appState.selectedTextIndex < appState.textObjects.length) {
            const textObj = appState.textObjects[appState.selectedTextIndex];
            if (!textObj) return;
            requestAnimationFrame(() => {
                const updates = [{
                    element: DOM.get('fontSizeSlider'),
                    value: Math.round(textObj.fontSize)
                }, {
                    element: DOM.get('opacitySlider'),
                    value: Math.round(textObj.opacity * 100)
                }, {
                    element: DOM.get('shadowSlider'),
                    value: Math.round(textObj.shadowBlur)
                }, {
                    element: DOM.get('strokeSlider'),
                    value: Math.round(textObj.strokeWidth)
                }, {
                    element: DOM.get('glowSlider'),
                    value: Math.round(textObj.glowBlur)
                }, {
                    element: DOM.get('backdropOpacitySlider'),
                    value: Math.round(textObj.backdropOpacity * 100)
                }, {
                    element: DOM.get('backdropRadiusSlider'),
                    value: Math.round(textObj.backdropRadius)
                }, {
                    element: DOM.get('backdropWidthSlider'),
                    value: Math.round(textObj.backdropWidthPercentage)
                }, {
                    element: DOM.get('backdropHeightSlider'),
                    value: Math.round(textObj.backdropHeightPercentage)
                }, {
                    element: DOM.get('letterSpacingSlider'),
                    value: Math.round(textObj.letterSpacing || 0)
                }, {
                    element: DOM.get('lineHeightSlider'),
                    value: (textObj.lineHeight || 1.2)
                }, {
                    element: DOM.get('fontSelector'),
                    value: textObj.font
                }];
                updates.forEach(({
                    element,
                    value
                }) => {
                    if (element && element.value !== undefined) {
                        if (element.value != value) {
                            element.value = value
                        }
                    }
                });
                const shadowSlider = DOM.get('shadowSlider');
                if (shadowSlider) {
                    const strokeValue = textObj.strokeWidth || 0;
                    const isDisabled = strokeValue <= 0;
                    shadowSlider.disabled = isDisabled;
                    const sliderGroup = shadowSlider.closest('.slider-group');
                    if (sliderGroup) {
                        sliderGroup.style.opacity = isDisabled ? '0.5' : '1';
                        sliderGroup.style.pointerEvents = isDisabled ? 'none' : 'auto';
                    }
                }
                this.updateColorGridSelection('textColorGrid', textObj.color);
                this.updateColorGridSelection('bgColorGrid', textObj.backdropColor);
                this.updateAlignmentButtons(textObj.textAlign || 'center');
                uiManager.updateSliderValues()
            })
        }
    } catch (error) {
        memoryManager.logError('UI_UPDATE_ERROR', error)
    }
}
updateAlignmentButtons(align){try{const alignBtns=[document.getElementById('alignLeftBtn'),document.getElementById('alignCenterBtn'),document.getElementById('alignRightBtn')];alignBtns.forEach(btn=>{if(btn){btn.classList.remove('active');if(btn.dataset.align===align){btn.classList.add('active')}}})}catch(error){memoryManager.logError('ALIGNMENT_BTN_UPDATE_ERROR',error)}}updateColorGridSelection(gridId,color){try{const colorGrid=DOM.get(gridId);if(!colorGrid)return;const hexColor=color.includes('rgb')?this.rgbToHex(color):color;colorGrid.querySelectorAll('.color-grid-swatch').forEach(swatch=>{const isActive=swatch.dataset.color.toLowerCase()===hexColor.toLowerCase();swatch.classList.toggle('active',isActive)})}catch(error){memoryManager.logError('COLOR_GRID_UPDATE_ERROR',error)}}rgbToHex(rgb){try{const result=rgb.match(/\d+/g);if(result&&result.length>=3){return"#"+((1<<24)+(parseInt(result[0],10)<<16)+(parseInt(result[1],10)<<8)+parseInt(result[2],10)).toString(16).slice(1)}return rgb}catch(error){memoryManager.logError('RGB_TO_HEX_ERROR',error);return rgb}}}
const textManager=new TextManager();
class InteractionManager{constructor(){this.setupInteractionHandlers()}setupInteractionHandlers(){this.setupCanvasInteraction();this.setupCanvasTransform();this.setupDoubleTapDetection();this.setupBackgroundDoubleTap()}setupCanvasInteraction(){const canvas=DOM.get('canvas');if(!canvas)return;memoryManager.addEventListener(canvas,'click',(e)=>{this.handleCanvasClick(e)});memoryManager.addEventListener(canvas,'dblclick',(e)=>{this.handleCanvasDoubleClick(e)});memoryManager.addEventListener(canvas,'touchend',(e)=>{this.handleCanvasTouchEnd(e)})}setupCanvasTransform(){const canvasWrapper=DOM.get('canvasWrapper');if(!canvasWrapper)return;memoryManager.addEventListener(canvasWrapper,'mousedown',(e)=>{this.handleStart(e)});memoryManager.addEventListener(canvasWrapper,'touchstart',(e)=>{this.handleStart(e)},{passive:false});memoryManager.addEventListener(window,'mousemove',(e)=>{this.handleMove(e)});memoryManager.addEventListener(window,'touchmove',(e)=>{this.handleMove(e)},{passive:false});memoryManager.addEventListener(window,'mouseup',(e)=>{this.handleEnd(e)});memoryManager.addEventListener(window,'touchend',(e)=>{this.handleEnd(e)});memoryManager.addEventListener(window,'touchcancel',(e)=>{this.handleEnd(e)})}setupDoubleTapDetection(){const photoPlaceholder=DOM.get('photoPlaceholder');if(!photoPlaceholder)return;memoryManager.addEventListener(photoPlaceholder,'touchend',(e)=>{this.handlePlaceholderDoubleTap(e)});memoryManager.addEventListener(photoPlaceholder,'dblclick',(e)=>{e.preventDefault();e.stopPropagation();this.showQuickActionModal()})}setupBackgroundDoubleTap(){const canvasContainer=DOM.get('canvasContainer');if(!canvasContainer)return;memoryManager.addEventListener(canvasContainer,'dblclick',(e)=>{if(e.target===canvasContainer){e.preventDefault();e.stopPropagation();this.centerCanvas()}});let backgroundLastTouchTime=0;let backgroundTouchCount=0;memoryManager.addEventListener(canvasContainer,'touchend',(e)=>{if(e.target!==canvasContainer)return;const now=Date.now();if(now-backgroundLastTouchTime<300){backgroundTouchCount++;if(backgroundTouchCount===2){e.preventDefault();e.stopPropagation();this.centerCanvas();backgroundTouchCount=0}}else{backgroundTouchCount=1}backgroundLastTouchTime=now})}getPointerPos(e,el){try{const rect=el.getBoundingClientRect();const clientX=e.touches?e.touches[0].clientX:e.clientX;const clientY=e.touches?e.touches[0].clientY:e.clientY;return{x:clientX-rect.left,y:clientY-rect.top}}catch(error){memoryManager.logError('POINTER_POS_ERROR',error);return{x:0,y:0}}}getCanvasPos(e){try{const canvas=DOM.get('canvas');if(!canvas)return{x:0,y:0};const rect=canvas.getBoundingClientRect();const clientX=e.touches?e.touches[0].clientX:e.clientX;const clientY=e.touches?e.touches[0].clientY:e.clientY;return{x:(clientX-rect.left)*(canvas.width/rect.width),y:(clientY-rect.top)*(canvas.height/rect.height)}}catch(error){memoryManager.logError('CANVAS_POS_ERROR',error);return{x:0,y:0}}}handleStart(e){try{if(appState.isColorPickerActive)return;if(e.touches&&e.touches.length===2){e.preventDefault();appState.isPinching=true;const t1=e.touches[0];const t2=e.touches[1];appState.initialPinchDistance=Math.hypot(t1.clientX-t2.clientX,t1.clientY-t2.clientY);if(appState.selectedTextIndex>=0&&appState.textObjects[appState.selectedTextIndex]){appState.lastFontSize=appState.textObjects[appState.selectedTextIndex].fontSize}return}const canvasPos=this.getCanvasPos(e);let clickedTextIndex=-1;for(let i=appState.textObjects.length-1;i>=0;i--){const textObj=appState.textObjects[i];if(canvasPos.x>=textObj.x&&canvasPos.x<=textObj.x+textObj.width&&canvasPos.y>=textObj.y&&canvasPos.y<=textObj.y+textObj.height){clickedTextIndex=i;break}}if(clickedTextIndex>=0){
// بررسی قفل بودن لایه
const textObj=appState.textObjects[clickedTextIndex];if(textObj.locked){
// اگر لایه قفل است، فقط انتخاب می‌شود ولی نمی‌تواند جابجا شود
textManager.selectTextObject(clickedTextIndex);accessibilityManager.announce('Layer is locked');return}undoRedoManager.saveState();appState.isDraggingText=true;appState.isDraggingCanvas=false;appState.selectedTextIndex=clickedTextIndex;textManager.selectTextObject(appState.selectedTextIndex);appState.dragStart={x:canvasPos.x-appState.textObjects[appState.selectedTextIndex].x,y:canvasPos.y-appState.textObjects[appState.selectedTextIndex].y};uiManager.showGuideLines(appState.textObjects[appState.selectedTextIndex])}else{appState.isDraggingCanvas=true;appState.isDraggingText=false;const clientX=e.touches?e.touches[0].clientX:e.clientX;const clientY=e.touches?e.touches[0].clientY:e.clientY;appState.lastPointer={x:clientX,y:clientY};appState.momentum={x:0,y:0};const canvasWrapper=DOM.get('canvasWrapper');if(canvasWrapper){canvasWrapper.style.cursor='grabbing';canvasWrapper.classList.remove('smooth-transition')}e.preventDefault()}}catch(error){memoryManager.logError('HANDLE_START_ERROR',error)}}handleMove(e){
    try{
        if(appState.isColorPickerActive)return;
        
        if (e.touches && e.touches.length === 2 && appState.isPinching) {
    e.preventDefault();
    const t1 = e.touches[0];
    const t2 = e.touches[1];
    const currentDist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
    const scale = currentDist / appState.initialPinchDistance;
    if (appState.selectedTextIndex >= 0 && appState.textObjects[appState.selectedTextIndex]) {
        const textObj = appState.textObjects[appState.selectedTextIndex];
        if (textObj.locked) return;
        const canvas = DOM.get('canvas');
        if (!canvas) return;
        const centerX = textObj.x + textObj.width / 2;
        const centerY = textObj.y + textObj.height / 2;
        const newFontSize = Math.max(10, Math.min(500, appState.lastFontSize * scale));
        const isRTLText = /[\u0590-\u05FF\u0600-\u06FF\u0750-\u077F]/.test(textObj.text);
        const letterSpacing = (textObj.letterSpacing || 0) * (newFontSize / 100);
        const rawSpacingValue = (textObj.letterSpacing || 0);
        const lines = textObj.text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
        let maxTextWidth = 0;
        lines.forEach(line => {
            let lineWidth = 0;
            const isRTL = textObj.textDirection === 'rtl' || isRTLText;
            const direction = isRTL ? 'rtl' : 'ltr';
            if (isRTL && rawSpacingValue > 0) {
                let transformedText = "";
                const kashidaChar = '\u0640';
                const chars = Array.from(line);
                const opportunityIndices = [];
                for (let i = 0; i < chars.length - 1; i++) {
                    if (canvasRenderer.isKashidaOpportunity(chars[i], chars[i + 1])) {
                        opportunityIndices.push(i);
                    }
                }
                if (opportunityIndices.length === 0) {
                    transformedText = line;
                } else {
                    const totalKashidas = Math.round((rawSpacingValue / 50) * 15);
                    const kashidasPerPoint = Math.floor(totalKashidas / opportunityIndices.length);
                    let extraKashidas = totalKashidas % opportunityIndices.length;
                    const kashidaString = kashidaChar.repeat(kashidasPerPoint);
                    let opportunityIndex = 0;
                    for (let i = 0; i < chars.length; i++) {
                        transformedText += chars[i];
                        if (opportunityIndex < opportunityIndices.length && i === opportunityIndices[opportunityIndex]) {
                            transformedText += kashidaString;
                            if (extraKashidas > 0) {
                                transformedText += kashidaChar;
                                extraKashidas--;
                            }
                            opportunityIndex++;
                        }
                    }
                }
                lineWidth = canvasRenderer.measureText(transformedText, textObj.font, newFontSize, direction).width;
            } else if (!isRTL && letterSpacing > 0) {
                const chars = Array.from(line);
                let totalWidth = 0;
                for (let i = 0; i < chars.length; i++) {
                    totalWidth += canvasRenderer.measureText(chars[i], textObj.font, newFontSize, direction).width;
                    if (i < chars.length - 1) totalWidth += letterSpacing;
                }
                lineWidth = totalWidth;
            } else {
                lineWidth = canvasRenderer.measureText(line, textObj.font, newFontSize, direction).width;
            }
            maxTextWidth = Math.max(maxTextWidth, lineWidth);
        });
        const lineHeight = newFontSize * (textObj.lineHeight || 1.2);
        const backdropPaddingX = (textObj.backdropWidthPercentage / 100) * maxTextWidth;
        const backdropPaddingY = (textObj.backdropHeightPercentage / 100) * (lineHeight * lines.length);
        const newWidth = maxTextWidth + backdropPaddingX;
        const newHeight = (lineHeight * lines.length) + backdropPaddingY;
        const newX = centerX - newWidth / 2;
        const newY = centerY - newHeight / 2;
        if (scale > 1) {
            if (newX < 0 || newY < 0 || (newX + newWidth) > canvas.width || (newY + newHeight) > canvas.height) {
                return;
            }
        }
        textObj.fontSize = newFontSize;
        textObj.width = newWidth;
        textObj.height = newHeight;
        textObj.x = newX;
        textObj.y = newY;
        const fontSizeSlider = DOM.get('fontSizeSlider');
        if (fontSizeSlider) fontSizeSlider.value = newFontSize;
        uiManager.updateSliderValues();
        performanceMonitor.scheduleDraw();
    }
    return
}


        if(appState.isDraggingText&&appState.selectedTextIndex>=0){
            const canvasPos=this.getCanvasPos(e);
            const textObj=appState.textObjects[appState.selectedTextIndex];
            
            if (textObj.locked) {
                appState.isDraggingText = false;
                return;
            }

            const canvas=DOM.get('canvas');
            const newX=Math.max(0,Math.min(canvasPos.x-appState.dragStart.x,canvas.width-textObj.width));
            const newY=Math.max(0,Math.min(canvasPos.y-appState.dragStart.y,canvas.height-textObj.height));
            textObj.x=newX;
            textObj.y=newY;
            uiManager.showGuideLines(textObj);
            performanceMonitor.scheduleDraw()
        }else if(appState.isDraggingCanvas){
            e.preventDefault();
            const clientX=e.touches?e.touches[0].clientX:e.clientX;
            const clientY=e.touches?e.touches[0].clientY:e.clientY;
            const deltaX=clientX-appState.lastPointer.x;
            const deltaY=clientY-appState.lastPointer.y;
            appState.momentum.x=deltaX*0.8;
            appState.momentum.y=deltaY*0.8;
            const newX=appState.canvasTransform.x+deltaX;
            const newY=appState.canvasTransform.y+deltaY;
            this.updateCanvasTransform(newX,newY,false);
            appState.lastPointer={x:clientX,y:clientY}
        }
    }catch(error){
        memoryManager.logError('HANDLE_MOVE_ERROR',error)
    }
}
handleEnd(e){try{if(e.touches&&e.touches.length>0)return;if(appState.isDraggingCanvas){const canvasWrapper=DOM.get('canvasWrapper');if(canvasWrapper){canvasWrapper.style.cursor='grab'}if(Math.abs(appState.momentum.x)>2||Math.abs(appState.momentum.y)>2){const finalX=appState.canvasTransform.x+appState.momentum.x*0.3;const finalY=appState.canvasTransform.y+appState.momentum.y*0.3;this.updateCanvasTransform(finalX,finalY,true)}}appState.isDraggingText=false;appState.isDraggingCanvas=false;appState.isPinching=false;appState.momentum={x:0,y:0};uiManager.hideGuideLines()}catch(error){memoryManager.logError('HANDLE_END_ERROR',error)}}constrainCanvasPosition(x,y){const bounds=appState.canvasBounds;const constrainedX=Math.max(bounds.left,Math.min(bounds.right,x));const constrainedY=Math.max(bounds.top,Math.min(bounds.bottom,y));return{x:constrainedX,y:constrainedY}}updateCanvasTransform(x,y,smooth=false){try{const canvasWrapper=DOM.get('canvasWrapper');if(!canvasWrapper)return;const constrained=this.constrainCanvasPosition(x,y);appState.canvasTransform.x=constrained.x;appState.canvasTransform.y=constrained.y;if(smooth){canvasWrapper.classList.add('smooth-transition');requestAnimationFrame(()=>{canvasWrapper.style.transform=`translate(${constrained.x}px, ${constrained.y}px)`;setTimeout(()=>{canvasWrapper.classList.remove('smooth-transition')},400)})}else{canvasWrapper.style.transform=`translate(${constrained.x}px, ${constrained.y}px)`}}catch(error){memoryManager.logError('TRANSFORM_ERROR',error)}}centerCanvas(){try{const canvasWrapper=DOM.get('canvasWrapper');if(!canvasWrapper)return;appState.canvasTransform={x:0,y:0};appState.momentum={x:0,y:0};canvasWrapper.classList.add('smooth-transition');canvasWrapper.style.transform='translate(0px, 0px)';setTimeout(()=>{canvasWrapper.classList.remove('smooth-transition')},400);accessibilityManager.announce('Canvas centered')}catch(error){memoryManager.logError('CENTER_CANVAS_ERROR',error)}}handleCanvasClick(e){try{if(appState.isColorPickerActive)return;const canvasPos=this.getCanvasPos(e);let clickedTextIndex=-1;for(let i=appState.textObjects.length-1;i>=0;i--){const textObj=appState.textObjects[i];if(canvasPos.x>=textObj.x&&canvasPos.x<=textObj.x+textObj.width&&canvasPos.y>=textObj.y&&canvasPos.y<=textObj.y+textObj.height){clickedTextIndex=i;break}}if(clickedTextIndex>=0){textManager.selectTextObject(clickedTextIndex);if(!document.querySelector('.accordion-panel.active')){uiManager.openPanel('text')}}}catch(error){memoryManager.logError('CANVAS_CLICK_ERROR',error)}}handleCanvasDoubleClick(e){try{if(appState.isColorPickerActive)return;const canvasPos=this.getCanvasPos(e);let clickedTextIndex=-1;for(let i=appState.textObjects.length-1;i>=0;i--){const textObj=appState.textObjects[i];if(canvasPos.x>=textObj.x&&canvasPos.x<=textObj.x+textObj.width&&canvasPos.y>=textObj.y&&canvasPos.y<=textObj.y+textObj.height){clickedTextIndex=i;break}}if(clickedTextIndex===-1){e.preventDefault();e.stopPropagation();this.centerCanvas()}else{textManager.selectTextObject(clickedTextIndex);const textPanel=document.getElementById('textPanel');if(textPanel&&!textPanel.classList.contains('active')){uiManager.openPanel('text')}}}catch(error){memoryManager.logError('CANVAS_DOUBLE_CLICK_ERROR',error)}}handleCanvasTouchEnd(e){try{if(appState.isColorPickerActive)return;const now=Date.now();if(now-appState.lastCanvasTouchTime<300){appState.canvasTouchCount++;if(appState.canvasTouchCount===2){e.preventDefault();e.stopPropagation();const canvasPos=this.getCanvasPos(e.changedTouches[0]);let clickedTextIndex=-1;for(let i=appState.textObjects.length-1;i>=0;i--){const textObj=appState.textObjects[i];if(canvasPos.x>=textObj.x&&canvasPos.x<=textObj.x+textObj.width&&canvasPos.y>=textObj.y&&canvasPos.y<=textObj.y+textObj.height){clickedTextIndex=i;break}}if(clickedTextIndex===-1){this.centerCanvas()}else{textManager.selectTextObject(clickedTextIndex);const textPanel=document.getElementById('textPanel');if(textPanel&&!textPanel.classList.contains('active')){uiManager.openPanel('text')}}appState.canvasTouchCount=0}}else{appState.canvasTouchCount=1}appState.lastCanvasTouchTime=now}catch(error){memoryManager.logError('CANVAS_TOUCH_ERROR',error)}}handlePlaceholderDoubleTap(e){try{e.preventDefault();e.stopPropagation();const now=Date.now();if(now-appState.lastTapTime<appState.doubleTapDelay){appState.tapCount++;if(appState.tapCount===2){this.showQuickActionModal();appState.tapCount=0;return}}else{appState.tapCount=1}appState.lastTapTime=now}catch(error){memoryManager.logError('PLACEHOLDER_TAP_ERROR',error)}}showQuickActionModal(){accessibilityManager.openModal('quickActionModal')}hideQuickActionModal(){accessibilityManager.closeModal('quickActionModal')}}
class LayerManager {
    constructor() {
        this.layerListContainer = document.getElementById('layerList');
        this.dropIndicator = document.getElementById('layerDropIndicator');
        this.currentDropIndex = null;
    }

    updateLayerPanel() {
        if (!this.layerListContainer) return;

        // Clear existing layers (but keep indicator)
        const layers = this.layerListContainer.querySelectorAll('.layer-item');
        layers.forEach(layer => layer.remove());

        // Add Image Layer if it exists
        if (appState.img) {
            this.createLayerItem({ type: 'image', name: 'Background Image' }, -1);
        }

        // Add Text Layers
        appState.textObjects.forEach((textObj, index) => {
            this.createLayerItem({
                type: 'text',
                name: textObj.text.substring(0, 20) || `Text Layer ${index + 1}`,
                visible: textObj.opacity !== 0,
                locked: textObj.locked
            }, index);
        });
    }

    createLayerItem(layerData, index) {
        const item = document.createElement('div');
        item.className = 'layer-item';
        if (appState.selectedTextIndex === index) {
            item.classList.add('selected');
        }
        item.dataset.index = index;
        item.dataset.type = layerData.type;

        if (layerData.type === 'text') {
            item.setAttribute('draggable', 'true');
        }

        const isLocked = layerData.type === 'text' && layerData.locked;

        let previewContent = '';
        if (layerData.type === 'image') {
            previewContent = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`;
        } else {
            previewContent = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>`;
        }

        const eyeIconVisible = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`;
        const eyeIconHidden = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>`;
        const lockIconUnlocked = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>`;
        const lockIconLocked = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`;

        item.innerHTML = `
            <div class="layer-drag-handle" ${layerData.type === 'image' ? 'style="opacity:0.3;cursor:not-allowed;"' : ''}>
                <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <circle cx="9" cy="5" r="1.5"/><circle cx="9" cy="12" r="1.5"/><circle cx="9" cy="19" r="1.5"/>
                    <circle cx="15" cy="5" r="1.5"/><circle cx="15" cy="12" r="1.5"/><circle cx="15" cy="19" r="1.5"/>
                </svg>
            </div>
            <div class="layer-preview">${previewContent}</div>
            <div class="layer-info">
                <div class="layer-name">${layerData.name}</div>
            </div>
            <div class="layer-actions">
                ${layerData.type === 'text' ? `
                    <button class="layer-action-btn visibility-btn ${layerData.visible ? '' : 'hidden'}" data-action="toggle-visibility" data-index="${index}" aria-label="Toggle visibility">
                        ${layerData.visible ? eyeIconVisible : eyeIconHidden}
                    </button>
                    <button class="layer-action-btn lock-btn ${isLocked ? 'locked' : ''}" data-action="toggle-lock" data-index="${index}" aria-label="Toggle lock">
                        ${isLocked ? lockIconLocked : lockIconUnlocked}
                    </button>
                    <button class="layer-action-btn delete-btn" data-action="delete" data-index="${index}" aria-label="Delete layer">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                    </button>
                ` : ''}
            </div>
        `;

        this.layerListContainer.appendChild(item);

        if (layerData.type === 'text') {
            this.setupLayerDragAndDrop(item, index, isLocked);
            this.setupLayerSelection(item, index);
            this.setupLayerActions(item, index);
        }
    }

    showDropIndicator(targetItem, position) {
        if (!this.dropIndicator) return;
        const targetIndex = parseInt(targetItem.dataset.index);
        let top;

        // --- START: Inverted Logic for column-reverse ---
        // لیست لایه‌ها به صورت column-reverse است (از پایین به بالا)
        // پس منطق ایندکس برعکس حالت عادی است.
        if (position === 'above') {
            // "بالا"ی آیتم (از نظر بصری) یعنی *بعد* از آن در DOM (ایندکس بزرگتر)
            top = (targetItem.offsetTop - (this.dropIndicator.offsetHeight / 2) - 2);
            this.currentDropIndex = targetIndex + 1;
        } else { // 'below'
            // "پایین" آیتم (از نظر بصری) یعنی *قبل* از آن در DOM (ایندکس کوچکتر)
            top = (targetItem.offsetTop + targetItem.offsetHeight - (this.dropIndicator.offsetHeight / 2) - 2);
            this.currentDropIndex = targetIndex;
        }
        // --- END: Inverted Logic ---
        
        // Handle case for dragging below the last item (visually T0)
        if (this.currentDropIndex > appState.textObjects.length) {
             this.currentDropIndex = appState.textObjects.length;
        }
        
        this.dropIndicator.style.top = `${top}px`;
        this.dropIndicator.style.display = 'block';
    }

    getDropPosition(event, item) {
        const rect = item.getBoundingClientRect();
        const y = event.clientY || (event.touches ? event.touches[0].clientY : 0);
        const midY = rect.top + rect.height / 2;
        return (y < midY) ? 'above' : 'below';
    }

    setupLayerDragAndDrop(item, index, isLocked) {
        let draggedFromIndex = null;

        const handleDragStart = (e) => {
            if (isLocked) { e.preventDefault(); return; }
            draggedFromIndex = index;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', index);
            requestAnimationFrame(() => item.classList.add('dragging'));
        };

        const handleDragEnd = () => {
            if (this.dropIndicator) this.dropIndicator.style.display = 'none';
            item.classList.remove('dragging');
            draggedFromIndex = null;
            this.currentDropIndex = null;
        };

        const handleDragOver = (e) => {
            e.preventDefault();
            if (isLocked || draggedFromIndex === null) return;
            // Use elementsFromPoint for more accurate detection in collapse mode
            const elementsUnderPoint = document.elementsFromPoint(e.clientX, e.clientY);
            const targetItem = elementsUnderPoint.find(el => 
                el.classList.contains('layer-item') && 
                el.dataset.type === 'text' && 
                el !== item
            );


            if (targetItem) {
                const position = this.getDropPosition(e, targetItem);
                this.showDropIndicator(targetItem, position);
            }
        };

                const handleDrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (this.dropIndicator) this.dropIndicator.style.display = 'none';

            let fromIndex;
            try {
                fromIndex = parseInt(e.dataTransfer.getData('text/plain'), 10);
            } catch (err) {
                fromIndex = null;
            }

            let toIndex = this.currentDropIndex;

            if (fromIndex === null || toIndex === null || fromIndex === index) {
                draggedFromIndex = null;
                this.currentDropIndex = null;
                return;
            }

            if (fromIndex < toIndex) {
                toIndex--;
            }
            
            if (fromIndex !== toIndex) {
                this.moveLayer(fromIndex, toIndex);
            }
            
            draggedFromIndex = null;
            this.currentDropIndex = null;
        };

        memoryManager.addEventListener(item, 'dragstart', handleDragStart);
        memoryManager.addEventListener(item, 'dragend', handleDragEnd);
        memoryManager.addEventListener(this.layerListContainer, 'dragover', handleDragOver); // روی کل کانتینر
        memoryManager.addEventListener(item, 'drop', handleDrop);

        // --- Touch events ---
        let touchStartY = 0;
        let isDragging = false;
        let touchMoveHandler = null;
        let touchEndHandler = null;

        const touchStartHandler = (e) => {
            if (isLocked) return;
            if (!e.target.closest('.layer-drag-handle') && !e.target.closest('.layer-preview')) { return; }
            
            isDragging = true;
            draggedFromIndex = index;
            touchStartY = e.touches[0].clientY;

            setTimeout(() => {
                if (isDragging) {
                    item.classList.add('dragging');
                    item.style.position = 'relative';
                    item.style.zIndex = '1000';
                }
            }, 150);

            touchMoveHandler = (e) => {
                if (!isDragging) return;
                e.preventDefault();

                const touchY = e.touches[0].clientY;
                const deltaY = touchY - touchStartY;
                item.style.transform = `translateY(${deltaY}px)`;

                const elementsUnderPoint = document.elementsFromPoint(e.touches[0].clientX, e.touches[0].clientY);
                const targetLayer = elementsUnderPoint.find(el => 
                    el.classList.contains('layer-item') && el.dataset.type === 'text' && el !== item
                );
                
                if (targetLayer) {
                    const position = this.getDropPosition(e, targetLayer);
                    this.showDropIndicator(targetLayer, position);
                }
            };

            touchEndHandler = (e) => {
                if (!isDragging) return;
                
                if (this.dropIndicator) this.dropIndicator.style.display = 'none';
                item.classList.remove('dragging');
                item.style.transform = '';
                item.style.position = '';
                item.style.zIndex = '';
                
                if (draggedFromIndex !== null && this.currentDropIndex !== null) {
                    const fromIndex = draggedFromIndex;
                    let toIndex = this.currentDropIndex;

                    // --- START: Re-instated Index Adjustment ---
                    if (fromIndex < toIndex) {
                        toIndex--;
                    }
                    // --- END: Re-instated Index Adjustment ---
                    
                    if (fromIndex !== toIndex) {
                        this.moveLayer(fromIndex, toIndex);
                    }
                }
                
                isDragging = false;
                draggedFromIndex = null;
                this.currentDropIndex = null;
                document.removeEventListener('touchmove', touchMoveHandler);
                document.removeEventListener('touchend', touchEndHandler);
            };

            document.addEventListener('touchmove', touchMoveHandler, { passive: false });
            document.addEventListener('touchend', touchEndHandler);
        };
        
        memoryManager.addEventListener(item, 'touchstart', touchStartHandler);
    }

    setupLayerSelection(item, index) {
        memoryManager.addEventListener(item, 'click', (e) => {
            if (e.target.closest('.layer-action-btn') || e.target.closest('.layer-drag-handle')) { return; }
            textManager.selectTextObject(index);
            this.updateLayerPanel();
        });
    }

    setupLayerActions(item, index) {
        const actionButtons = item.querySelectorAll('[data-action]');
        actionButtons.forEach(btn => {
            memoryManager.addEventListener(btn, 'click', (e) => {
                e.stopPropagation();
                const action = btn.dataset.action;
                const btnIndex = parseInt(btn.dataset.index);
                const textObj = appState.textObjects[btnIndex];
                if (!textObj) return;

                switch(action) {
                    case 'toggle-visibility':
                        undoRedoManager.saveState();
                        if (!textObj.hiddenState && textObj.opacity !== 0) {
                            textObj.hiddenState = {
                                opacity: textObj.opacity, backdropOpacity: textObj.backdropOpacity,
                                shadowBlur: textObj.shadowBlur, strokeWidth: textObj.strokeWidth, 
                                glowBlur: textObj.glowBlur 
                            };
                        }
                        if (textObj.opacity === 0) {
                            if (textObj.hiddenState) {
                                textObj.opacity = textObj.hiddenState.opacity;
                                textObj.backdropOpacity = textObj.hiddenState.backdropOpacity; 
                                textObj.shadowBlur = textObj.hiddenState.shadowBlur;
                                textObj.strokeWidth = textObj.hiddenState.strokeWidth; 
                                textObj.glowBlur = textObj.hiddenState.glowBlur;
                            } else { textObj.opacity = 1; }
                        } else {
                            textObj.opacity = 0; textObj.backdropOpacity = 0;
                            textObj.shadowBlur = 0; textObj.strokeWidth = 0; textObj.glowBlur = 0;
                        }
                        if (appState.selectedTextIndex === btnIndex) {
                            textManager.updateUIFromSelectedText();
                        }
                        performanceMonitor.scheduleDraw();
                        this.updateLayerPanel();
                        accessibilityManager.announce(textObj.opacity === 0 ? 'Layer hidden' : 'Layer visible');
                        break;
                    case 'toggle-lock':
                        textObj.locked = !textObj.locked;
                        this.updateLayerPanel();
                        accessibilityManager.announce(textObj.locked ? 'Layer locked' : 'Layer unlocked');
                        break;
                    case 'delete':
                        this.deleteLayer(btnIndex);
                        break;
                }
            });
        });
    }

    moveLayer(fromIndex, toIndex) {
        if (fromIndex === toIndex) return;
        if (fromIndex < 0 || fromIndex >= appState.textObjects.length) return;
        if (toIndex < 0 || toIndex > appState.textObjects.length) return; // Allow toIndex to be length (end of array)
        if (appState.textObjects[fromIndex]?.locked) {
            accessibilityManager.announce('Cannot move locked layer');
            return;
        }

        undoRedoManager.saveState();

        const [movedTextObj] = appState.textObjects.splice(fromIndex, 1);
        const [movedFontPanel] = appState.fontPanels.splice(fromIndex, 1);

        appState.textObjects.splice(toIndex, 0, movedTextObj);
        appState.fontPanels.splice(toIndex, 0, movedFontPanel);

        // Update selected index
        if (appState.selectedTextIndex === fromIndex) {
            appState.selectedTextIndex = toIndex;
        } else if (appState.selectedTextIndex >= toIndex && appState.selectedTextIndex < fromIndex) {
            appState.selectedTextIndex++;
        } else if (appState.selectedTextIndex <= toIndex && appState.selectedTextIndex > fromIndex) {
            appState.selectedTextIndex--;
        }

        const fontPanelsContainer = document.getElementById('fontPanelsContainer');
        if (fontPanelsContainer) {
            fontPanelsContainer.innerHTML = '';
            appState.fontPanels.forEach(panel => fontPanelsContainer.appendChild(panel));
        }

        performanceMonitor.scheduleDraw(true);
        this.updateLayerPanel();
        accessibilityManager.announce('Layer reordered');
    }
    
    deleteLayer(index) {
        if (index < 0 || index >= appState.textObjects.length) return;
        if (appState.textObjects[index]?.locked) {
            accessibilityManager.announce('Cannot delete locked layer');
            return;
        }
        undoRedoManager.saveState();
        const panelDiv = appState.fontPanels[index];
        if (panelDiv) {
            textManager.removeFontPanel(panelDiv);
        }
        this.updateLayerPanel();
        performanceMonitor.scheduleDraw(true);
    }
}
const layerManager = new LayerManager();

const interactionManager=new InteractionManager();
class ImageManager{constructor(){this.maxFileSize=50*1024*1024;this.supportedTypes=['image/jpeg','image/jpg','image/png','image/webp','image/gif']}validateImageFile(file){if(!file)throw new Error('NO_FILE_PROVIDED');if(!file.type||!this.supportedTypes.includes(file.type))throw new Error('INVALID_FILE_TYPE');if(file.size>this.maxFileSize)throw new Error('FILE_TOO_LARGE');return true}async initializeCropModal(imageFile){try{this.validateImageFile(imageFile);accessibilityManager.openModal('cropModal');cropState.reset();const cropLoading=DOM.get('cropLoading');const cropImage=DOM.get('cropImage');if(cropLoading)cropLoading.style.display='flex';if(cropImage)cropImage.style.display='none';const imageUrl=memoryManager.createBlobUrl(imageFile);if(!imageUrl)throw new Error('BLOB_URL_CREATION_FAILED');cropState.originalImage=new Image();await new Promise((resolve,reject)=>{cropState.originalImage.onload=()=>{try{this.setupCrop();if(cropLoading)cropLoading.style.display='none';if(cropImage)cropImage.style.display='block';resolve()}catch(error){reject(error)}};cropState.originalImage.onerror=()=>{reject(new Error('IMAGE_LOAD_FAILED'))};setTimeout(()=>{reject(new Error('IMAGE_LOAD_TIMEOUT'))},30000);cropState.originalImage.src=imageUrl})}catch(error){memoryManager.logError('CROP_INIT_ERROR',error);let errorMessage=languageManager.translateText('fileError');if(error.message==='INVALID_FILE_TYPE'){errorMessage=appState.currentLang==='fa'?'فرمت فایل نامعتبر است':appState.currentLang==='ar'?'تنسيق الملف غير صالح':'Invalid file format'}else if(error.message==='FILE_TOO_LARGE'){errorMessage=appState.currentLang==='fa'?'حجم فایل خیلی بزرگ است':appState.currentLang==='ar'?'حجم الملف كب��ر جداً':'File size too large'}else if(error.message==='IMAGE_LOAD_TIMEOUT'){errorMessage=appState.currentLang==='fa'?'بارگذاری تصویر طولانی شد':appState.currentLang==='ar'?'استغرق تحميل الصورة وقتاً طويلاً':'Image loading took too long'}showAlert(errorMessage);accessibilityManager.closeModal('cropModal')}}setupCrop(){const cropViewport=DOM.get('cropViewport');if(!cropViewport||!cropState.originalImage)return;const rect=cropViewport.getBoundingClientRect();const viewportWidth=rect.width;const viewportHeight=rect.height;const frameAspectRatio=9/16;let frameWidth,frameHeight;frameHeight=Math.min(viewportHeight*0.85,window.innerHeight*0.65);frameWidth=frameHeight*frameAspectRatio;if(frameWidth>viewportWidth*0.85){frameWidth=viewportWidth*0.85;frameHeight=frameWidth/frameAspectRatio}const frameLeft=(viewportWidth-frameWidth)/2;const frameTop=(viewportHeight-frameHeight)/2;const cropFrame=DOM.get('cropFrame');if(cropFrame){cropFrame.style.left=frameLeft+'px';cropFrame.style.top=frameTop+'px';cropFrame.style.width=frameWidth+'px';cropFrame.style.height=frameHeight+'px'}cropState.bounds={left:frameLeft,top:frameTop,right:frameLeft+frameWidth,bottom:frameTop+frameHeight};const imageAspect=cropState.originalImage.naturalWidth/cropState.originalImage.naturalHeight;const frameAspect=frameWidth/frameHeight;if(imageAspect>frameAspect){cropState.scale=frameHeight/cropState.originalImage.naturalHeight}else{cropState.scale=frameWidth/cropState.originalImage.naturalWidth}cropState.initialScale=cropState.scale;cropState.minScale=cropState.scale;cropState.position={x:0,y:0};this.updateCropImageDisplay()}updateCropImageDisplay(){if(!cropState.originalImage||!DOM.get('cropViewport')||!DOM.get('cropImage'))return;const rect=DOM.get('cropViewport').getBoundingClientRect();const viewportWidth=rect.width;const viewportHeight=rect.height;const displayWidth=cropState.originalImage.naturalWidth*cropState.scale;const displayHeight=cropState.originalImage.naturalHeight*cropState.scale;const imageLeft=(viewportWidth-displayWidth)/2+cropState.position.x;const imageTop=(viewportHeight-displayHeight)/2+cropState.position.y;const cropImage=DOM.get('cropImage');cropImage.src=cropState.originalImage.src;cropImage.style.width=displayWidth+'px';cropImage.style.height=displayHeight+'px';cropImage.style.left=imageLeft+'px';cropImage.style.top=imageTop+'px';const zoomInfo=DOM.get('zoomInfo');if(zoomInfo){const zoomPercentage=Math.round((cropState.scale/cropState.initialScale)*100);zoomInfo.textContent=zoomPercentage+'%'}}constrainCropPosition(){if(!cropState.originalImage)return;const rect=DOM.get('cropViewport').getBoundingClientRect();const displayWidth=cropState.originalImage.naturalWidth*cropState.scale;const displayHeight=cropState.originalImage.naturalHeight*cropState.scale;const frameWidth=cropState.bounds.right-cropState.bounds.left;const frameHeight=cropState.bounds.bottom-cropState.bounds.top;const maxOffsetX=Math.max(0,(displayWidth-frameWidth)/2);const maxOffsetY=Math.max(0,(displayHeight-frameHeight)/2);cropState.position.x=Math.max(-maxOffsetX,Math.min(maxOffsetX,cropState.position.x));cropState.position.y=Math.max(-maxOffsetY,Math.min(maxOffsetY,cropState.position.y))}async applyCrop(){try{if(!cropState.originalImage||!DOM.get('cropViewport'))return;const rect=DOM.get('cropViewport').getBoundingClientRect();const viewportWidth=rect.width;const viewportHeight=rect.height;const displayWidth=cropState.originalImage.naturalWidth*cropState.scale;const displayHeight=cropState.originalImage.naturalHeight*cropState.scale;const imageLeft=(viewportWidth-displayWidth)/2+cropState.position.x;const imageTop=(viewportHeight-displayHeight)/2+cropState.position.y;const frameLeft=cropState.bounds.left;const frameTop=cropState.bounds.top;const frameWidth=cropState.bounds.right-cropState.bounds.left;const frameHeight=cropState.bounds.bottom-cropState.bounds.top;const sourceX=Math.max(0,(frameLeft-imageLeft)/cropState.scale);const sourceY=Math.max(0,(frameTop-imageTop)/cropState.scale);const sourceWidth=Math.min(cropState.originalImage.naturalWidth-sourceX,frameWidth/cropState.scale);const sourceHeight=Math.min(cropState.originalImage.naturalHeight-sourceY,frameHeight/cropState.scale);const finalCanvas=document.createElement('canvas');const finalCtx=finalCanvas.getContext('2d');if(!finalCtx)throw new Error('CANVAS_CONTEXT_ERROR');const minResolution=2048;const scale=Math.max(1,minResolution/Math.max(frameWidth,frameHeight));finalCanvas.width=Math.round(frameWidth*scale);finalCanvas.height=Math.round(frameHeight*scale);const pixels=finalCanvas.width*finalCanvas.height;if(pixels>16777216)throw new Error('MEMORY_ERROR');finalCtx.imageSmoothingEnabled=true;finalCtx.imageSmoothingQuality='high';finalCtx.drawImage(cropState.originalImage,sourceX,sourceY,sourceWidth,sourceHeight,0,0,finalCanvas.width,finalCanvas.height);const blob=await new Promise((resolve,reject)=>{finalCanvas.toBlob((blob)=>{if(blob){resolve(blob)}else{reject(new Error('BLOB_GENERATION_FAILED'))}}, 'image/png')});const url=memoryManager.createBlobUrl(blob);if(!url)throw new Error('BLOB_URL_CREATION_FAILED');await this.loadImageToCanvas(url, cropState.currentAspectRatio);
accessibilityManager.closeModal('cropModal');layerManager.updateLayerPanel();showAlert(languageManager.translateText('saveSuccess'))}catch(error){memoryManager.logError('CROP_APPLY_ERROR',error);showAlert(errorBoundary.translateError(error?.message||'CROP_ERROR'))}}    // In class ImageManager -> REPLACE the entire function with this code:
    async loadImageToCanvas(imageUrl, aspectRatio = 9 / 16) {
        try {
            if (appState.img) {
                appState.img = null;
            }
            appState.img = new Image();
            appState.img.crossOrigin = 'anonymous';
            await new Promise((resolve, reject) => {
                appState.img.onload = () => {
                    try {
                        const canvas = DOM.get('canvas');
                        if (!canvas) throw new Error('CANVAS_NOT_FOUND');

                        const baseWidth = 1080;
                        canvas.width = baseWidth;
                        canvas.height = Math.round(baseWidth / aspectRatio);

                        this.showDeleteButton();
                        interactionManager.centerCanvas();
                        appState.resetImageState();
                        performanceMonitor.scheduleDraw(true);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                appState.img.onerror = () => reject(new Error('IMAGE_LOAD_FAILED'));
                setTimeout(() => reject(new Error('IMAGE_LOAD_TIMEOUT')), 15000);
                appState.img.src = imageUrl;
            });
        } catch (error) {
            memoryManager.logError('LOAD_IMAGE_ERROR', error);
            throw error;
        }
    }
showDeleteButton(){const deleteBtn=DOM.get('deleteImageBtn');if(deleteBtn){deleteBtn.style.display='flex'}}hideDeleteButton(){const deleteBtn=DOM.get('deleteImageBtn');if(deleteBtn){deleteBtn.style.display='none'}}deleteCurrentImage(){try{appState.img=null;appState.originalImageData=null;this.hideDeleteButton();performanceMonitor.scheduleDraw(true);layerManager.updateLayerPanel();
showAlert(appState.currentLang==='fa'?'تصویر حذف شد':appState.currentLang==='ar'?'تم حذف الصورة':'Image deleted')}catch(error){memoryManager.logError('DELETE_IMAGE_ERROR',error)}}}
const imageManager=new ImageManager();
class CropManager{constructor(){this.setupCropEventListeners()}setupCropEventListeners(){this.setupZoomControls();this.setupCropInteraction();this.setupCropButtons()}setupZoomControls(){const zoomSlider=DOM.get('zoomSlider');if(zoomSlider){memoryManager.addEventListener(zoomSlider,'input',(e)=>{const zoomPercentage=parseFloat(e.target.value);this.setZoomFromPercentage(zoomPercentage)});memoryManager.addEventListener(zoomSlider,'change',(e)=>{const zoomPercentage=parseFloat(e.target.value);this.setZoomFromPercentage(zoomPercentage)})}}setupCropInteraction(){const cropViewport=DOM.get('cropViewport');if(!cropViewport)return;memoryManager.addEventListener(cropViewport,'mousedown',(e)=>{this.handleCropStart(e)});memoryManager.addEventListener(cropViewport,'touchstart',(e)=>{this.handleCropStart(e)},{passive:false});memoryManager.addEventListener(window,'mousemove',(e)=>{this.handleCropMove(e)});memoryManager.addEventListener(window,'touchmove',(e)=>{this.handleCropMove(e)},{passive:false});memoryManager.addEventListener(window,'mouseup',()=>{this.handleCropEnd()});memoryManager.addEventListener(window,'touchend',()=>{this.handleCropEnd()});memoryManager.addEventListener(window,'touchcancel',()=>{this.handleCropEnd()})}

setupCropButtons() {
    const cropCancel = DOM.get('cropCancel');
    const cropConfirm = DOM.get('cropConfirm');
    const cropAspectStory = document.getElementById('cropAspectStory');
    const cropAspectSquare = document.getElementById('cropAspectSquare');
    const cropAspectPortrait = document.getElementById('cropAspectPortrait');
    const aspectButtons = [cropAspectStory, cropAspectSquare, cropAspectPortrait];

    if (cropCancel) {
        memoryManager.addEventListener(cropCancel, 'click', () => accessibilityManager.closeModal('cropModal'));
    }
    if (cropConfirm) {
        memoryManager.addEventListener(cropConfirm, 'click', () => imageManager.applyCrop());
    }

    const handleAspectClick = (selectedBtn, aspectRatio) => {
        try {
            cropState.currentAspectRatio = aspectRatio;
            this.setCropAspectRatio(aspectRatio);
            aspectButtons.forEach(btn => btn && btn.classList.remove('active'));
            if (selectedBtn) selectedBtn.classList.add('active');
        } catch (error) {
            memoryManager.logError('ASPECT_CLICK_ERROR', error);
        }
    };

    if (cropAspectStory) memoryManager.addEventListener(cropAspectStory, 'click', () => handleAspectClick(cropAspectStory, 9 / 16));
    if (cropAspectSquare) memoryManager.addEventListener(cropAspectSquare, 'click', () => handleAspectClick(cropAspectSquare, 1 / 1));
    if (cropAspectPortrait) memoryManager.addEventListener(cropAspectPortrait, 'click', () => handleAspectClick(cropAspectPortrait, 4 / 5));
}

setCropAspectRatio(aspectRatio) {
    const cropViewport = DOM.get('cropViewport');
    const cropFrame = DOM.get('cropFrame');
    if (!cropViewport || !cropFrame || !cropState.originalImage) return;

    try {
        const rect = cropViewport.getBoundingClientRect();
        const viewportWidth = rect.width;
        const viewportHeight = rect.height;

        // محاسبه ابعاد frame بر اساس نسبت ابعاد انتخاب شده
        const maxFrameWidth = viewportWidth * 0.85;
        const maxFrameHeight = viewportHeight * 0.85;
        
        let frameWidth, frameHeight;

        // محاسبه ابعاد frame بر اساس نسب�� ابعاد
        if (aspectRatio >= 1) {
            // برای نسب��‌های مربع یا افقی
            frameHeight = Math.min(maxFrameHeight, maxFrameWidth / aspectRatio);
            frameWidth = frameHeight * aspectRatio;
        } else {
            // برای ن��بت‌های عمودی
            frameWidth = Math.min(maxFrameWidth, maxFrameHeight * aspectRatio);
            frameHeight = frameWidth / aspectRatio;
        }

        const frameLeft = (viewportWidth - frameWidth) / 2;
        const frameTop = (viewportHeight - frameHeight) / 2;

        // تنظیم ابعاد و موقعیت frame
        cropFrame.style.width = `${frameWidth}px`;
        cropFrame.style.height = `${frameHeight}px`;
        cropFrame.style.left = `${frameLeft}px`;
        cropFrame.style.top = `${frameTop}px`;
        
        // بروزرسانی bounds
        cropState.bounds = { 
            left: frameLeft, 
            top: frameTop, 
            right: frameLeft + frameWidth, 
            bottom: frameTop + frameHeight 
        };

        // محاسبه scale مناسب برای پوشش کامل frame
        const imageAspect = cropState.originalImage.naturalWidth / cropState.originalImage.naturalHeight;
        
        // انتخاب scale که تمام frame را پوشش دهد
        const scaleX = frameWidth / cropState.originalImage.naturalWidth;
        const scaleY = frameHeight / cropState.originalImage.naturalHeight;
        cropState.scale = Math.max(scaleX, scaleY);

        cropState.initialScale = cropState.scale;
        cropState.minScale = cropState.scale;
        cropState.maxScale = cropState.scale * 3;
        
        // تنظیم مجدد position
        cropState.position = { x: 0, y: 0 };

        // اعمال محدودیت position و بروزرسانی نمایش
        imageManager.constrainCropPosition();
        imageManager.updateCropImageDisplay();

    } catch (error) {
        memoryManager.logError('SET_CROP_ASPECT_RATIO_ERROR', error);
    }
}

setZoomFromPercentage(percentage){if(!cropState.originalImage)return;const targetScale=cropState.initialScale*(percentage/100);const newScale=Math.max(cropState.minScale,Math.min(cropState.maxScale,targetScale));const scaleFactor=newScale/cropState.scale;cropState.position.x*=scaleFactor;cropState.position.y*=scaleFactor;cropState.scale=newScale;imageManager.constrainCropPosition();imageManager.updateCropImageDisplay()}updateZoomSlider(){const zoomSlider=DOM.get('zoomSlider');if(zoomSlider&&cropState.initialScale>0){const currentPercentage=Math.round((cropState.scale/cropState.initialScale)*100);zoomSlider.value=currentPercentage}}adjustZoom(factor){if(!cropState.originalImage)return;const newScale=Math.max(cropState.minScale,Math.min(cropState.maxScale,cropState.scale*factor));const scaleFactor=newScale/cropState.scale;cropState.position.x*=scaleFactor;cropState.position.y*=scaleFactor;cropState.scale=newScale;imageManager.constrainCropPosition();imageManager.updateCropImageDisplay();this.updateZoomSlider()}handleCropStart(e){if(e.touches&&e.touches.length===2){e.preventDefault();cropState.isPinching=true;const t1=e.touches[0];const t2=e.touches[1];cropState.initialPinchDistance=Math.hypot(t1.clientX-t2.clientX,t1.clientY-t2.clientY);cropState.lastScale=cropState.scale;return}cropState.isDragging=true;const clientX=e.touches?e.touches[0].clientX:e.clientX;const clientY=e.touches?e.touches[0].clientY:e.clientY;cropState.lastTouchPos={x:clientX,y:clientY};const cropViewport=DOM.get('cropViewport');if(cropViewport){cropViewport.classList.add('dragging')}e.preventDefault()}handleCropMove(e){if(e.touches&&e.touches.length===2&&cropState.isPinching){e.preventDefault();const t1=e.touches[0];const t2=e.touches[1];const currentDist=Math.hypot(t1.clientX-t2.clientX,t1.clientY-t2.clientY);const scaleFactor=currentDist/cropState.initialPinchDistance;const newScale=Math.max(cropState.minScale,Math.min(cropState.maxScale,cropState.lastScale*scaleFactor));cropState.scale=newScale;imageManager.constrainCropPosition();imageManager.updateCropImageDisplay();this.updateZoomSlider();return}if(!cropState.isDragging)return;e.preventDefault();const clientX=e.touches?e.touches[0].clientX:e.clientX;const clientY=e.touches?e.touches[0].clientY:e.clientY;const deltaX=clientX-cropState.lastTouchPos.x;const deltaY=clientY-cropState.lastTouchPos.y;cropState.position.x+=deltaX;cropState.position.y+=deltaY;imageManager.constrainCropPosition();imageManager.updateCropImageDisplay();cropState.lastTouchPos={x:clientX,y:clientY}}handleCropEnd(){cropState.isDragging=false;cropState.isPinching=false;const cropViewport=DOM.get('cropViewport');if(cropViewport){cropViewport.classList.remove('dragging')}}}
const cropManager=new CropManager();
class DownloadManager{constructor(){this.jpegQuality=0.9;this.vipJpegQuality=1.0;this.setupDownloadEventListeners()}setupDownloadEventListeners(){const downloadHeaderBtn=DOM.get('downloadHeaderBtn');const closeDownloadModal=DOM.get('closeDownloadModal');const downloadCards=['saveToGalleryCard','downloadTransparentCard','saveVipQualityCard'];if(downloadHeaderBtn){memoryManager.addEventListener(downloadHeaderBtn,'click',(e)=>{e.preventDefault();this.openDownloadModal()})}if(closeDownloadModal){memoryManager.addEventListener(closeDownloadModal,'click',()=>{accessibilityManager.closeModal('downloadModal')})}downloadCards.forEach(cardId=>{const card=DOM.get(cardId);if(card){memoryManager.addEventListener(card,'click',(e)=>{e.preventDefault();e.stopPropagation();const action=card.dataset.action;this.handleDownloadAction(action)});memoryManager.addEventListener(card,'keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();const action=card.dataset.action;this.handleDownloadAction(action)}})}})}openDownloadModal(){try{
    const hamburgerPanel = document.getElementById('hamburgerPanel');
    const hamburgerOverlay = document.getElementById('hamburgerOverlay');
    if (hamburgerPanel && hamburgerOverlay) {
        hamburgerPanel.classList.remove('active');
        hamburgerOverlay.classList.remove('active');
        const hamburgerMenuBtn = document.getElementById('hamburgerMenuBtn');
        if (hamburgerMenuBtn) {
            hamburgerMenuBtn.setAttribute('aria-expanded', 'false');
        }
    }

    if(!this.hasContent()){showAlert(languageManager.translateText('alertImage'));return}
    this.updateDownloadModalContent();
    accessibilityManager.openModal('downloadModal')
}catch(error){memoryManager.logError('DOWNLOAD_MODAL_ERROR',error)}}
updateDownloadModalContent(){try{const saveToGalleryTitle=DOM.get('saveToGalleryTitle');if(saveToGalleryTitle){const hasText=appState.textObjects.some(t=>t.text.trim());if(hasText){saveToGalleryTitle.textContent=appState.currentLang==='fa'?'استوری کامل JPEG':appState.currentLang==='ar'?'قصة كاملة JPEG':'Complete Story JPEG'}else{saveToGalleryTitle.textContent=appState.currentLang==='fa'?'عکس کیفیت خ��ب':appState.currentLang==='ar'?'صورة جودة جيدة':'Good Quality JPEG'}}}catch(error){memoryManager.logError('DOWNLOAD_MODAL_UPDATE_ERROR',error)}}hasContent(){return appState.img||appState.textObjects.some(t=>t.text.trim())}async handleDownloadAction(action){try{if(!this.hasContent()){showAlert(languageManager.translateText('alertImage'));return}switch(action){case'save-gallery':await this.saveStandardQuality();break;case'save-vip-quality':await this.saveVipQuality();break;case'download-transparent':await this.downloadTransparent();break;default:memoryManager.logError('UNKNOWN_ACTION',new Error(`Unknown action: ${action}`));break}accessibilityManager.closeModal('downloadModal')}catch(error){memoryManager.logError('DOWNLOAD_ACTION_ERROR',error);showAlert(errorBoundary.translateError(error?.message||'DOWNLOAD_ERROR'))}}async saveStandardQuality(){try{const dimensions=canvasRenderer.getExportDimensions('standard');const canvas=await this.createExportCanvas('jpeg',dimensions);const blob=await new Promise((resolve,reject)=>{canvas.toBlob((blob)=>{if(blob){resolve(blob)}else{reject(new Error('BLOB_GENERATION_FAILED'))}}, 'image/jpeg',this.jpegQuality)});await this.saveToDevice(blob,'DACO_Story.jpg');showAlert(languageManager.translateText('saveSuccess'))}catch(error){memoryManager.logError('STANDARD_QUALITY_ERROR',error);throw error}}async saveVipQuality(){try{const dimensions=canvasRenderer.getExportDimensions('vip');const canvas=await this.createExportCanvas('jpeg',dimensions);const blob=await new Promise((resolve,reject)=>{canvas.toBlob((blob)=>{if(blob){resolve(blob)}else{reject(new Error('BLOB_GENERATION_FAILED'))}}, 'image/jpeg',this.vipJpegQuality)});await this.saveToDevice(blob,'DACO_VIP_4K.jpg');showAlert(languageManager.translateText('saveVipSuccess'))}catch(error){memoryManager.logError('VIP_QUALITY_ERROR',error);throw error}}async downloadTransparent(){try{const hasText=appState.textObjects.some(t=>t.text.trim());if(!hasText){const message=appState.currentLang==='fa'?'ابتدا متن را وارد کنید':appState.currentLang==='ar'?'أدخل النص أولاً':'Please enter text first';showAlert(message);return}const dimensions=canvasRenderer.getExportDimensions('vip');const tempCanvas=document.createElement('canvas');const tempCtx=tempCanvas.getContext('2d',{alpha:true});tempCanvas.width=dimensions.width;tempCanvas.height=dimensions.height;canvasRenderer.drawTextObjectsToExportCanvas(tempCtx,dimensions.width,dimensions.height);const blob=await new Promise((resolve,reject)=>{tempCanvas.toBlob((blob)=>{if(blob){resolve(blob)}else{reject(new Error('BLOB_GENERATION_FAILED'))}}, 'image/png',1.0)});await this.saveToDevice(blob,'DACO_Text_Transparent.png')}catch(error){memoryManager.logError('TRANSPARENT_DOWNLOAD_ERROR',error);throw error}}async createExportCanvas(format,targetSize){try{const exportCanvas=document.createElement('canvas');const exportCtx=exportCanvas.getContext('2d');if(!exportCtx)throw new Error('CANVAS_CONTEXT_ERROR');exportCanvas.width=targetSize.width;exportCanvas.height=targetSize.height;const pixels=exportCanvas.width*exportCanvas.height;if(pixels>67108864)throw new Error('MEMORY_ERROR');exportCtx.imageSmoothingEnabled=true;exportCtx.imageSmoothingQuality='high';exportCtx.fillStyle="#FFFFFF";exportCtx.fillRect(0,0,exportCanvas.width,exportCanvas.height);if(appState.img){const img=appState.img;const imgRatio=img.naturalWidth/img.naturalHeight;const canvasRatio=exportCanvas.width/exportCanvas.height;let sx,sy,sw,sh;if(imgRatio>canvasRatio){sh=img.naturalHeight;sw=sh*canvasRatio;sx=(img.naturalWidth-sw)/2;sy=0}else{sw=img.naturalWidth;sh=sw/canvasRatio;sx=0;sy=(img.naturalHeight-sh)/2}exportCtx.drawImage(img,sx,sy,sw,sh,0,0,exportCanvas.width,exportCanvas.height)}canvasRenderer.drawTextObjectsToExportCanvas(exportCtx,exportCanvas.width,exportCanvas.height);return exportCanvas}catch(error){memoryManager.logError('EXPORT_CANVAS_ERROR',error);throw error}}async saveToDevice(blob,filename){try{if(navigator.share&&navigator.canShare&&navigator.canShare({files:[new File([blob],filename)]})){await navigator.share({files:[new File([blob],filename)],title:'DACO  ',text:'Created with DACO   Pro'});return}if('clipboard' in navigator&&'write' in navigator.clipboard){try{const clipboardItem=new ClipboardItem({[blob.type]:blob});await navigator.clipboard.write([clipboardItem]);showAlert(languageManager.translateText('copySuccess'));return}catch(clipboardError){}}await this.downloadFile(blob,filename)}catch(error){memoryManager.logError('SAVE_TO_DEVICE_ERROR',error);throw error}}async downloadFile(blob,filename){try{const url=memoryManager.createBlobUrl(blob);if(!url)throw new Error('BLOB_URL_CREATION_FAILED');const link=document.createElement('a');link.href=url;link.download=filename;link.style.display='none';document.body.appendChild(link);link.click();document.body.removeChild(link);setTimeout(()=>{memoryManager.revokeBlobUrl(url)},1000)}catch(error){memoryManager.logError('DOWNLOAD_FILE_ERROR',error);throw error}}}
const downloadManager=new DownloadManager();
function initializeEventListeners(){try{const themeToggle=DOM.get('themeToggle');const langSwitch=DOM.get('langSwitch');const imageInput=DOM.get('imageInput');const uploadImageBtn=DOM.get('uploadImageBtn');const deleteImageBtn=DOM.get('deleteImageBtn');const photoPlaceholder=DOM.get('photoPlaceholder');const quickAddImage=DOM.get('quickAddImage');const quickAddText=DOM.get('quickAddText');const fontInput=DOM.get('fontInput');const fontSelector=DOM.get('fontSelector');const addFontPanelBtn=DOM.get('addFontPanelBtn');const textColorGrid=DOM.get('textColorGrid');const bgColorGrid=DOM.get('bgColorGrid');const controlIcons=DOM.get('controlIcons');const accordionPanels=DOM.get('accordionPanels');const closePanelBtns=DOM.get('closePanelBtns');const sliders=['fontSizeSlider','opacitySlider','shadowSlider','strokeSlider','glowSlider','backdropOpacitySlider','backdropRadiusSlider','backdropWidthSlider','backdropHeightSlider','letterSpacingSlider','lineHeightSlider'];

// Setup Undo/Redo buttons
const undoBtn=document.getElementById('undoBtn');
const redoBtn=document.getElementById('redoBtn');
if(undoBtn){memoryManager.addEventListener(undoBtn,'click',()=>{undoRedoManager.undo()});}
if(redoBtn){memoryManager.addEventListener(redoBtn,'click',()=>{undoRedoManager.redo()});}

// Setup Text Alignment buttons
const alignLeftBtn=document.getElementById('alignLeftBtn');
const alignCenterBtn=document.getElementById('alignCenterBtn');
const alignRightBtn=document.getElementById('alignRightBtn');
const alignBtns=[alignLeftBtn,alignCenterBtn,alignRightBtn];

alignBtns.forEach(btn=>{if(btn){memoryManager.addEventListener(btn,'click',()=>{const align=btn.dataset.align;if(appState.selectedTextIndex>=0&&appState.textObjects[appState.selectedTextIndex]){undoRedoManager.saveState();appState.textObjects[appState.selectedTextIndex].textAlign=align;alignBtns.forEach(b=>b&&b.classList.remove('active'));btn.classList.add('active');performanceMonitor.scheduleDraw()}})}});

// Setup Text Direction buttons
const dirLTRBtn=document.getElementById('dirLTRBtn');
const dirRTLBtn=document.getElementById('dirRTLBtn');
const dirBtns=[dirLTRBtn,dirRTLBtn];

dirBtns.forEach(btn=>{if(btn){memoryManager.addEventListener(btn,'click',()=>{const dir=btn.dataset.dir;if(appState.selectedTextIndex>=0&&appState.textObjects[appState.selectedTextIndex]){undoRedoManager.saveState();appState.textObjects[appState.selectedTextIndex].textDirection=dir;dirBtns.forEach(b=>b&&b.classList.remove('active'));btn.classList.add('active');performanceMonitor.scheduleDraw()}})}});

// --- START: Corrected Hamburger Menu Button Listeners ---

// Target the correct switch ID for the theme toggle
const themeToggleSwitch = document.getElementById('themeToggleSwitch');
if (themeToggleSwitch) {
    memoryManager.addEventListener(themeToggleSwitch, 'click', () => {
        document.body.classList.toggle('night-mode');
        themeToggleSwitch.classList.toggle('active');
    });
}
const langSwitchMenu = document.getElementById('langSwitchMenu');
if (langSwitchMenu) {
    memoryManager.addEventListener(langSwitchMenu, 'click', () => {
        const nextLang = languageManager.getNextLanguage();
        languageManager.switchLanguage(nextLang);
        // Update the button text after language change
        const langTextElement = document.getElementById('currentLangText');
        if(langTextElement) {
            langTextElement.textContent = langTextElement.getAttribute(`data-${nextLang}`);
        }
    });
}
const undoRedoToggle = document.getElementById('undoRedoToggle');
const undoRedoBar = document.getElementById('undoRedoBar');
if (undoRedoToggle && undoRedoBar) {
    const isInitiallyActive = undoRedoToggle.classList.contains('active');
    undoRedoBar.style.display = isInitiallyActive ? 'flex' : 'none';
    memoryManager.addEventListener(undoRedoToggle, 'click', () => {
        undoRedoToggle.classList.toggle('active');
        const isActive = undoRedoToggle.classList.contains('active');
        undoRedoBar.style.display = isActive ? 'flex' : 'none';
    });
}

if(imageInput){memoryManager.addEventListener(imageInput,'change',async(e)=>{if(e.target.files&&e.target.files[0]){try{await imageManager.initializeCropModal(e.target.files[0])}catch(error){memoryManager.logError('IMAGE_INPUT_ERROR',error)}e.target.value=''}})}if(uploadImageBtn){memoryManager.addEventListener(uploadImageBtn,'click',()=>{imageInput.click()})}if(deleteImageBtn){memoryManager.addEventListener(deleteImageBtn,'click',()=>{imageManager.deleteCurrentImage()})}if(photoPlaceholder){memoryManager.addEventListener(photoPlaceholder,'click',()=>{imageInput.click()})}if(quickAddImage){memoryManager.addEventListener(quickAddImage,'click',()=>{interactionManager.hideQuickActionModal();imageInput.click()})}if(quickAddText){memoryManager.addEventListener(quickAddText,'click',()=>{interactionManager.hideQuickActionModal();textManager.addFontPanel();uiManager.openPanel('text');setTimeout(()=>{const panels=appState.fontPanels;if(panels.length>0){const lastPanel=panels[panels.length-1];const textInput=lastPanel.querySelector('.font-text-input');if(textInput){textInput.focus();textInput.select()}}},100)})}if(fontInput){memoryManager.addEventListener(fontInput,'change',async(e)=>{if(e.target.files&&e.target.files[0]){const file=e.target.files[0];const fileName=file.name.replace(/\.[^/.]+$/,"");try{await fontManager.loadCustomFont(file,fileName)}catch(error){memoryManager.logError('FONT_INPUT_ERROR',error)}e.target.value=''}})}if(fontSelector){memoryManager.addEventListener(fontSelector,'change',(e)=>{appState.currentFont=e.target.value;if(appState.selectedTextIndex>=0&&appState.textObjects[appState.selectedTextIndex]){undoRedoManager.saveState();appState.textObjects[appState.selectedTextIndex].font=e.target.value;performanceMonitor.scheduleDraw()}})}if(addFontPanelBtn){memoryManager.addEventListener(addFontPanelBtn,'click',()=>{textManager.addFontPanel();uiManager.openPanel('text');setTimeout(()=>{const panels=appState.fontPanels;if(panels.length>0){const lastPanel=panels[panels.length-1];const textInput=lastPanel.querySelector('.font-text-input');if(textInput){textInput.focus();textInput.select()}}},100)})}if(textColorGrid){uiManager.createColorGrid(textColorGrid,(color)=>{if(appState.selectedTextIndex>=0&&appState.textObjects[appState.selectedTextIndex]){undoRedoManager.saveState();appState.textObjects[appState.selectedTextIndex].color=color;const colorPreview=DOM.get('colorPickerPreview');if(colorPreview){colorPreview.style.backgroundColor=color}performanceMonitor.scheduleDraw()}})}if(bgColorGrid){uiManager.createColorGrid(bgColorGrid,(color)=>{if(appState.selectedTextIndex>=0&&appState.textObjects[appState.selectedTextIndex]){undoRedoManager.saveState();appState.textObjects[appState.selectedTextIndex].backdropColor=color;performanceMonitor.scheduleDraw()}})}if(controlIcons){controlIcons.forEach(controlIcon=>{memoryManager.addEventListener(controlIcon,'click',()=>{const panel=controlIcon.dataset.panel;if(panel){const currentPanel=document.getElementById(panel+'Panel');if(currentPanel&&currentPanel.classList.contains('active')){uiManager.closePanel(panel)}else{uiManager.openPanel(panel)}}})})}if(closePanelBtns){closePanelBtns.forEach(btn=>{memoryManager.addEventListener(btn,'click',()=>{const panel=btn.dataset.close;if(panel){uiManager.closePanel(panel)}})})}sliders.forEach(sliderId => {
    const slider = DOM.get(sliderId);
    if (slider) {
        let isSliding = false;
        memoryManager.addEventListener(slider, 'mousedown', () => {
            if (!isSliding && appState.selectedTextIndex >= 0) {
                undoRedoManager.saveState();
                isSliding = true
            }
        });
        memoryManager.addEventListener(slider, 'touchstart', () => {
            if (!isSliding && appState.selectedTextIndex >= 0) {
                undoRedoManager.saveState();
                isSliding = true
            }
        });
        memoryManager.addEventListener(slider, 'mouseup', () => {
            isSliding = false
        });
        memoryManager.addEventListener(slider, 'touchend', () => {
            isSliding = false
        });
        memoryManager.addEventListener(slider, 'input', (e) => {
            if (appState.selectedTextIndex >= 0 && appState.textObjects[appState.selectedTextIndex]) {
                const textObj = appState.textObjects[appState.selectedTextIndex];
                const value = parseFloat(e.target.value);
                switch (sliderId) {
                    case 'fontSizeSlider':
                        textObj.fontSize = value;
                        break;
                    case 'opacitySlider':
                        textObj.opacity = value / 100;
                        break;
                    case 'shadowSlider':
                        textObj.shadowBlur = value;
                        break;
                    case 'strokeSlider':
                        textObj.strokeWidth = value;
                        const shadowSlider = DOM.get('shadowSlider');
                        if (shadowSlider) {
                            const isDisabled = value <= 0;
                            shadowSlider.disabled = isDisabled;
                            const sliderGroup = shadowSlider.closest('.slider-group');
                            if (sliderGroup) {
                                sliderGroup.style.opacity = isDisabled ? '0.5' : '1';
                                sliderGroup.style.pointerEvents = isDisabled ? 'none' : 'auto';
                            }
                            if (isDisabled) {
                                textObj.shadowBlur = 0;
                                shadowSlider.value = 0;
                            }
                        }
                        break;
                    case 'glowSlider':
                        textObj.glowBlur = value;
                        break;
                    case 'backdropOpacitySlider':
                        textObj.backdropOpacity = value / 100;
                        break;
                    case 'backdropRadiusSlider':
                        textObj.backdropRadius = value;
                        break;
                    case 'backdropWidthSlider':
                        textObj.backdropWidthPercentage = value;
                        break;
                    case 'backdropHeightSlider':
                        textObj.backdropHeightPercentage = value;
                        break;
                    case 'letterSpacingSlider':
                        textObj.letterSpacing = value;
                        break;
                    case 'lineHeightSlider':
                        textObj.lineHeight = value;
                        break
                }
                uiManager.updateSliderValues();
                performanceMonitor.scheduleDraw()
            }
        })
    }
});
const pwaInstallClose=DOM.get('pwaInstallClose');if(pwaInstallClose){memoryManager.addEventListener(pwaInstallClose,'click',()=>{pwaInstallManager.hidePrompt()})}}catch(error){memoryManager.logError('EVENT_LISTENERS_ERROR',error)}}
function toggleTheme(){try{const isDark=document.body.classList.toggle('night-mode');const sunIcon=document.querySelector('.sun-icon');const moonIcon=document.querySelector('.moon-icon');if(sunIcon&&moonIcon){if(isDark){sunIcon.style.display='none';moonIcon.style.display='block'}else{sunIcon.style.display='block';moonIcon.style.display='none'}}}catch(error){memoryManager.logError('THEME_TOGGLE_ERROR',error)}}
function loadSavedTheme(){try{const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;if(prefersDark){document.body.classList.add('night-mode');const sunIcon=document.querySelector('.sun-icon');const moonIcon=document.querySelector('.moon-icon');if(sunIcon&&moonIcon){sunIcon.style.display='none';moonIcon.style.display='block'}}}catch(error){}}
function handleOrientationChange(){try{const isLandscape=window.innerHeight<window.innerWidth;const orientationOverlay=DOM.get('orientationLockOverlay');const mainContainer=document.querySelector('.main-app-container');if(orientationOverlay&&mainContainer){if(isLandscape){orientationOverlay.style.display='flex';mainContainer.style.display='none'}else{orientationOverlay.style.display='none';mainContainer.style.display='flex';setTimeout(()=>{canvasRenderer.updateCanvasWrapperSize();canvasRenderer.updateCanvasBounds();performanceMonitor.scheduleDraw()},300)}}}catch(error){memoryManager.logError('ORIENTATION_ERROR',error)}}
window.addEventListener('load',async()=>{try{DOM.get('dacoLoadingScreen').style.display='flex';loadSavedTheme();window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',event=>{if(event.matches){document.body.classList.add('night-mode')}else{document.body.classList.remove('night-mode')}});languageManager.switchLanguage('en');await fontManager.preloadFonts();initializeEventListeners()// Hamburger Menu Logic
const hamburgerMenuBtn = document.getElementById('hamburgerMenuBtn');
const hamburgerPanel = document.getElementById('hamburgerPanel');
const hamburgerOverlay = document.getElementById('hamburgerOverlay');

if (hamburgerMenuBtn && hamburgerPanel && hamburgerOverlay) {
    const toggleMenu = () => {
        hamburgerPanel.classList.toggle('active');
        hamburgerOverlay.classList.toggle('active');
        const isExpanded = hamburgerPanel.classList.contains('active');
        hamburgerMenuBtn.setAttribute('aria-expanded', isExpanded.toString());
    };
// --- START: Professional Login Modal Logic ---
const loginBtn = document.getElementById('loginBtn');
const loginModal = document.getElementById('loginModal');

if (loginBtn && loginModal) {
    const loginModalClose = document.getElementById('loginModalClose');
    const loginModalOverlay = document.getElementById('loginModalOverlay');
    const loginTabs = loginModal.querySelectorAll('.login-tab');
    const formContainers = loginModal.querySelectorAll('.login-form-container');
    const hamburgerPanel = document.getElementById('hamburgerPanel');
    const hamburgerOverlay = document.getElementById('hamburgerOverlay');

    const openLoginModal = () => {
        // Close hamburger menu immediately when opening login modal
        if (hamburgerPanel && hamburgerOverlay) {
            hamburgerPanel.classList.remove('active');
            hamburgerOverlay.classList.remove('active');
        }
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
        // Open modal with smooth animation
        requestAnimationFrame(() => {
            loginModal.classList.add('active');
            loginModal.setAttribute('aria-hidden', 'false');
        });
    };
    const closeLoginModal = () => {
        loginModal.classList.remove('active');
        loginModal.setAttribute('aria-hidden', 'true');
        // Restore body scroll
        document.body.style.overflow = '';
    };

    memoryManager.addEventListener(loginBtn, 'click', openLoginModal);
    memoryManager.addEventListener(loginModalClose, 'click', closeLoginModal);
    memoryManager.addEventListener(loginModalOverlay, 'click', closeLoginModal);

    // Tab switching logic
    loginTabs.forEach(tab => {
        memoryManager.addEventListener(tab, 'click', () => {
            const targetTab = tab.dataset.tab;

            loginTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            formContainers.forEach(container => {
                if (container.id.toLowerCase().includes(targetTab)) {
                    container.classList.add('active');
                } else {
                    container.classList.remove('active');
                }
            });
        });
    });
}
// --- END: Professional Login Modal Logic ---


    // Use the existing memoryManager to add listeners
    memoryManager.addEventListener(hamburgerMenuBtn, 'click', toggleMenu);
    memoryManager.addEventListener(hamburgerOverlay, 'click', toggleMenu);

// Layer Panel Toggle from Hamburger Menu
const layersPanelToggle = document.getElementById('layersPanelToggleSwitch');
if (layersPanelToggle) {
    memoryManager.addEventListener(layersPanelToggle, 'click', () => {
            // Close hamburger menu
            hamburgerPanel.classList.remove('active');
            hamburgerOverlay.classList.remove('active');
            // Toggle layers panel
            const layersPanel = document.getElementById('layersPanel');
            if (layersPanel && layersPanel.classList.contains('active')) {
                uiManager.closePanel('layers');
            } else {
                uiManager.openPanel('layers');
            }
        });
    }

    // Layer Panel Collapse Toggle
    const layerCollapseBtn = document.getElementById('layerCollapseBtn');
    const layersPanel = document.getElementById('layersPanel');
    if (layerCollapseBtn && layersPanel) {
        memoryManager.addEventListener(layerCollapseBtn, 'click', (e) => {
            e.stopPropagation();
            // Toggle between collapsed and expanded (not logo-only)
            if(layersPanel.classList.contains('logo-only')){
                layersPanel.classList.remove('logo-only');
                layersPanel.classList.add('collapsed');
                accessibilityManager.announce('Panel collapsed');
            }else{
                layersPanel.classList.toggle('collapsed');
                accessibilityManager.announce(layersPanel.classList.contains('collapsed') ? 'Panel collapsed' : 'Panel expanded');
            }
        });
    }

    // Logo-only mode click to expand
    if (layersPanel) {
        memoryManager.addEventListener(layersPanel, 'click', (e) => {
            if(layersPanel.classList.contains('logo-only') && e.target === layersPanel){
                e.stopPropagation();

                const activePanel = document.querySelector('.accordion-panel.active');
                if (activePanel) {
                    const panelId = activePanel.id.replace('Panel', '');
                    uiManager.closePanel(panelId);
                }
layersPanel.classList.remove('logo-only');
                layersPanel.classList.add('active');
                layersPanel.classList.add('collapsed');const layersPanelToggle = document.getElementById('layersPanelToggleSwitch');
                if (layersPanelToggle) {
                    layersPanelToggle.classList.add('active');
                }
                
                accessibilityManager.announce('Layer panel collapsed');
            }
        });
    }


    // Layer Panel Overlay Click to Close
    const layerPanelOverlay = document.getElementById('layerPanelOverlay');
    if (layerPanelOverlay) {
        memoryManager.addEventListener(layerPanelOverlay, 'click', () => {
            uiManager.closePanel('layers');
        });
    }
}
memoryManager.addEventListener(window,'resize',()=>{handleOrientationChange();canvasRenderer.updateCanvasWrapperSize();canvasRenderer.updateCanvasBounds()});
memoryManager.addEventListener(window,'orientationchange',()=>{setTimeout(()=>{handleOrientationChange();canvasRenderer.updateCanvasWrapperSize();canvasRenderer.updateCanvasBounds()},300)});
handleOrientationChange();await ServiceWorkerManager.register();
canvasRenderer.drawCanvas();const dacoLoadingScreen=DOM.get('dacoLoadingScreen');setTimeout(()=>{if(dacoLoadingScreen){dacoLoadingScreen.classList.add('hidden');setTimeout(()=>{dacoLoadingScreen.style.display='none'},800)}},2000);setTimeout(()=>{pwaInstallManager.showPromptIfNeeded()},3000)}catch(error){memoryManager.logError('INITIALIZATION_ERROR',error)}});
</script>
</body>
</html>
